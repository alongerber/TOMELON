<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Operations Premium | מערכת ניהול אניות</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230066FF' stroke-width='2'><path d='M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'/><path d='M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76'/><path d='M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6'/></svg>" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        /* ======================== DESIGN TOKENS ======================== */
        :root {
            /* Premium Colors */
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --primary-light: #3385FF;
            --primary-glow: rgba(0, 102, 255, 0.3);
            
            --success: #00D084;
            --success-dark: #00A866;
            --success-glow: rgba(0, 208, 132, 0.3);
            
            --warning: #FFB800;
            --warning-dark: #E6A600;
            --warning-glow: rgba(255, 184, 0, 0.3);
            
            --danger: #FF3366;
            --danger-dark: #E6004C;
            --danger-glow: rgba(255, 51, 102, 0.3);
            
            /* Dark Theme */
            --bg-primary: #0A0B0D;
            --bg-secondary: #12141A;
            --bg-tertiary: #1A1D24;
            --bg-card: #1F232B;
            --bg-hover: rgba(255, 255, 255, 0.03);
            --bg-active: rgba(255, 255, 255, 0.06);
            
            /* Glass */
            --glass: rgba(255, 255, 255, 0.02);
            --glass-heavy: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            /* Text */
            --text-primary: #FFFFFF;
            --text-secondary: #B4B9C4;
            --text-tertiary: #7A8091;
            --text-muted: #4A4F5C;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #F5F7FA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E8ECF0;
            --bg-card: #FFFFFF;
            --bg-hover: rgba(0, 0, 0, 0.03);
            --bg-active: rgba(0, 0, 0, 0.06);

            --glass: rgba(0, 0, 0, 0.02);
            --glass-heavy: rgba(0, 0, 0, 0.04);
            --glass-border: rgba(0, 0, 0, 0.12);

            --text-primary: #1A1D24;
            --text-secondary: #4A5568;
            --text-tertiary: #718096;
            --text-muted: #A0AEC0;

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ======================== BACKGROUND ======================== */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, var(--primary-glow) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--success-glow) 0%, transparent 50%);
            opacity: 0.1;
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background-image: 
                linear-gradient(var(--glass-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.15;
        }

        /* ======================== LAYOUT ======================== */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm);
        }

        .logo-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 4px 20px rgba(79, 70, 229, 0.3));
            transition: all 0.3s ease;
        }

        .logo-image:hover {
            filter: drop-shadow(0 6px 25px rgba(79, 70, 229, 0.5));
            transform: scale(1.02);
        }

        /* Navigation */
        .nav-menu {
            flex: 1;
            padding: var(--spacing-md);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 200ms;
            margin-bottom: var(--spacing-xs);
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-active);
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header */
        .header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--spacing-md) var(--spacing-xl);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 200ms;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-dark);
            box-shadow: 0 6px 20px var(--danger-glow);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            position: relative;
            overflow: hidden;
            transition: all 300ms;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: var(--primary);
            opacity: 0.05;
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: var(--spacing-sm);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: var(--spacing-sm);
            padding: 4px 8px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .stat-trend.up { color: var(--success); }
        .stat-trend.down { color: var(--danger); }

        /* Content Area */
        .content {
            flex: 1;
            padding: var(--spacing-xl);
            overflow-y: auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-card);
            padding: var(--spacing-xs);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .tab {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            position: relative;
        }

        .tab:hover {
            color: var(--text-secondary);
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .tab-badge {
            display: inline-block;
            min-width: 20px;
            padding: 2px 6px;
            margin-right: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .tab.active .tab-badge {
            background: var(--primary);
            color: white;
        }

        /* Ships Grid */
        .ships-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: var(--spacing-lg);
        }

        /* ======================== HYBRID TABLE VIEW ======================== */
        .ships-table-view {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }
        .ships-table {
            width: 100%;
            border-collapse: collapse;
        }
        .ships-table th {
            text-align: right;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--glass-border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .ships-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 14px;
            color: var(--text-primary);
            vertical-align: middle;
        }
        .ships-table tr.ship-row {
            cursor: pointer;
            transition: all 200ms;
        }
        .ships-table tr.ship-row:hover {
            background: var(--bg-hover);
        }
        .ships-table tr.ship-row.urgent {
            border-right: 4px solid var(--danger);
        }
        .ships-table tr.ship-row.warning {
            border-right: 4px solid var(--warning);
        }
        .ships-table tr.ship-row.success {
            border-right: 4px solid var(--success);
        }

        /* Table Ship Name Cell */
        .table-ship-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .table-expand-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }
        .table-expand-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .table-expand-btn.expanded {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: rotate(90deg);
        }
        .table-ship-info {
            display: flex;
            flex-direction: column;
        }
        .table-ship-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        .table-ship-voyage {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Table Status Badge */
        .table-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Table ETA Cell */
        .table-eta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .table-eta-date {
            font-weight: 500;
        }
        .table-eta-days {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .table-eta-days.urgent {
            color: var(--danger);
            font-weight: 600;
        }
        .table-eta-days.warning {
            color: var(--warning);
        }

        /* Table Tasks Cell */
        .table-tasks {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-tasks-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
            max-width: 80px;
        }
        .table-tasks-progress {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
            transition: width 300ms;
        }
        .table-tasks-text {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Table Urgency Badge */
        .table-urgency {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .table-urgency.urgent { background: var(--danger); }
        .table-urgency.warning { background: var(--warning); }
        .table-urgency.normal { background: var(--success); }

        /* Expanded Row */
        .ship-expanded-row {
            display: none;
        }
        .ship-expanded-row.active {
            display: table-row;
        }
        .ship-expanded-content {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 2px solid var(--glass-border);
        }
        .expanded-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .expanded-section {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--glass-border);
        }
        .expanded-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .expanded-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--glass-border);
        }
        .expanded-item:last-child {
            border-bottom: none;
        }
        .expanded-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .expanded-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .expanded-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        .expanded-actions button {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 200ms;
        }
        .expanded-actions button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .expanded-actions button.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Expanded Images Section */
        .expanded-images-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--glass-border);
        }
        .expanded-images-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .expanded-images-upload {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 200ms;
        }
        .expanded-images-upload:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .expanded-images-grid {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .expanded-image-item {
            flex-shrink: 0;
            width: 100px;
            height: 75px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 200ms;
        }
        .expanded-image-item:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .expanded-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .expanded-images-empty {
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: center;
            padding: 16px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
        }
        .expanded-images-more {
            flex-shrink: 0;
            width: 100px;
            height: 75px;
            border-radius: var(--radius-sm);
            background: var(--bg-hover);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 200ms;
            border: 1px dashed var(--glass-border);
        }
        .expanded-images-more:hover {
            border-color: var(--primary);
            background: var(--primary-glow);
        }
        .expanded-images-more span {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ======================== REPORTS SECTION ======================== */
        .reports-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--glass-border);
        }
        .reports-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .reports-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .reports-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .report-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 200ms;
        }
        .report-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-glow);
        }
        .report-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .report-btn.primary:hover {
            background: var(--primary-dark);
        }

        /* Report Modal */
        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .report-modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }
        .report-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        .report-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .report-modal-actions {
            display: flex;
            gap: 8px;
        }
        .report-modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }
        .report-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .report-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .report-preview {
            background: white;
            color: #000;
            padding: 40px;
            border-radius: var(--radius-md);
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            direction: ltr;
        }
        .report-preview.rtl {
            direction: rtl;
            font-family: 'David', 'Heebo', serif;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        .report-header h1 {
            font-size: 24px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
        }
        .report-header h2 {
            font-size: 18px;
            margin: 0;
            font-weight: normal;
        }
        .report-section-title {
            font-size: 14px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            text-transform: uppercase;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 8px 12px;
            text-align: left;
        }
        .report-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .report-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dotted #ccc;
        }
        .report-row-label {
            font-weight: bold;
        }
        .report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        .report-signature {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
        }
        .report-signature-box {
            text-align: center;
            width: 200px;
        }
        .report-signature-line {
            border-top: 1px solid #333;
            margin-top: 50px;
            padding-top: 5px;
        }

        @media print {
            .report-modal-header,
            .report-modal-actions {
                display: none !important;
            }
            .report-modal {
                max-width: 100%;
                max-height: 100%;
                box-shadow: none;
            }
            .report-preview {
                padding: 0;
            }
        }

        /* ======================== CARGO BREAKDOWN SECTION ======================== */
        .cargo-breakdown-section {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }
        .cargo-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .cargo-breakdown-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cargo-parse-area {
            background: var(--bg-secondary);
            border: 1px dashed var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 12px;
        }
        .cargo-parse-area textarea {
            width: 100%;
            height: 60px;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 8px;
            font-size: 12px;
            resize: none;
            margin-bottom: 8px;
        }
        .cargo-parse-area textarea::placeholder {
            color: var(--text-tertiary);
        }
        .cargo-parse-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cargo-parse-btn:hover {
            background: var(--primary-hover);
        }
        .cargo-table-container {
            max-height: 200px;
            overflow-y: auto;
        }
        .cargo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .cargo-table th {
            background: var(--bg-secondary);
            padding: 8px;
            text-align: right;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
        }
        .cargo-table td {
            padding: 8px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
        }
        .cargo-table tr:hover {
            background: var(--bg-hover);
        }
        .cargo-table input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 12px;
        }
        .cargo-table input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .cargo-type-select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 12px;
        }
        .cargo-delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        .cargo-delete-btn:hover {
            background: var(--danger-glow);
        }
        .cargo-add-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            color: var(--primary);
            cursor: pointer;
            font-size: 12px;
        }
        .cargo-add-row:hover {
            background: var(--primary-glow);
            border-radius: var(--radius-sm);
        }
        .cargo-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--glass-border);
        }
        .cargo-totals {
            display: flex;
            gap: 24px;
        }
        .cargo-total-item {
            text-align: center;
        }
        .cargo-total-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        .cargo-total-label {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .cargo-percentages {
            display: flex;
            gap: 4px;
            height: 24px;
            flex: 1;
            max-width: 300px;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        .cargo-percent-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: 500;
            min-width: 30px;
        }
        .cargo-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-tertiary);
            font-size: 12px;
        }
        .cargo-save-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .cargo-save-btn:hover {
            filter: brightness(1.1);
        }
        .cargo-autocomplete-wrapper {
            position: relative;
            width: 100%;
        }
        .cargo-autocomplete-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 12px;
        }
        .cargo-autocomplete-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .cargo-autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .cargo-autocomplete-list.active {
            display: block;
        }
        .cargo-autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid var(--glass-border);
        }
        .cargo-autocomplete-item:last-child {
            border-bottom: none;
        }
        .cargo-autocomplete-item:hover,
        .cargo-autocomplete-item.highlighted {
            background: var(--primary-glow);
            color: var(--primary);
        }
        .cargo-autocomplete-item .cargo-match {
            font-weight: 600;
            color: var(--primary);
        }

        /* ======================== EXPANDED TASKS ======================== */
        .expanded-tasks-section {
            max-height: 200px;
            overflow-y: auto;
        }
        .expanded-task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 150ms;
            margin-bottom: 4px;
        }
        .expanded-task-item:hover {
            background: var(--bg-hover);
        }
        .task-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            flex-shrink: 0;
            transition: all 150ms;
        }
        .task-checkbox.done {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .task-checkbox.in-progress {
            background: var(--warning);
            border-color: var(--warning);
            color: var(--bg-primary);
        }
        .task-label {
            font-size: 12px;
            color: var(--text-primary);
        }
        .task-label.done {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .expanded-task-more {
            font-size: 11px;
            color: var(--primary);
            padding: 6px 8px;
            cursor: pointer;
            text-align: center;
        }
        .expanded-task-more:hover {
            text-decoration: underline;
        }

        /* ======================== SMART AI SEARCH ======================== */
        .smart-ai-search {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 1500;
            display: none;
        }
        .smart-ai-search.active {
            display: block;
            animation: slideUp 300ms ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .ai-search-container {
            background: var(--bg-card);
            border: 1px solid var(--primary);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(79, 70, 229, 0.2);
            overflow: hidden;
        }
        .ai-search-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--primary-glow), transparent);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-search-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
        }
        .ai-search-close {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-search-input-container {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
        }
        .ai-search-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
        }
        .ai-search-input::placeholder {
            color: var(--text-tertiary);
        }
        .ai-search-submit {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }
        .ai-search-submit:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        .ai-search-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .ai-search-results {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid var(--glass-border);
        }
        .ai-search-result {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
        }
        .ai-search-result:last-child {
            border-bottom: none;
        }
        .ai-search-answer {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        .ai-search-answer strong {
            color: var(--primary);
        }
        .ai-search-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        .ai-search-loading .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }
        .ai-search-examples {
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .ai-search-examples span {
            cursor: pointer;
            padding: 4px 8px;
            background: var(--bg-hover);
            border-radius: 12px;
            margin: 0 4px;
            transition: all 200ms;
        }
        .ai-search-examples span:hover {
            background: var(--primary);
            color: white;
        }

        /* AI Search Toggle Button */
        .ai-search-toggle {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border: none;
            border-radius: var(--radius-full);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 40px rgba(79, 70, 229, 0.4);
            transition: all 200ms;
            z-index: 1400;
        }
        .ai-search-toggle:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 15px 50px rgba(79, 70, 229, 0.5);
        }

        /* Ship Card */
        .ship-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all 300ms;
            position: relative;
        }

        .ship-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 200ms;
        }

        .ship-card.urgent::before {
            opacity: 1;
            background: var(--danger);
        }

        .ship-card.warning::before {
            opacity: 1;
            background: var(--warning);
        }

        .ship-card.success::before {
            opacity: 1;
            background: var(--success);
        }

        .ship-card:hover {
            transform: translateX(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .ship-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
        }

        .ship-title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }

        .ship-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ship-voyage {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .ship-status {
            padding: 4px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .status-at-sea {
            color: #60A5FA;
            background: rgba(96, 165, 250, 0.1);
        }

        .status-at-port {
            color: #FBBF24;
            background: rgba(251, 191, 36, 0.1);
        }

        .status-under-operation {
            color: #34D399;
            background: rgba(52, 211, 153, 0.1);
        }

        .status-sailed {
            color: var(--text-tertiary);
            background: var(--bg-secondary);
        }

        .ship-body {
            padding: var(--spacing-lg);
        }

        /* Progress Bar */
        .progress-container {
            margin-top: var(--spacing-lg);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 12px;
        }

        .progress-label {
            color: var(--text-tertiary);
        }

        .progress-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-full);
            transition: width 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .quick-action {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 200ms;
        }

        .quick-action:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        /* Activity Feed - Hidden by default */
        .activity-feed {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--glass-border);
            transform: translateX(100%);
            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
        }

        .activity-feed.active {
            transform: translateX(0);
        }

        .activity-header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 600;
        }

        .activity-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 200ms;
        }

        .activity-close:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        .activity-content {
            padding: var(--spacing-lg);
        }

        .activity-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-body {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-tertiary);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
            opacity: 0.3;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .empty-text {
            margin-bottom: var(--spacing-xl);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 300ms;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlide 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 200ms;
        }

        .modal-close:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* ======================== EMAIL PARSER MODULE ======================== */
        .email-parser-view {
            display: none;
            flex-direction: column;
            gap: var(--spacing-lg);
            padding: var(--spacing-xl);
            height: 100%;
            overflow-y: auto;
        }

        .email-parser-view.active {
            display: flex;
        }

        .parser-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
            flex: 1;
            min-height: 0;
        }

        .parser-input-section,
        .parser-output-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--glass-border);
        }

        .parser-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .parser-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .parser-section-title svg {
            color: var(--primary);
        }

        .email-textarea {
            flex: 1;
            min-height: 300px;
            padding: var(--spacing-md);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            direction: ltr;
            text-align: left;
        }

        .email-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .email-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .parse-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .parse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--primary-glow);
        }

        .parse-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .parsed-result {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .parsed-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            gap: var(--spacing-md);
        }

        .parsed-empty svg {
            opacity: 0.3;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .confidence-high {
            background: var(--success-glow);
            color: var(--success);
        }

        .confidence-medium {
            background: var(--warning-glow);
            color: var(--warning);
        }

        .confidence-low {
            background: var(--danger-glow);
            color: var(--danger);
        }

        .parsed-field {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }

        .parsed-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .parsed-field-label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .parsed-field-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .parsed-field-apply {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
            transition: all 200ms;
        }

        .parsed-field-apply:hover {
            background: var(--primary-dark);
        }

        .parsed-field-apply.applied {
            background: var(--success);
        }

        .parsed-services {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .parsed-service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
        }

        .parsed-service-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .parsed-service-type {
            font-weight: 500;
            color: var(--text-primary);
        }

        .parsed-service-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .uncertainty-note {
            padding: var(--spacing-md);
            background: var(--warning-glow);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            color: var(--warning);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }

        .apply-all-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .apply-all-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--success-glow);
        }

        .apply-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ship-selector {
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .ship-selector label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .ship-selector select {
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
        }

        .new-ship-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--primary-glow);
            color: var(--primary);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .parser-container {
                grid-template-columns: 1fr;
            }
        }

        /* ======================== CONTACTS & EMAIL MANAGEMENT ======================== */
        .contacts-view {
            display: none;
            flex-direction: column;
            gap: var(--spacing-lg);
            padding: var(--spacing-xl);
            height: 100%;
            overflow-y: auto;
        }

        .contacts-view.active {
            display: flex;
        }

        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .contacts-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .contacts-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
        }

        @media (max-width: 1200px) {
            .contacts-grid {
                grid-template-columns: 1fr;
            }
        }

        .contacts-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--glass-border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 400px;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            transition: all 200ms;
        }

        .contact-item:hover {
            border-color: var(--primary);
            background: var(--bg-tertiary);
        }

        .contact-item.selected {
            border-color: var(--primary);
            background: var(--primary-glow);
        }

        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .contact-email {
            font-size: 12px;
            color: var(--text-secondary);
            direction: ltr;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .contact-type {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            margin-right: var(--spacing-sm);
        }

        .contact-type.agent { background: var(--primary-glow); color: var(--primary); }
        .contact-type.port { background: var(--success-glow); color: var(--success); }
        .contact-type.owner { background: var(--warning-glow); color: var(--warning); }
        .contact-type.charterer { background: #9333ea20; color: #9333ea; }
        .contact-type.receiver { background: #ec489920; color: #ec4899; }

        .contact-actions {
            display: flex;
            gap: var(--spacing-xs);
            opacity: 0;
            transition: opacity 200ms;
        }

        .contact-item:hover .contact-actions {
            opacity: 1;
        }

        .contact-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }

        .contact-btn:hover {
            background: var(--primary);
            color: white;
        }

        .contact-btn.delete:hover {
            background: var(--danger);
        }

        .group-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 200ms;
        }

        .group-item:hover {
            border-color: var(--primary);
            background: var(--bg-tertiary);
        }

        .group-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .group-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .group-count {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .group-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        /* Email Composer */
        .email-composer {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .composer-recipients {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            min-height: 44px;
            align-items: center;
        }

        .recipient-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 4px 8px;
            background: var(--primary-glow);
            color: var(--primary);
            border-radius: var(--radius-full);
            font-size: 12px;
        }

        .recipient-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .recipient-tag .remove:hover {
            opacity: 1;
        }

        .recipient-tag.group {
            background: var(--success-glow);
            color: var(--success);
        }

        .add-recipient-btn {
            padding: 4px 12px;
            background: transparent;
            border: 1px dashed var(--glass-border);
            border-radius: var(--radius-full);
            color: var(--text-tertiary);
            font-size: 12px;
            cursor: pointer;
            transition: all 200ms;
        }

        .add-recipient-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .email-preview {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
        }

        .open-outlook-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            background: #0078d4;
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all 200ms;
        }

        .open-outlook-btn:hover {
            background: #106ebe;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 120, 212, 0.3);
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 200px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 200ms;
        }

        .checkbox-item:hover {
            background: var(--bg-tertiary);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-tertiary);
        }

        .empty-state svg {
            opacity: 0.3;
            margin-bottom: var(--spacing-md);
        }

        /* Form Styles */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: var(--spacing-sm);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 200ms;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: var(--spacing-sm);
        }

        /* Checklist Styles */
        .checklist-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }

        .checklist-section h4 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            font-size: 16px;
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 200ms;
        }

        .checklist-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .checklist-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .checklist-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }

        .checklist-item input[type="checkbox"]:checked + .checklist-text {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .task-due {
            font-size: 12px;
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-left: auto;
        }

        .task-due.urgent {
            background: var(--danger);
            color: white;
        }

        .task-due.warning {
            background: var(--warning);
            color: white;
        }

        .task-item.urgent {
            border-left: 3px solid var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .task-item.warning {
            border-left: 3px solid var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .task-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .task-due {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .task-due.urgent {
            background: var(--danger);
            color: white;
        }

        .task-due.warning {
            background: var(--warning);
            color: white;
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .task-checkbox {
            margin-right: var(--spacing-xs);
            cursor: pointer;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: var(--bg-tertiary);
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-name {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .task-item.completed .task-due {
            background: var(--success);
            color: white;
        }







        /* Full width layout for main content */
        .main-content {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        /* Ensure full width display */
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        .main-content {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        #shipsGrid {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .checklist-item.warning {
            border-left: 3px solid var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .task-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .task-indicator.urgent {
            background: var(--danger);
        }

        .task-indicator.warning {
            background: var(--warning);
        }

        /* Archive Styles */
        .ship-card.archived {
            opacity: 0.7;
            background: var(--bg-secondary);
            border-color: var(--text-tertiary);
        }

        .ship-card.archived .ship-name {
            color: var(--text-tertiary);
        }

        /* File Status Indicator */
        .file-status {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-status-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .file-status svg {
            color: var(--primary);
        }

        .file-status span {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-md);
            min-width: 300px;
            animation: toastSlide 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast.success {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--bg-card), rgba(0, 208, 132, 0.1));
        }

        .toast.error {
            border-color: var(--danger);
            background: linear-gradient(135deg, var(--bg-card), rgba(255, 51, 102, 0.1));
        }

        .toast.warning {
            border-color: var(--warning);
            background: linear-gradient(135deg, var(--bg-card), rgba(255, 184, 0, 0.1));
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .ships-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                right: -260px;
                z-index: 100;
            }
            
            .sidebar.active {
                right: 0;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* --- Quick View Redesign --- */
        .quick-view-container {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .quick-view-header {
            display: flex;
            align-items: center;
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            flex-direction: row-reverse; /* תיקון: הופך את סדר העמודות */
        }

        .ship-name-header {
            flex: 0 0 250px;
            padding-left: var(--spacing-md);
            text-align: left;
        }

        .tasks-header {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }

        .tasks-header span {
            padding: 0 var(--spacing-sm);
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .ship-row {
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s ease;
        }

        .ship-row:last-child {
            border-bottom: none;
        }

        .ship-row:hover {
            background-color: var(--bg-hover);
        }

        .ship-main-info {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) 0;
            cursor: pointer;
            flex-direction: row-reverse; /* תיקון: הופך את סדר העמודות */
        }

        .ship-name-quick-view {
            flex: 0 0 250px;
            padding-left: var(--spacing-md);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
        }

        .task-dots-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            justify-items: center;
        }

        .task-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .task-dot:hover {
            transform: scale(1.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* --- צבעי הסטטוסים --- */
        .task-dot.pending {
            background-color: var(--danger);
            box-shadow: 0 0 10px var(--danger-glow);
        }
        .task-dot.in-progress {
            background-color: var(--warning);
            box-shadow: 0 0 10px var(--warning-glow);
        }
        .task-dot.done {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success-glow);
        }

        /* --- אזור ההרחבה --- */
        .expandable-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s ease;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            padding: 0 var(--spacing-lg);
            text-align: left; /* יישור הפרטים לשמאל */
        }

        .ship-row.expanded .expandable-details {
            max-height: 200px;
            padding: var(--spacing-lg);
            border-top: 1px solid var(--glass-border);
        }

        /* --- Ship Card Redesign --- */
        .ship-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 13px;
            background: var(--bg-secondary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .info-item .info-icon {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            color: var(--text-tertiary);
        }

        .info-item div {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .info-item .info-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .info-item .info-value {
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quick-actions .quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* --- Animated Image Logo --- */
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-md) 0;
        }

        .animated-logo {
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 0 8px var(--primary-glow));
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            animation: elegantFloat 6s infinite ease-in-out, glowPulse 4s infinite ease-in-out;
        }

        .animated-logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 20px var(--primary));
        }

        /* Sailing Animation */
        @keyframes elegantFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* Glow Pulse Animation */
        @keyframes glowPulse {
            0%, 100% {
                filter: drop-shadow(0 0 8px var(--primary-glow));
            }
            50% {
                filter: drop-shadow(0 0 16px var(--primary));
            }
        }

        .trader-toggle {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-md);
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: var(--radius-md);
        }
        .trader-toggle .toggle-btn {
            flex: 1;
            padding: var(--spacing-sm) 0;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 14px;
            font-weight: 700;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .trader-toggle .toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .trader-toggle .toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px var(--primary-glow);
        }

        /* --- Sidebar Statistics Redesign --- */
        .sidebar-section {
            padding: 0 var(--spacing-md) var(--spacing-md);
            border-top: 1px solid var(--glass-border);
            margin-top: var(--spacing-md);
        }

        .sidebar-title {
            color: var(--text-tertiary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: var(--spacing-lg) 0 var(--spacing-md);
        }

        /* Redesign stats grid for a vertical layout inside the sidebar */
        .stats-grid {
            grid-template-columns: 1fr; /* Force a single column */
            gap: var(--spacing-md);
            margin-bottom: 0;
        }

        /* Make individual stat cards more compact */
        .stat-card {
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card:hover {
            transform: translateX(2px); /* Subtle hover effect for sidebar */
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 0;
        }

        .stat-label {
            font-size: 13px;
            text-align: left;
        }

        /* Hide the trend indicators in the compact sidebar view */
        .stat-trend {
            display: none;
        }

        /* --- Ship Card Readability & Hierarchy Improvements --- */

        /* Make data values larger and bolder */
        .info-item .info-value {
            font-size: 15px;
            font-weight: 700; /* Bolder */
        }

        /* Make data labels smaller and less prominent */
        .info-item .info-label {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Adjust trader toggle for its new location */
        .quick-actions .trader-toggle {
            margin-top: 0;
            flex: 1.5; /* Give it slightly more space than other buttons */
            padding: 2px;
        }
        .quick-actions .trader-toggle .toggle-btn {
            padding: var(--spacing-sm) 0;
        }

        /* --- Subtle Status Coloring for Ship Cards --- */

        /* Green tint for "Under Operation" */
        .ship-card.card-status-under-operation {
            background-color: rgba(0, 208, 132, 0.1); /* Gentle green background */
            border-color: var(--success-dark);
        }

        /* Red tint for "At Port" */
        .ship-card.card-status-at-port {
            background-color: rgba(255, 51, 102, 0.08); /* Gentle red background */
            border-color: var(--danger-dark);
        }

        /* Blue tint for "At Sea" */
        .ship-card.card-status-at-sea {
            background-color: rgba(0, 102, 255, 0.1); /* Gentle blue background */
            border-color: var(--primary-dark);
        }

        /* "Sailed" ships will not have a special rule, 
           so they will keep the default dark background as requested. */

        /* --- Service Indicators on Ship Card --- */
        .service-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .indicator-item {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .indicator-item.water {
            background: linear-gradient(45deg, var(--primary-dark), var(--primary));
            box-shadow: 0 2px 8px var(--primary-glow);
        }

        .indicator-item.package {
            background: linear-gradient(45deg, var(--warning-dark), var(--warning));
            box-shadow: 0 2px 8px var(--warning-glow);
        }

        /* --- Quick View Enhancements --- */
        .quick-view-title {
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--glass-border);
        }

        .quick-view-table {
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .ship-details-header {
            flex: 0 0 250px;
            padding-left: var(--spacing-md);
            text-align: right;
        }

        .ship-details-quick-view {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: var(--spacing-xs);
            padding-right: var(--spacing-md);
        }

        .ship-name-quick-view {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ship-meta-quick-view {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .quick-view-port {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .tasks-header.sailed-tasks {
            grid-template-columns: repeat(2, 1fr);
        }

        .task-dots-container.sailed-tasks {
            grid-template-columns: repeat(2, 1fr);
        }

        /* --- Compact Quick View --- */
        .ship-main-info-compact {
            display: flex;
            align-items: center;
            padding: 8px 0;
            flex-direction: row-reverse; /* תיקון: הופך את סדר העמודות */
        }

        .ship-details-compact {
            width: 250px;
            max-width: 250px;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding-left: var(--spacing-md);
            text-align: right;
        }

        .ship-name-quick-view {
            width: 120px;
            max-width: 120px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: right;
        }

        .ship-status-compact {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        .ship-details-compact .quick-view-port {
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .task-dots-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            justify-items: center;
        }

        /* --- Smart Search Bar --- */
        .search-bar-container {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .search-icon {
            position: absolute;
            top: 50%;
            right: var(--spacing-md);
            transform: translateY(-50%);
            color: var(--text-tertiary);
            z-index: 1;
        }

        .smart-search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-2xl) var(--spacing-md) var(--spacing-md);
            padding-right: 50px; /* Space for the icon */
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            outline: none;
        }

        .smart-search-input::placeholder {
            color: var(--text-tertiary);
        }

        .smart-search-input:focus {
            border-color: var(--primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        /* --- Success Button --- */
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: var(--success-dark);
            box-shadow: 0 6px 20px var(--success-glow);
        }

        /* --- Service Management Modal Styles --- */
        .service-item {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            transition: all 0.2s ease;
        }
        .service-item:hover {
            background: var(--bg-tertiary);
        }

        .service-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        .service-item-header strong {
            color: var(--text-primary);
        }
        .service-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            text-transform: capitalize;
        }
        /* צבעים לסטטוסים */
        .service-item.requested .service-status { background: var(--bg-card); color: var(--text-tertiary); }
        .service-item.in-progress .service-status { background: var(--warning); color: var(--bg-primary); }
        .service-item.completed .service-status { background: var(--success); color: var(--bg-primary); }
        .service-item.cancelled .service-status { background: var(--danger); color: white; }

        .service-item-body {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .service-item-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        .btn-sm { /* כפתורים קטנים יותר לפעולות */
            padding: 4px 10px;
            font-size: 12px;
        }

        /* --- General Service Indicator --- */
        .indicator-item.general-service {
            background: linear-gradient(45deg, var(--warning-dark), var(--warning));
            box-shadow: 0 2px 8px var(--warning-glow);
        }

        /* --- Services Center Module --- */
        .services-center-container {
            padding: var(--spacing-lg);
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }
        .services-center-container h1 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
        }
        .services-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        .service-list-item {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
        }
        .service-list-item .service-item-header strong:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        .service-item-footer {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-xs);
            border-top: 1px solid var(--glass-border);
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            justify-content: space-between;
        }

        /* --- Open Tasks View --- */
        .open-tasks-container {
            padding: var(--spacing-lg);
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }
        .open-tasks-container h1 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
        }
        .open-tasks-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
        }
        .open-task-item {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        .open-task-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .open-task-item.urgent { border-left: 4px solid var(--danger); }
        .open-task-item.warning { border-left: 4px solid var(--warning); }
        .open-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .open-task-ship {
            font-weight: 600;
            color: var(--text-primary);
        }
        .open-task-ship .ship-status-compact {
            display: inline-block;
            margin-right: var(--spacing-sm);
            vertical-align: middle;
        }
        .open-task-status.task-dot {
            width: 12px;
            height: 12px;
            box-shadow: none;
        }
        .open-task-body {
            color: var(--text-secondary);
            font-size: 14px;
        }
        .open-task-footer {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-xs);
            border-top: 1px solid var(--glass-border);
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            justify-content: space-between;
        }

        /* ======================== DISCHARGE TRACKING VIEW ======================== */
        .discharge-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: var(--spacing-xl);
            overflow-y: auto;
            background: var(--bg-primary);
        }
        .discharge-view.active {
            display: block;
        }
        .discharge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }
        .discharge-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .discharge-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        .discharge-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }
        @media (max-width: 1200px) {
            .discharge-grid {
                grid-template-columns: 1fr;
            }
        }
        .discharge-section {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }
        .discharge-section-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }

        /* Tally Input Methods */
        .tally-input-tabs {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-secondary);
            padding: var(--spacing-xs);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        .tally-input-tab {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        .tally-input-tab:hover {
            color: var(--text-secondary);
            background: var(--bg-hover);
        }
        .tally-input-tab.active {
            background: var(--primary);
            color: white;
        }
        .tally-input-content {
            display: none;
        }
        .tally-input-content.active {
            display: block;
        }

        /* File Drop Zone */
        .tally-drop-zone {
            border: 2px dashed var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-2xl);
            text-align: center;
            cursor: pointer;
            transition: all 200ms;
        }
        .tally-drop-zone:hover,
        .tally-drop-zone.dragover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }
        .tally-drop-zone svg {
            margin-bottom: var(--spacing-md);
            color: var(--text-tertiary);
        }
        .tally-drop-zone p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        .tally-drop-zone span {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Text Input */
        .tally-text-input {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            direction: ltr;
            text-align: left;
        }
        .tally-text-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .tally-text-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Parse Button */
        .parse-tally-btn {
            width: 100%;
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all 200ms;
        }
        .parse-tally-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        /* Parsed Tally Results */
        .tally-results {
            margin-top: var(--spacing-lg);
        }
        .tally-result-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        .tally-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        .tally-result-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        .tally-result-date {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .tally-shift-row {
            display: grid;
            grid-template-columns: 80px 1fr 100px 100px;
            gap: var(--spacing-md);
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--glass-border);
            font-size: 13px;
        }
        .tally-shift-row:last-child {
            border-bottom: none;
        }
        .tally-shift-row.header {
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 12px;
        }
        .tally-shift-name {
            color: var(--primary);
            font-weight: 500;
        }
        .tally-cargo-details {
            color: var(--text-secondary);
        }
        .tally-quantity {
            text-align: left;
            direction: ltr;
            font-family: 'Courier New', monospace;
        }
        .tally-weight {
            text-align: left;
            direction: ltr;
            font-family: 'Courier New', monospace;
        }

        /* Remarks Section */
        .tally-remarks {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border-right: 3px solid var(--warning);
        }
        .tally-remarks-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--warning);
            margin-bottom: var(--spacing-xs);
        }
        .tally-remarks-text {
            color: var(--text-secondary);
            font-size: 13px;
            direction: ltr;
            text-align: left;
        }

        /* Progress Tracking */
        .discharge-progress {
            margin-top: var(--spacing-lg);
        }
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .progress-stat {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
        }
        .progress-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
        }
        .progress-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: var(--spacing-xs);
        }
        .progress-bar-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            height: 24px;
            overflow: hidden;
            margin-bottom: var(--spacing-md);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: var(--radius-full);
            transition: width 500ms ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        /* Daily Log */
        .daily-log {
            margin-top: var(--spacing-lg);
        }
        .daily-log-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }
        .daily-log-date {
            min-width: 80px;
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
        }
        .daily-log-details {
            flex: 1;
        }
        .daily-log-cargo {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 13px;
            margin-bottom: var(--spacing-xs);
        }
        .daily-log-cargo span {
            color: var(--text-secondary);
        }
        .daily-log-cargo strong {
            color: var(--text-primary);
            margin-right: var(--spacing-xs);
        }
        .daily-log-remarks {
            font-size: 12px;
            color: var(--text-tertiary);
            font-style: italic;
            direction: ltr;
            text-align: left;
        }

        /* Ship Selection for Discharge - Modern Style */
        .discharge-ship-selector {
            display: flex;
            gap: var(--spacing-lg);
            align-items: flex-start;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
        }
        .discharge-ship-selector select {
            flex: 1;
            max-width: 300px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 18px;
            padding-left: 40px;
        }
        .discharge-ship-selector select:hover {
            border-color: var(--primary);
            background-color: var(--bg-tertiary);
        }
        .discharge-ship-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }
        .discharge-ship-selector select option {
            padding: 12px;
            background: var(--bg-secondary);
        }

        /* ==================== FLOATING AI PARSER BUTTON ==================== */
        .floating-ai-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border: none;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4), 0 0 0 0 rgba(99, 102, 241, 0.4);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 300ms ease;
            animation: pulse-glow 2s infinite;
        }
        .floating-ai-btn svg {
            color: white;
            transition: transform 200ms;
        }
        .floating-ai-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
        }
        .floating-ai-btn:hover svg {
            transform: scale(1.1);
        }
        .floating-ai-label {
            position: absolute;
            right: 72px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateX(10px);
            transition: all 200ms;
            pointer-events: none;
        }
        .floating-ai-btn:hover .floating-ai-label {
            opacity: 1;
            transform: translateX(0);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4), 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4), 0 0 0 8px rgba(99, 102, 241, 0.1); }
        }

        /* ==================== SMART PARSER MODAL ==================== */
        .smart-parser-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .smart-parser-overlay.active {
            display: flex;
        }
        .smart-parser-container {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
        }
        .smart-parser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(135deg, var(--primary-glow), transparent);
        }
        .smart-parser-header h2 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        .smart-parser-header h2 svg {
            color: var(--primary);
        }
        .smart-parser-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 200ms;
        }
        .smart-parser-close:hover {
            background: var(--danger);
            color: white;
        }

        /* Input Section */
        .smart-parser-input-section {
            padding: 24px;
        }
        .smart-parser-dropzone {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 16px;
            transition: all 200ms;
            cursor: pointer;
        }
        .smart-parser-dropzone:hover, .smart-parser-dropzone.dragover {
            border-color: var(--primary);
            background: var(--primary-glow);
        }
        .smart-parser-dropzone svg {
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }
        .smart-parser-dropzone p {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }
        .smart-parser-dropzone span {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .smart-parser-textarea {
            width: 100%;
            min-height: 120px;
            max-height: 300px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 200ms;
        }
        .smart-parser-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .smart-parser-analyze-btn {
            width: 100%;
            padding: 16px;
            margin-top: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 200ms;
        }
        .smart-parser-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        /* Loading Section */
        .smart-parser-loading {
            padding: 48px 24px;
            text-align: center;
        }
        .smart-parser-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }
        .smart-parser-loading p {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }
        .smart-parser-loading span {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Results Section */
        .smart-parser-results {
            padding: 24px;
        }
        .smart-parser-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary-glow), transparent);
            border: 1px solid var(--primary);
            border-radius: 30px;
            margin-bottom: 20px;
        }
        .smart-parser-type-badge .type-icon {
            font-size: 20px;
        }
        .smart-parser-type-badge .type-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .smart-parser-type-badge .type-confidence {
            font-size: 12px;
            padding: 2px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
        }

        .smart-parser-action {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .smart-parser-action h3 {
            font-size: 13px;
            color: var(--text-tertiary);
            margin: 0 0 8px 0;
            font-weight: 500;
        }
        .smart-parser-action p {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .smart-parser-ship-match {
            margin-bottom: 16px;
        }
        .smart-parser-ship-match label {
            display: block;
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }
        .ship-match-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .ship-match-option {
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid var(--glass-border);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 200ms;
        }
        .ship-match-option:hover {
            border-color: var(--primary);
        }
        .ship-match-option.selected {
            border-color: var(--primary);
            background: var(--primary-glow);
        }
        .ship-match-option.new-ship {
            border-style: dashed;
            color: var(--success);
        }

        .smart-parser-fields {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        .parser-field-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        .parser-field-label {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        .parser-field-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        .parser-field-value.highlight {
            color: var(--primary);
        }

        .smart-parser-actions {
            display: flex;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--glass-border);
        }
        .smart-parser-actions .btn-secondary {
            flex: 1;
            padding: 14px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 200ms;
        }
        .smart-parser-actions .btn-secondary:hover {
            background: var(--bg-secondary);
        }
        .smart-parser-actions .btn-primary {
            flex: 2;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 200ms;
        }
        .smart-parser-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }

        /* Apply Tally Button */
        .apply-tally-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: all 200ms;
        }
        .apply-tally-btn:hover {
            background: var(--success-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--success-glow);
        }
        .apply-tally-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Image Preview */
        .tally-image-preview {
            margin-top: var(--spacing-md);
            max-height: 300px;
            overflow: auto;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
        }
        .tally-image-preview img {
            max-width: 100%;
            display: block;
        }

        /* Processing Indicator */
        .tally-processing {
            display: none;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }
        .tally-processing.active {
            display: flex;
        }
        .tally-processing .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ======================== REFERENCE DATA VIEW ======================== */
        .reference-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: var(--spacing-xl);
            overflow-y: auto;
            background: var(--bg-primary);
        }
        .reference-view.active {
            display: block;
        }
        .reference-header {
            margin-bottom: var(--spacing-xl);
        }
        .reference-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
        }
        .reference-title svg {
            color: var(--primary);
        }
        .reference-subtitle {
            color: var(--text-tertiary);
            font-size: 14px;
            margin: 0;
        }

        /* Reference Tabs */
        .reference-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing-lg);
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
        }
        .reference-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
        }
        .reference-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .reference-tab.active {
            background: var(--primary);
            color: white;
        }
        .reference-tab svg {
            opacity: 0.7;
        }
        .reference-tab.active svg {
            opacity: 1;
        }

        /* Reference Content */
        .reference-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            min-height: 400px;
        }
        .reference-panel {
            display: none;
            padding: var(--spacing-lg);
        }
        .reference-panel.active {
            display: block;
        }

        /* Reference Toolbar */
        .reference-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        .reference-search {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        .reference-search svg {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }
        .reference-search input {
            width: 100%;
            padding: 12px 44px 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
        }
        .reference-search input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .reference-add-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 200ms;
        }
        .reference-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--success-glow);
        }
        .reference-ai-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 200ms;
        }
        .reference-ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        /* Reference Table */
        .reference-table-wrapper {
            overflow-x: auto;
        }
        .reference-table {
            width: 100%;
            border-collapse: collapse;
        }
        .reference-table th {
            text-align: right;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--glass-border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .reference-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 14px;
            color: var(--text-primary);
        }
        .reference-table tr:hover td {
            background: var(--bg-hover);
        }
        .reference-table .actions {
            display: flex;
            gap: 8px;
        }
        .reference-table .action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }
        .reference-table .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .reference-table .action-btn.delete:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        .reference-table .empty-row td {
            text-align: center;
            padding: 48px;
            color: var(--text-tertiary);
        }

        /* ======================== OPERATIONS VIEW ======================== */
        .operations-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: var(--spacing-xl);
            overflow-y: auto;
            background: var(--bg-primary);
        }
        .operations-view.active {
            display: block;
        }
        .operations-header {
            margin-bottom: var(--spacing-xl);
        }
        .operations-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
        }
        .operations-title svg {
            color: var(--primary);
        }
        .operations-subtitle {
            color: var(--text-tertiary);
            font-size: 14px;
            margin: 0;
        }

        /* Operations Summary Cards */
        .ops-summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        .ops-summary-card {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(20px);
        }
        .ops-summary-card.urgent {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        .ops-summary-card.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        .ops-summary-card.normal {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        .ops-summary-card.completed {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }
        .ops-summary-icon {
            font-size: 24px;
        }
        .ops-summary-content {
            display: flex;
            flex-direction: column;
        }
        .ops-summary-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }
        .ops-summary-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Operations Filter Tabs */
        .ops-filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing-lg);
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            width: fit-content;
        }
        .ops-filter-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
        }
        .ops-filter-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .ops-filter-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Operations Tasks Container */
        .ops-tasks-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
        }
        .ops-tasks-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        /* Task Item */
        .ops-task-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: var(--spacing-md);
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            transition: all 200ms;
        }
        .ops-task-item:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
        }
        .ops-task-item.urgent {
            border-right: 4px solid var(--danger);
        }
        .ops-task-item.warning {
            border-right: 4px solid var(--warning);
        }
        .ops-task-item.completed {
            opacity: 0.6;
            border-right: 4px solid var(--success);
        }

        .ops-task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }
        .ops-task-checkbox:hover {
            border-color: var(--primary);
        }
        .ops-task-checkbox.done {
            background: var(--success);
            border-color: var(--success);
        }
        .ops-task-checkbox.in-progress {
            background: var(--warning);
            border-color: var(--warning);
        }

        .ops-task-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .ops-task-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .ops-task-ship {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ops-task-ship-link {
            color: var(--primary);
            cursor: pointer;
        }
        .ops-task-ship-link:hover {
            text-decoration: underline;
        }

        .ops-task-eta {
            font-size: 13px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .ops-task-urgency {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .ops-task-urgency.urgent {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        .ops-task-urgency.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        .ops-task-urgency.normal {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .ops-task-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        .ops-task-status.done {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        .ops-task-status.in-progress {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .ops-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }
        .ops-empty-state svg {
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        .ops-empty-state h3 {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
        }
        .ops-empty-state p {
            margin: 0;
        }

        /* ======================== GALLERY VIEW ======================== */
        .gallery-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: var(--spacing-xl);
            overflow-y: auto;
            background: var(--bg-primary);
        }
        .gallery-view.active {
            display: block;
        }
        .gallery-header {
            margin-bottom: var(--spacing-xl);
        }
        .gallery-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-sm) 0;
        }
        .gallery-title svg {
            color: var(--primary);
        }
        .gallery-subtitle {
            color: var(--text-tertiary);
            font-size: 14px;
            margin: 0;
        }

        /* Gallery Toolbar */
        .gallery-toolbar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        .gallery-search {
            flex: 1;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
        }
        .gallery-search svg {
            color: var(--text-tertiary);
        }
        .gallery-search input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
        }
        .gallery-search input::placeholder {
            color: var(--text-tertiary);
        }
        .gallery-upload-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: var(--spacing-sm) var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms;
        }
        .gallery-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Gallery Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }
        .gallery-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            transition: all 200ms;
            cursor: pointer;
        }
        .gallery-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .gallery-item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--bg-secondary);
        }
        .gallery-item-info {
            padding: var(--spacing-md);
        }
        .gallery-item-vessel {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }
        .gallery-item-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gallery-item-type {
            padding: 2px 8px;
            background: var(--bg-hover);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .gallery-item-actions {
            display: flex;
            gap: 8px;
            padding: 0 var(--spacing-md) var(--spacing-md);
        }
        .gallery-item-actions button {
            flex: 1;
            padding: 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 200ms;
        }
        .gallery-item-actions button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .gallery-item-actions button.delete:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .gallery-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
            color: var(--text-tertiary);
        }
        .gallery-empty svg {
            margin-bottom: var(--spacing-md);
            opacity: 0.3;
        }
        .gallery-empty h3 {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
            font-size: 18px;
        }
        .gallery-empty p {
            margin: 0;
        }

        /* Image Lightbox */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .lightbox-overlay.active {
            display: flex;
        }
        .lightbox-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lightbox-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
        }

        /* ======================== PORT STATUS GRID ======================== */
        .port-status-grid {
            display: grid;
            gap: 12px;
        }
        .port-status-row {
            display: grid;
            grid-template-columns: 1fr 140px 100px;
            gap: 12px;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }
        .port-status-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .port-status-date, .port-status-time {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
        }
        .port-status-date:focus, .port-status-time:focus {
            outline: none;
            border-color: var(--primary);
        }
        .port-status-date::-webkit-calendar-picker-indicator,
        .port-status-time::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .port-status-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Firebase SDK (compat version for classic script) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Background -->
    <div class="bg-pattern"></div>
    <div class="grid-overlay"></div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo.png" alt="TOMELON" class="logo-image">
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchToDashboardView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>ראשי</span>
                </div>
                <div class="nav-item" onclick="switchToOperationsView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <span>לוח תפעול</span>
                </div>
                <div class="nav-item" onclick="switchToQuickView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 15h6"/>
                    </svg>
                    <span>מבט מהיר</span>
                </div>
                <div class="nav-item" onclick="switchToParserView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span>ניתוח הודעות</span>
                </div>
                <div class="nav-item" onclick="switchToContactsView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>אנשי קשר</span>
                </div>
                <div class="nav-item" onclick="switchToDischargeView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    <span>מעקב פריקה</span>
                </div>
                <div class="nav-item" onclick="switchToReferenceView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        <line x1="12" y1="6" x2="16" y2="6"/>
                        <line x1="12" y1="10" x2="16" y2="10"/>
                        <line x1="8" y1="6" x2="8" y2="6"/>
                        <line x1="8" y1="10" x2="8" y2="10"/>
                    </svg>
                    <span>נתוני יסוד</span>
                </div>
                <div class="nav-item" onclick="switchToGalleryView()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <span>גלריית תמונות</span>
                </div>
            </nav>

            <div class="sidebar-section">
                <h4 class="sidebar-title">סטטיסטיקה</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalShips">0</div>
                        <div class="stat-label">סה״כ אניות</div>
                        <div class="stat-trend up">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m5 12 7-7 7 7"/>
                    </svg>
                            <span>+2 היום</span>
                </div>
                </div>
                    <div class="stat-card">
                        <div class="stat-value" id="atSeaCount">0</div>
                        <div class="stat-label">בדרך</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="atPortCount">0</div>
                        <div class="stat-label">על עוגן</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="underOperationCount">0</div>
                        <div class="stat-label">בפריקה</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="urgentTasks">0</div>
                        <div class="stat-label">משימות דחופות</div>
                        <div class="stat-trend down">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m19 12-7 7-7-7"/>
                    </svg>
                            <span>-3 מאתמול</span>
                </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- File Status Indicator -->
            <div class="file-status" id="fileStatus" style="display: none;">
                <div class="file-status-content">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                    </svg>
                    <span id="fileStatusText">קובץ לא נטען</span>
                    <button class="btn btn-sm btn-secondary" onclick="clearFileHandle()" title="נתק קובץ">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="header-top">
                    <h1 class="header-title">מערכת ניהול אניות</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-icon" onclick="toggleTheme()" title="מצב יום/לילה" id="themeToggleBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </button>
                        <button class="btn btn-secondary btn-icon" onclick="toggleActivityFeed()" title="פעילות אחרונה">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v4m0 12v4m-8-8h4m12 0h4"/>
                            </svg>
                        </button>
                        <button class="btn btn-secondary btn-icon" onclick="viewArchive()" title="צפייה בארכיון">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
                            </svg>
                        </button>
                        <button class="btn btn-secondary" onclick="clearLocalStorage()" title="ניקוי localStorage">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            </svg>
                            נקה נתונים
                        </button>
                        <button class="btn btn-success" onclick="addShipManually()" title="הוסף אנייה חדשה ידנית">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14m-7-7h14"/>
                            </svg>
                            הוסף אנייה
                        </button>
                        <button class="btn btn-primary" onclick="importExcel()" title="ייבוא דוח Excel">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/>
                            </svg>
                            ייבוא Excel
                        </button>
                        <div class="file-info" style="font-size: 12px; color: var(--text-tertiary); margin-top: var(--spacing-sm);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                            דורש Chrome/Edge 86+ או Firefox 111+
                        </div>
                    </div>
                </div>

                <div class="search-bar-container">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="smartSearchInput" class="smart-search-input" placeholder="חיפוש אנייה, סוכן, מטען, ETA/ETB...">
                </div>

            </header>

            <!-- Content -->
            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('all', this)">
                        <span class="tab-badge" id="allBadge">0</span>
                        כל האניות
                    </button>
                    <button class="tab" onclick="switchTab('under-operation', this)">
                        <span class="tab-badge" id="underOperationBadge">0</span>
                        בפריקה
                    </button>
                    <button class="tab" onclick="switchTab('at-port', this)">
                        <span class="tab-badge" id="atPortBadge">0</span>
                        על עוגן
                    </button>
                    <button class="tab" onclick="switchTab('at-sea', this)">
                        <span class="tab-badge" id="atSeaBadge">0</span>
                        בדרך
                    </button>
                    <button class="tab" onclick="switchTab('sailed', this)">
                        <span class="tab-badge" id="sailedBadge">0</span>
                        הפליגו
                    </button>
                    <button class="tab" onclick="switchTab('quick', this)">
                        <span class="tab-badge" id="quickBadge">0</span>
                        מבט מהיר
                    </button>
                </div>

                <!-- Ships Grid -->
                <div class="ships-grid" id="shipsGrid">
                    <!-- Ships will be rendered here -->
                </div>

                <!-- Email Parser View -->
                <div class="email-parser-view" id="emailParserView">
                    <div class="parser-section-header">
                        <h2 class="parser-section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            ניתוח הודעות אוטומטי
                        </h2>
                    </div>

                    <div class="parser-container">
                        <!-- Input Section -->
                        <div class="parser-input-section">
                            <div class="parser-section-header">
                                <h3 class="parser-section-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    הדבק הודעה / אימייל
                                </h3>
                            </div>
                            <textarea
                                class="email-textarea"
                                id="emailInput"
                                placeholder="הדבק כאן את תוכן האימייל או ההודעה...

לדוגמה:
From: Lady Zehma <mvladyzehma@gmail.com>
Subject: ETA to Haifa - 6 Hrs Notice

Dear Agency,
ETA to Haifa plt stn: 04.01.2026 / 14:00 lt
Need 50 tons fresh water
Crew change: 2 joining, 3 leaving

Best Regards,
Captain"></textarea>
                            <button class="parse-btn" onclick="parseEmailMessage()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                                נתח הודעה
                            </button>
                        </div>

                        <!-- Output Section -->
                        <div class="parser-output-section">
                            <div class="parser-section-header">
                                <h3 class="parser-section-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                    תוצאות ניתוח
                                </h3>
                            </div>
                            <div class="parsed-result" id="parsedResult">
                                <div class="parsed-empty">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    <span>הדבק הודעה ולחץ "נתח הודעה" לקבלת תוצאות</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts & Email Management View -->
                <div class="contacts-view" id="contactsView">
                    <div class="contacts-header">
                        <h2 class="contacts-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            ניהול אנשי קשר וקבוצות מייל
                        </h2>
                        <div class="contacts-actions">
                            <button class="btn btn-secondary" onclick="openAddContactModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <line x1="20" y1="8" x2="20" y2="14"/>
                                    <line x1="23" y1="11" x2="17" y2="11"/>
                                </svg>
                                איש קשר חדש
                            </button>
                            <button class="btn btn-primary" onclick="openAddGroupModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                קבוצה חדשה
                            </button>
                        </div>
                    </div>

                    <div class="contacts-grid">
                        <!-- Contacts Section -->
                        <div class="contacts-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                    אנשי קשר
                                </h3>
                                <span class="contacts-count" id="contactsCount">0</span>
                            </div>
                            <input type="text" class="search-input" id="contactSearch" placeholder="חיפוש איש קשר..." oninput="filterContacts()">
                            <div class="contacts-list" id="contactsList">
                                <div class="empty-state">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                    <p>אין אנשי קשר עדיין</p>
                                    <button class="btn btn-primary btn-sm" onclick="openAddContactModal()">הוסף איש קשר</button>
                                </div>
                            </div>
                        </div>

                        <!-- Groups Section -->
                        <div class="contacts-section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    קבוצות מייל
                                </h3>
                                <span class="contacts-count" id="groupsCount">0</span>
                            </div>
                            <div class="contacts-list" id="groupsList">
                                <div class="empty-state">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    <p>אין קבוצות עדיין</p>
                                    <button class="btn btn-primary btn-sm" onclick="openAddGroupModal()">צור קבוצה</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Composer Section -->
                    <div class="email-composer" id="emailComposer">
                        <div class="section-header">
                            <h3 class="section-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                                הכנת דוח למשלוח
                            </h3>
                            <select id="shipSelectForEmail" class="form-group select" onchange="updateEmailPreview()" style="width: auto; padding: 6px 12px;">
                                <option value="">בחר אנייה...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>נמענים:</label>
                            <div class="composer-recipients" id="composerRecipients">
                                <button class="add-recipient-btn" onclick="openRecipientSelector()">+ הוסף נמענים</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>נושא:</label>
                            <input type="text" id="emailSubject" placeholder="נושא ההודעה..." onchange="updateEmailPreview()">
                        </div>

                        <div class="form-group">
                            <label>תצוגה מקדימה:</label>
                            <div class="email-preview" id="emailPreview">
                                בחר אנייה ונמענים ליצירת הדוח...
                            </div>
                        </div>

                        <button class="open-outlook-btn" onclick="openInOutlook()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            פתח ב-Outlook
                        </button>
                    </div>
                </div>

                <!-- Discharge Tracking View -->
                <div class="discharge-view" id="dischargeView">
                    <div class="discharge-header">
                        <h2 class="discharge-title">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                            מעקב פריקה - Discharge Tracking
                        </h2>
                        <div class="discharge-actions">
                            <button class="btn btn-secondary" onclick="clearTallyData()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                נקה נתונים
                            </button>
                            <button class="btn btn-primary" onclick="exportDischargeReport()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                ייצוא דוח
                            </button>
                        </div>
                    </div>

                    <!-- Ship Selection and Voyage Contacts -->
                    <div class="discharge-ship-selector" style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 600; color: var(--text-primary);">בחר אנייה:</label>
                            <select id="dischargeShipSelect" onchange="loadDischargeData(); loadVoyageContacts(); loadPortStatus();">
                                <option value="">-- בחר אנייה --</option>
                            </select>
                        </div>

                        <!-- Voyage Contacts Section -->
                        <div id="voyageContactsSection" style="flex: 2; min-width: 300px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--glass-border); display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-left: 4px;">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    אנשי קשר להפלגה
                                </span>
                                <button onclick="showAddVoyageContactModal()" style="padding: 4px 10px; border-radius: 6px; border: 1px solid var(--primary); background: transparent; color: var(--primary); font-size: 12px; cursor: pointer;">
                                    + הוסף
                                </button>
                            </div>
                            <div id="voyageContactsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                            <div id="inheritContactsHint" style="display: none; margin-top: 8px; padding: 8px; background: var(--warning-glow); border-radius: 6px; font-size: 12px; color: var(--warning);">
                                <button onclick="inheritPreviousVoyageContacts()" style="background: var(--warning); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ייבא מהפלגה קודמת
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="discharge-grid">
                        <!-- Tally Input Section -->
                        <div class="discharge-section">
                            <h3 class="discharge-section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                                קליטת טאלי יומי
                            </h3>

                            <!-- Input Method Tabs -->
                            <div class="tally-input-tabs">
                                <button class="tally-input-tab" onclick="switchTallyInputTab('manual')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20h9"/>
                                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                    </svg>
                                    ידני
                                </button>
                                <button class="tally-input-tab active" onclick="switchTallyInputTab('text')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                    טקסט
                                </button>
                                <button class="tally-input-tab" onclick="switchTallyInputTab('image')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    תמונה
                                </button>
                                <button class="tally-input-tab" onclick="switchTallyInputTab('pdf')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <path d="M9 15h6"/>
                                    </svg>
                                    PDF
                                </button>
                            </div>

                            <!-- Manual Input -->
                            <div class="tally-input-content" id="tallyInputManual">
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="font-size: 12px; color: var(--text-secondary);">תאריך</label>
                                            <input type="date" id="manualTallyDate" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: var(--text-secondary);">משמרת</label>
                                            <select id="manualTallyShift" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                                <option value="1">משמרת 1 (06:30-14:30)</option>
                                                <option value="2">משמרת 2 (14:30-22:30)</option>
                                                <option value="3">משמרת 3 (22:30-06:30)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary);">מנופים/גנגים</label>
                                        <input type="text" id="manualTallyGangs" placeholder="לדוגמא: 2 gangs" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                    </div>

                                    <div id="manualCargoEntries">
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; display: block;">סוגי מטען:</label>
                                        <div class="manual-cargo-entry" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px;">
                                            <input type="text" placeholder="סוג מטען" class="cargo-type-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                            <input type="number" placeholder="כמות" class="cargo-qty-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                            <input type="number" step="0.001" placeholder="משקל MT" class="cargo-weight-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                                            <button onclick="removeCargoEntry(this)" style="padding: 8px; border-radius: 6px; border: none; background: var(--danger-glow); color: var(--danger); cursor: pointer;">✕</button>
                                        </div>
                                    </div>
                                    <button onclick="addManualCargoEntry()" style="padding: 8px; border-radius: 6px; border: 1px dashed var(--glass-border); background: transparent; color: var(--text-secondary); cursor: pointer; width: 100%;">
                                        + הוסף סוג מטען
                                    </button>

                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary);">הערות</label>
                                        <textarea id="manualTallyRemarks" rows="2" placeholder="גשם, עצירות, בעיות..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary); resize: vertical;"></textarea>
                                    </div>

                                    <button onclick="saveManualTally()" class="parse-tally-btn">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                            <polyline points="17 21 17 13 7 13 7 21"/>
                                            <polyline points="7 3 7 8 15 8"/>
                                        </svg>
                                        שמור משמרת
                                    </button>
                                </div>
                            </div>

                            <!-- Text Input -->
                            <div class="tally-input-content active" id="tallyInputText">
                                <textarea class="tally-text-input" id="tallyTextArea" placeholder="Paste tally report here...

Example format:
Date: 15/01/2024
Shift 1 (07:00-15:00): Gang 1-2
- Steel coils: 150 units, 2,450 MT
- Breakbulk: 45 units, 890 MT

Shift 2 (15:00-23:00): Gang 1-3
- Steel coils: 180 units, 2,890 MT

Remarks: Rain stopped operations 14:30-15:15"></textarea>
                                <button class="parse-tally-btn" onclick="parseTallyText()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    נתח טאלי
                                </button>
                            </div>

                            <!-- Image Input -->
                            <div class="tally-input-content" id="tallyInputImage">
                                <div class="tally-drop-zone" id="imageDropZone" onclick="document.getElementById('tallyImageInput').click()">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <p>גרור תמונה לכאן או לחץ לבחירה</p>
                                    <span>PNG, JPG, JPEG (מקסימום 10MB)</span>
                                </div>
                                <input type="file" id="tallyImageInput" accept="image/*" style="display: none;" onchange="handleTallyImage(event)">
                                <div class="tally-image-preview" id="tallyImagePreview" style="display: none;"></div>
                                <div class="tally-processing" id="imageProcessing">
                                    <div class="spinner"></div>
                                    <span>מעבד תמונה...</span>
                                </div>
                                <button class="parse-tally-btn" id="parseImageBtn" onclick="parseImageTally()" style="display: none;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    נתח תמונה
                                </button>
                            </div>

                            <!-- PDF Input -->
                            <div class="tally-input-content" id="tallyInputPdf">
                                <div class="tally-drop-zone" id="pdfDropZone" onclick="document.getElementById('tallyPdfInput').click()">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <path d="M9 15h6"/>
                                    </svg>
                                    <p>גרור קובץ PDF לכאן או לחץ לבחירה</p>
                                    <span>PDF (מקסימום 10MB)</span>
                                </div>
                                <input type="file" id="tallyPdfInput" accept=".pdf" style="display: none;" onchange="handleTallyPdf(event)">
                                <div class="tally-processing" id="pdfProcessing">
                                    <div class="spinner"></div>
                                    <span>מעבד PDF...</span>
                                </div>
                                <div id="pdfFileName" style="margin-top: var(--spacing-md); color: var(--text-secondary); display: none;"></div>
                                <button class="parse-tally-btn" id="parsePdfBtn" onclick="parsePdfTally()" style="display: none;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    נתח PDF
                                </button>
                            </div>

                            <!-- Parsed Results -->
                            <div class="tally-results" id="tallyResults" style="display: none;">
                                <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">תוצאות ניתוח:</h4>
                                <div class="tally-result-card">
                                    <div class="tally-result-header">
                                        <span class="tally-result-title" id="parsedTallyDate">--</span>
                                        <span class="tally-result-date" id="parsedTallyTime">--</span>
                                    </div>
                                    <div class="tally-shift-row header">
                                        <span>משמרת</span>
                                        <span>מטען</span>
                                        <span>כמות</span>
                                        <span>משקל (MT)</span>
                                    </div>
                                    <div id="parsedShiftsContainer">
                                        <!-- Shifts will be rendered here -->
                                    </div>
                                    <div class="tally-remarks" id="parsedRemarks" style="display: none;">
                                        <div class="tally-remarks-title">Remarks / Events</div>
                                        <div class="tally-remarks-text" id="parsedRemarksText"></div>
                                    </div>
                                </div>
                                <button class="apply-tally-btn" onclick="applyTallyToShip()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    החל על האנייה
                                </button>
                            </div>
                        </div>

                        <!-- Progress Tracking Section -->
                        <div class="discharge-section">
                            <h3 class="discharge-section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                                התקדמות פריקה
                            </h3>

                            <div class="discharge-progress">
                                <div class="progress-summary">
                                    <div class="progress-stat">
                                        <div class="progress-stat-value" id="totalDischarged">0</div>
                                        <div class="progress-stat-label">טון שנפרקו</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-value" id="totalUnits">0</div>
                                        <div class="progress-stat-label">יחידות</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-value" id="totalDays">0</div>
                                        <div class="progress-stat-label">ימי פריקה</div>
                                    </div>
                                    <div class="progress-stat">
                                        <div class="progress-stat-value" id="avgPerDay">0</div>
                                        <div class="progress-stat-label">ממוצע ליום (MT)</div>
                                    </div>
                                </div>

                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="dischargeProgressBar" style="width: 0%;">0%</div>
                                </div>

                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-tertiary); margin-bottom: var(--spacing-lg);">
                                    <span>נפרק: <span id="dischargedAmount">0</span> MT</span>
                                    <span>נותר: <span id="remainingAmount">0</span> MT</span>
                                    <span>סה"כ: <span id="totalCargo">0</span> MT</span>
                                </div>
                            </div>

                            <!-- Daily Log -->
                            <div class="daily-log">
                                <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    יומן פריקה יומי
                                </h4>
                                <div id="dailyLogContainer">
                                    <div class="empty-state">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        <p>אין נתוני פריקה עדיין</p>
                                        <span>קלוט טאלי יומי להתחלת מעקב</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Port Status Section -->
                        <div class="discharge-section" style="grid-column: 1 / -1;">
                            <h3 class="discharge-section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                Port Status (Statement of Facts)
                                <button onclick="generateSOF()" style="margin-right: auto; padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                    יצא דוח עובדות
                                </button>
                            </h3>

                            <div id="portStatusForm" class="port-status-grid">
                                <div class="port-status-row">
                                    <span class="port-status-label">1. Arrived on Roads / ETA:</span>
                                    <input type="date" id="ps_arrivedOnRoads_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_arrivedOnRoads_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">2. Notice of Readiness Tendered:</span>
                                    <input type="date" id="ps_norTendered_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_norTendered_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">3. Pilot on Board:</span>
                                    <input type="date" id="ps_pilotOnBoard_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_pilotOnBoard_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">4. Vessel Berthed:</span>
                                    <input type="date" id="ps_vesselBerthed_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_vesselBerthed_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">5. D/L Commenced:</span>
                                    <input type="date" id="ps_dlCommenced_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_dlCommenced_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">6. D/L Completed:</span>
                                    <input type="date" id="ps_dlCompleted_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_dlCompleted_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">7. Pilot Ordered:</span>
                                    <input type="date" id="ps_pilotOrdered_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_pilotOrdered_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                                <div class="port-status-row">
                                    <span class="port-status-label">8. Sailed:</span>
                                    <input type="date" id="ps_sailed_date" class="port-status-date" onchange="savePortStatus()">
                                    <input type="time" id="ps_sailed_time" class="port-status-time" onchange="savePortStatus()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference Data View -->
                <div class="reference-view" id="referenceView">
                    <div class="reference-header">
                        <h2 class="reference-title">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                            נתוני יסוד
                        </h2>
                        <p class="reference-subtitle">ניהול רשימות יסוד למערכת</p>
                    </div>

                    <!-- Reference Tabs -->
                    <div class="reference-tabs">
                        <button class="reference-tab active" onclick="switchReferenceTab('vessels')" data-tab="vessels">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                                <path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76"/>
                            </svg>
                            אניות
                        </button>
                        <button class="reference-tab" onclick="switchReferenceTab('cargo')" data-tab="cargo">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            מטענים
                        </button>
                        <button class="reference-tab" onclick="switchReferenceTab('owners')" data-tab="owners">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 21h18M3 7v1a3 3 0 0 0 6 0V7m0 1a3 3 0 0 0 6 0V7m0 1a3 3 0 0 0 6 0V7H3l2-4h14l2 4"/>
                            </svg>
                            בעלים / שוכרים
                        </button>
                        <button class="reference-tab" onclick="switchReferenceTab('receivers')" data-tab="receivers">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            </svg>
                            מקבלי מטען
                        </button>
                    </div>

                    <!-- Reference Content -->
                    <div class="reference-content">
                        <!-- Vessels Tab -->
                        <div class="reference-panel active" id="refVesselsPanel">
                            <div class="reference-toolbar">
                                <div class="reference-search">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="חיפוש אניות..." id="refVesselSearch" oninput="filterReferenceTable('vessels')">
                                </div>
                                <button class="reference-add-btn" onclick="showAddReferenceModal('vessels')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    הוסף אנייה
                                </button>
                                <button class="reference-ai-btn" onclick="showAiImportModal('vessels')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 16v-4M12 8h.01"/>
                                    </svg>
                                    ייבוא חכם
                                </button>
                            </div>
                            <div class="reference-table-wrapper">
                                <table class="reference-table" id="refVesselsTable">
                                    <thead>
                                        <tr>
                                            <th>מס'</th>
                                            <th>שם אנייה</th>
                                            <th>דגל</th>
                                            <th>שנת בנייה</th>
                                            <th>מעמסות</th>
                                            <th>LOA</th>
                                            <th>רוחב</th>
                                            <th>DWT</th>
                                            <th>Grain</th>
                                            <th>Bale</th>
                                            <th>NRT</th>
                                            <th>GRT</th>
                                            <th>IMO</th>
                                            <th>תאימות דגון</th>
                                            <th>מס' נמל ישראלי</th>
                                            <th>פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refVesselsBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Cargo Tab -->
                        <div class="reference-panel" id="refCargoPanel">
                            <div class="reference-toolbar">
                                <div class="reference-search">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="חיפוש מטענים..." id="refCargoSearch" oninput="filterReferenceTable('cargo')">
                                </div>
                                <button class="reference-add-btn" onclick="showAddReferenceModal('cargo')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    הוסף סוג מטען
                                </button>
                            </div>
                            <div class="reference-table-wrapper">
                                <table class="reference-table" id="refCargoTable">
                                    <thead>
                                        <tr>
                                            <th>מס"ד</th>
                                            <th>סוג מטען</th>
                                            <th>קטגוריה</th>
                                            <th>יחידת מידה</th>
                                            <th>הערות</th>
                                            <th>פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refCargoBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Owners Tab -->
                        <div class="reference-panel" id="refOwnersPanel">
                            <div class="reference-toolbar">
                                <div class="reference-search">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="חיפוש בעלים..." id="refOwnersSearch" oninput="filterReferenceTable('owners')">
                                </div>
                                <button class="reference-add-btn" onclick="showAddReferenceModal('owners')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    הוסף בעלים
                                </button>
                            </div>
                            <div class="reference-table-wrapper">
                                <table class="reference-table" id="refOwnersTable">
                                    <thead>
                                        <tr>
                                            <th>שם</th>
                                            <th>סוג</th>
                                            <th>מדינה</th>
                                            <th>אימייל</th>
                                            <th>טלפון</th>
                                            <th>פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refOwnersBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Receivers Tab -->
                        <div class="reference-panel" id="refReceiversPanel">
                            <div class="reference-toolbar">
                                <div class="reference-search">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="חיפוש מקבלי מטען..." id="refReceiversSearch" oninput="filterReferenceTable('receivers')">
                                </div>
                                <button class="reference-add-btn" onclick="showAddReferenceModal('receivers')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    הוסף מקבל מטען
                                </button>
                            </div>
                            <div class="reference-table-wrapper">
                                <table class="reference-table" id="refReceiversTable">
                                    <thead>
                                        <tr>
                                            <th>שם</th>
                                            <th>חברה</th>
                                            <th>אימייל</th>
                                            <th>טלפון</th>
                                            <th>כתובת</th>
                                            <th>פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refReceiversBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations View - Global Tasks Dashboard -->
            <div class="operations-view" id="operationsView">
                <div class="operations-header">
                    <h2 class="operations-title">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        לוח תפעול יומי
                    </h2>
                    <p class="operations-subtitle">כל המשימות הפתוחות בכל האניות</p>
                </div>

                <!-- Operations Summary Cards -->
                <div class="ops-summary-cards">
                    <div class="ops-summary-card urgent">
                        <div class="ops-summary-icon">🔴</div>
                        <div class="ops-summary-content">
                            <span class="ops-summary-value" id="opsUrgentCount">0</span>
                            <span class="ops-summary-label">דחוף - היום</span>
                        </div>
                    </div>
                    <div class="ops-summary-card warning">
                        <div class="ops-summary-icon">🟡</div>
                        <div class="ops-summary-content">
                            <span class="ops-summary-value" id="opsWarningCount">0</span>
                            <span class="ops-summary-label">ב-48 שעות</span>
                        </div>
                    </div>
                    <div class="ops-summary-card normal">
                        <div class="ops-summary-icon">🟢</div>
                        <div class="ops-summary-content">
                            <span class="ops-summary-value" id="opsNormalCount">0</span>
                            <span class="ops-summary-label">שוטף</span>
                        </div>
                    </div>
                    <div class="ops-summary-card completed">
                        <div class="ops-summary-icon">✅</div>
                        <div class="ops-summary-content">
                            <span class="ops-summary-value" id="opsCompletedCount">0</span>
                            <span class="ops-summary-label">הושלם היום</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="ops-filter-tabs">
                    <button class="ops-filter-tab active" data-filter="all" onclick="filterOperationsTasks('all')">
                        הכל
                    </button>
                    <button class="ops-filter-tab" data-filter="urgent" onclick="filterOperationsTasks('urgent')">
                        🔴 דחוף
                    </button>
                    <button class="ops-filter-tab" data-filter="today" onclick="filterOperationsTasks('today')">
                        📅 היום
                    </button>
                    <button class="ops-filter-tab" data-filter="pending" onclick="filterOperationsTasks('pending')">
                        ⏳ ממתין
                    </button>
                    <button class="ops-filter-tab" data-filter="in-progress" onclick="filterOperationsTasks('in-progress')">
                        🔄 בביצוע
                    </button>
                </div>

                <!-- Tasks List -->
                <div class="ops-tasks-container">
                    <div class="ops-tasks-list" id="opsTasksList">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Gallery View - Vessel Images -->
            <div class="gallery-view" id="galleryView">
                <div class="gallery-header">
                    <h2 class="gallery-title">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        גלריית תמונות
                    </h2>
                    <p class="gallery-subtitle">תמונות מעמסות, מסמכים ותיעוד אניות</p>
                </div>

                <!-- Gallery Search & Filter -->
                <div class="gallery-toolbar">
                    <div class="gallery-search">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="gallerySearch" placeholder="חפש לפי שם אנייה..." oninput="filterGallery()">
                    </div>
                    <button class="gallery-upload-btn" onclick="openGalleryUpload()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        העלה תמונה
                    </button>
                </div>

                <!-- Gallery Grid -->
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Images will be rendered here -->
                    <div class="gallery-empty" id="galleryEmpty">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <h3>אין תמונות עדיין</h3>
                        <p>העלה תמונות של מעמסות, מסמכים או תיעוד אנייה</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Activity Feed (Hidden by default) -->
        <aside class="activity-feed" id="activityFeed">
            <div class="activity-header">
                <h3 class="activity-title">פעילות אחרונה</h3>
                <button class="activity-close" onclick="toggleActivityFeed()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="activity-content" id="activityContent">
                <!-- Activities will be rendered here -->
            </div>
        </aside>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">כותרת</h2>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content -->
            </div>
        </div>
    </div>

    <!-- Email Notification Modal -->
    <div class="modal-overlay" id="emailNotifyModal" onclick="closeEmailModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-glow), transparent); border-bottom: 1px solid var(--primary);">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    שליחת עדכון במייל
                </h2>
                <button class="modal-close" onclick="closeEmailModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Recipients Selection -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">נמענים:</label>
                    <div id="emailRecipientsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                    <input type="email" id="additionalEmail" placeholder="הוסף כתובת נוספת..."
                        style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);"
                        onkeypress="if(event.key==='Enter') addCustomRecipient()">
                </div>

                <!-- Subject -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">נושא:</label>
                    <input type="text" id="emailSubject"
                        style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <!-- Email Body -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">תוכן:</label>
                    <textarea id="emailBody" rows="12"
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary); font-family: monospace; font-size: 13px; line-height: 1.5; resize: vertical;"></textarea>
                </div>

                <!-- Save to voyage option -->
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--glass-border);">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="saveRecipientsToVoyage" checked style="width: 18px; height: 18px; accent-color: var(--success);">
                        <div>
                            <span style="font-weight: 600; color: var(--text-primary);">שמור נמענים להפלגה</span>
                            <span style="font-size: 12px; color: var(--text-tertiary); display: block;">הנמענים שנבחרו ישמרו כברירת מחדל להפלגה זו</span>
                        </div>
                    </label>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeEmailModal()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                        דלג
                    </button>
                    <button onclick="copyEmailToClipboard()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        העתק
                    </button>
                    <button onclick="openInEmailClient()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        פתח באאוטלוק
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Floating AI Parser Button -->
    <button class="floating-ai-btn" id="floatingAiBtn" onclick="openSmartParser()">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            <path d="M12 7v2M12 13h.01"/>
        </svg>
        <span class="floating-ai-label">נתח הודעה</span>
    </button>

    <!-- Smart AI Parser Modal -->
    <div class="smart-parser-overlay" id="smartParserModal" onclick="closeSmartParser(event)">
        <div class="smart-parser-container" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="smart-parser-header">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    ניתוח חכם
                </h2>
                <button class="smart-parser-close" onclick="closeSmartParser()">✕</button>
            </div>

            <!-- Input Section -->
            <div class="smart-parser-input-section" id="parserInputSection">
                <div class="smart-parser-dropzone" id="smartParserDropzone"
                     ondragover="event.preventDefault(); this.classList.add('dragover')"
                     ondragleave="this.classList.remove('dragover')"
                     ondrop="handleSmartParserDrop(event)">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <p>הדבק טקסט, גרור קובץ, או הקלד</p>
                    <span>מיילים, הודעות וואטסאפ, דוחות טאלי</span>
                </div>
                <textarea id="smartParserInput" class="smart-parser-textarea"
                    placeholder="הדבק כאן מייל, הודעת וואטסאפ, או כל טקסט רלוונטי..."
                    oninput="autoResizeTextarea(this)"></textarea>
                <button class="smart-parser-analyze-btn" onclick="analyzeSmartInput()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    נתח ואפיין
                </button>
            </div>

            <!-- Loading State -->
            <div class="smart-parser-loading" id="parserLoadingSection" style="display: none;">
                <div class="smart-parser-spinner"></div>
                <p>מנתח את ההודעה...</p>
                <span>זיהוי סוג, חילוץ פרטים, התאמה לאניות</span>
            </div>

            <!-- Results Section -->
            <div class="smart-parser-results" id="parserResultsSection" style="display: none;">
                <!-- Message Type Badge -->
                <div class="smart-parser-type-badge" id="parserTypeBadge">
                    <span class="type-icon">📋</span>
                    <span class="type-label">סוג ההודעה</span>
                    <span class="type-confidence">95%</span>
                </div>

                <!-- Detected Action -->
                <div class="smart-parser-action" id="parserDetectedAction">
                    <h3>פעולה מזוהה:</h3>
                    <p id="parserActionDescription">עדכון ETA לאנייה ELA S</p>
                </div>

                <!-- Ship Match -->
                <div class="smart-parser-ship-match" id="parserShipMatch">
                    <label>אנייה:</label>
                    <div class="ship-match-options" id="shipMatchOptions">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Extracted Fields Preview -->
                <div class="smart-parser-fields" id="parserExtractedFields">
                    <!-- Populated dynamically -->
                </div>

                <!-- Action Buttons -->
                <div class="smart-parser-actions">
                    <button class="btn-secondary" onclick="resetSmartParser()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                            <path d="M3 3v5h5"/>
                        </svg>
                        נתח מחדש
                    </button>
                    <button class="btn-primary" onclick="applySmartParserAction()" id="applyParserBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        אשר והחל
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart AI Search -->
    <button class="ai-search-toggle" onclick="toggleAiSearch()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
        </svg>
        שאל על כל אנייה...
    </button>

    <div class="smart-ai-search" id="smartAiSearch">
        <div class="ai-search-container">
            <div class="ai-search-header">
                <div class="ai-search-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    חיפוש חכם - שאל כל שאלה
                </div>
                <button class="ai-search-close" onclick="toggleAiSearch()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="ai-search-input-container">
                <input type="text" class="ai-search-input" id="aiSearchInput"
                       placeholder="מה ה-ETA של האנייה? מי המקבלים ב-X? מה האורך של Y?"
                       onkeypress="if(event.key==='Enter') performAiSearch()">
                <button class="ai-search-submit" onclick="performAiSearch()" id="aiSearchBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
            <div class="ai-search-results" id="aiSearchResults" style="display: none;"></div>
            <div class="ai-search-examples">
                דוגמאות:
                <span onclick="setAiSearchExample('מי המקבלים באנייה X?')">מקבלים</span>
                <span onclick="setAiSearchExample('מה ה-ETA של X?')">ETA</span>
                <span onclick="setAiSearchExample('מה אורך האנייה X?')">מידות</span>
                <span onclick="setAiSearchExample('כמה מטען יש ב-X?')">מטען</span>
            </div>
        </div>
    </div>

    <!-- File Input -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ==================== Firebase Setup ====================
        // קוד החיבור שהמשתמש קיבל מגוגל
        const firebaseConfig = {
          apiKey: "AIzaSyAvp97Y1s-4lB6w6Z-mHnX_yIbEYlvZ0Yw",
          authDomain: "shipux-a0d3a.firebaseapp.com",
          projectId: "shipux-a0d3a",
          storageBucket: "shipux-a0d3a.firebasestorage.app",
          messagingSenderId: "355863179565",
          appId: "1:355863179565:web:d25b818d15d56a198be3a4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // אתחול בסיס הנתונים
        console.log("Firebase initialized successfully.");

        // ==================== Global State ====================
        let ships = [];
        let activities = [];
        let currentTab = 'all';
        let currentUser = `User_${Date.now()}`;
        let currentSearchTerm = '';

        // ==================== Data Version & Constants ====================
        let dataVersion = 1; // עולה בכל שמירה

        const STATUS = {
            AT_SEA: 'At Sea',
            AT_PORT: 'At Port',
            UNDER_OPERATION: 'Under Operation',
            SAILED: 'Sailed',
        };

        const STATUS_UI_ORDER = [STATUS.UNDER_OPERATION, STATUS.AT_PORT, STATUS.AT_SEA, STATUS.SAILED];

        const VESSEL_ID = (name, voyage) =>
            `${(name||'').trim().toLowerCase().replace(/\s+/g,'-')}__${(voyage||'').trim().replace('/','-')}`;

        const TRADERS = {
            DAN: 'Dan Rinot',
            MIKE: 'Mike'
        };

        // ==================== Ship Object Creation ====================
        function createShipObject(baseData = {}) {
            const ship = {
                id: baseData.id || Date.now().toString(),
                name: baseData.name || '',
                voyage: baseData.voyage || '',
                status: baseData.status || STATUS.AT_SEA,
                port: baseData.port || '',
                eta: baseData.eta || new Date().toISOString(),
                cargo: baseData.cargo || '',
                owner: baseData.owner || '',
                supplier: baseData.supplier || '',
                receivers: baseData.receivers || '',
                trader: baseData.trader || '',
                notes: baseData.notes || '',

                // Water supply fields
                waterSupply: baseData.waterSupply ?? false,
                waterAmount: baseData.waterAmount ?? null,

                // Package fields
                package: baseData.package ?? false,
                packageWeight: baseData.packageWeight ?? null,

                // Tracking
                trackingNumber: baseData.trackingNumber ?? null,

                // Expected times
                expected_berth_time: baseData.expected_berth_time ?? null,
                expected_finish_time: baseData.expected_finish_time ?? null,

                // Trader flag
                trader_flag: baseData.trader_flag ?? null,

                // Flags
                flags: baseData.flags ?? { missing_in_today_report: false },

                // Version
                version: baseData.version ?? 1,

                // Tasks (replaces checklist)
                tasks: baseData.tasks || [],

                // Voyage-specific contacts for email notifications
                voyageContacts: baseData.voyageContacts || [],

                // Manifest - declared cargo for this voyage
                manifest: baseData.manifest || {
                    totalWeight: 0,
                    totalQuantity: 0,
                    items: [] // Array of { type, weight, quantity, unit, blNumber }
                },

                // Port Status - formal timestamps for Statement of Facts
                portStatus: baseData.portStatus || {
                    arrivedOnRoads: { date: null, time: null },      // 1. Arrived on roads / ETA
                    norTendered: { date: null, time: null },         // 2. Notice of Readiness Tendered
                    pilotOnBoard: { date: null, time: null },        // 3. Pilot on board
                    vesselBerthed: { date: null, time: null },       // 4. Vessel Berthed
                    dlCommenced: { date: null, time: null },         // 5. D/L commenced
                    dlCompleted: { date: null, time: null },         // 6. D/L completed
                    pilotOrdered: { date: null, time: null },        // 7. Pilot Ordered
                    sailed: { date: null, time: null }               // 8. Sailed
                },

                // Timestamps
                createdAt: baseData.createdAt || new Date().toISOString(),
                updatedAt: baseData.updatedAt || new Date().toISOString()
            };

            return ship;
        }

        // Save ship to Firestore
        async function saveShipToFirestore(ship) {
            if (!ship || !ship.id) {
                console.error('Invalid ship data');
                return;
            }

            ship.updatedAt = new Date().toISOString();

            try {
                await db.collection("ships").doc(ship.id).set(ship, { merge: true });
                console.log('Ship saved to Firestore:', ship.id);
            } catch (error) {
                console.error('Error saving ship to Firestore:', error);
                throw error;
            }
        }

        // Find contacts from previous voyage of the same vessel
        function findPreviousVoyageContacts(vesselName) {
            if (!vesselName) return [];

            // Normalize vessel name for comparison
            const normalizedName = vesselName.toLowerCase().replace(/[^a-z0-9]/g, '');

            // Find all ships with similar name, sorted by voyage number descending
            const sameVesselShips = ships
                .filter(s => {
                    const shipNameNorm = (s.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                    return shipNameNorm === normalizedName && s.voyageContacts && s.voyageContacts.length > 0;
                })
                .sort((a, b) => {
                    // Try to extract voyage number for sorting
                    const voyageA = parseInt((a.voyage || '').replace(/\D/g, '')) || 0;
                    const voyageB = parseInt((b.voyage || '').replace(/\D/g, '')) || 0;
                    return voyageB - voyageA;
                });

            // Return contacts from the most recent voyage
            if (sameVesselShips.length > 0) {
                return {
                    fromVoyage: sameVesselShips[0].voyage,
                    contacts: sameVesselShips[0].voyageContacts
                };
            }

            return null;
        }

        // Add contact to voyage
        function addContactToVoyage(shipId, contactEmail, contactName = '') {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return false;

            ship.voyageContacts = ship.voyageContacts || [];

            // Check if already exists
            if (ship.voyageContacts.some(c => c.email === contactEmail)) {
                return false;
            }

            ship.voyageContacts.push({
                email: contactEmail,
                name: contactName,
                addedAt: new Date().toISOString()
            });

            saveData();
            return true;
        }

        // Remove contact from voyage
        function removeContactFromVoyage(shipId, contactEmail) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.voyageContacts) return false;

            ship.voyageContacts = ship.voyageContacts.filter(c => c.email !== contactEmail);
            saveData();
            return true;
        }

        function ensureShipFields(ship) {
            // Ensure all required fields exist with default values
            ship.expected_berth_time ??= null;
            ship.expected_finish_time ??= null;
            ship.notes ??= '';
            ship.waterSupply ??= false;
            ship.waterAmount ??= null;
            ship.package ??= false;
            ship.packageWeight ??= null;
            ship.trackingNumber ??= null;
            ship.trader_flag ??= null;
            ship.flags ??= { missing_in_today_report: false };
            ship.version ??= 1;
            
            // Ensure tasks are properly set for current status
            ensureChecklistForStatus(ship);
            
            return ship;
        }

        // ==================== Manual Ship Addition ====================
        function addShipManually() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'הוספת אנייה חדשה';
            body.innerHTML = `
                <form id="addShipForm" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group"><label>שם אנייה:</label><input type="text" name="name" required></div>
                    <div class="form-group"><label>מסע (Voyage):</label><input type="text" name="voyage"></div>
                    <div class="form-group"><label>סטטוס:</label><select name="status">${Object.values(STATUS).map(s => `<option value="${s}">${getStatusText(s)}</option>`).join('')}</select></div>
                    <div class="form-group"><label>ETA:</label><input type="datetime-local" name="eta"></div>
                    <div class="form-group"><label>נמל פריקה:</label><input type="text" name="port"></div>
                    <div class="form-group"><label>מטען:</label><textarea name="cargo" rows="2"></textarea></div>

                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button type="submit" class="btn btn-primary">שמור אנייה</button>
                    </div>
                </form>
            `;

            modal.classList.add('active');

            document.getElementById('addShipForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                // יצירת אובייקט אנייה חדש
                const newShip = createShipObject({
                    name: data.name,
                    voyage: data.voyage,
                    status: data.status || STATUS.AT_SEA, // ברירת מחדל
                    eta: data.eta ? new Date(data.eta).toISOString() : null,
                    port: data.port,
                    cargo: data.cargo,
                    // הגדרת ID ייחודי
                    id: VESSEL_ID(data.name, data.voyage) + '_' + Date.now(),
                    // שדות ברירת מחדל נוספים
                    createdAt: new Date().toISOString()
                });

                // ודא שכל השדות קיימים והצ'קליסט נוצר
                const finalShip = ensureShipFields(newShip); 

                // הוסף לרשימה ושמור ב-Firestore
                ships.push(finalShip);
                db.collection("ships").doc(finalShip.id).set(finalShip)
                    .then(() => {
                        showToast('אנייה חדשה נוספה בהצלחה', 'success');
                        addActivity('הוספת אנייה', `נוספה אנייה חדשה: ${finalShip.name}`);
                    })
                    .catch(e => showToast('שגיאה בהוספת אנייה', 'error'));

                // עדכן ממשק
                if (currentTab !== 'quick') renderShips(); // אין לרנדר אם במבט מהיר
                updateStats();
                updateBadges();
                closeModal();
            };
        }

        // ==================== Task Templates ====================
        const PRE_ARRIVAL = [
            { key:'port_notice',        title:'הודעה לנמל',          due:'eta_minus_days:3',  statuses:[STATUS.AT_SEA] },
            { key:'pre_arrivals',       title:'שליחת PRE ARRIVALS',  due:'at_sea_window',     statuses:[STATUS.AT_SEA] },
            { key:'navy_approval',      title:'אישור חיל הים',       due:'eta_minus_days:2',  statuses:[STATUS.AT_SEA] },
            { key:'docs_received',      title:'קבלת ניירת',          due:'at_sea_window',     statuses:[STATUS.AT_SEA] },
            { key:'manifest_prepared',  title:'הכנת מניפסט',         due:'prefer_at_sea',     statuses:[STATUS.AT_SEA, STATUS.AT_PORT] },
            { key:'discharge_approval', title:'אישור פריקה',         due:'prefer_at_sea',     statuses:[STATUS.AT_SEA, STATUS.AT_PORT] },
            { key:'lashing_opening',    title:'אישור פתיחת לשינג',   due:'must_before_discharge', statuses:[STATUS.AT_SEA, STATUS.AT_PORT] }
        ];

        const POST_SAILED = [
            { key:'send_sof', title:'שליחת SOF', due:'day0_to_day1', statuses:[STATUS.SAILED] },
            { key:'send_nor', title:'שליחת NOR', due:'day0_to_day1', statuses:[STATUS.SAILED] }
        ];

        function buildChecklist(template) {
            return template.map(t => ({
                key: t.key, 
                title: t.title, 
                due: t.due, 
                statuses: t.statuses,
                status: 'pending', // חדש: שלושה מצבים: 'pending', 'in-progress', 'done'
                doneBy: null, 
                doneAt: null, 
                lastUpdatedAt: null
            }));
        }

        function ensureChecklistForStatus(ship) {
            const currentTemplate = ship.status === STATUS.SAILED ? POST_SAILED : PRE_ARRIVAL;
            const haveTemplate = Array.isArray(ship.tasks) && ship.tasks.every(x => x.key);
            if (!haveTemplate) { 
                ship.tasks = buildChecklist(currentTemplate); 
                return; 
            }
            // שמירה על משימות שסומנו + הוספת חסרות/הסרת לא רלוונטיות
            const nextKeys = new Set(currentTemplate.map(t=>t.key));
            const currentMap = new Map(ship.tasks.map(t=>[t.key,t]));
            ship.tasks = currentTemplate.map(t=>{
                const keep = currentMap.get(t.key);
                return keep ? { 
                    ...keep, 
                    title:t.title, 
                    due:t.due, 
                    statuses:t.statuses,
                    // שמירה על הסטטוס הקיים או הגדרת ברירת מחדל
                    status: keep.status || (keep.done ? 'done' : 'pending')
                } : {
                    key:t.key, 
                    title:t.title, 
                    due:t.due, 
                    statuses:t.statuses, 
                    status: 'pending', // חדש: סטטוס ברירת מחדל
                    doneBy:null, 
                    doneAt:null, 
                    lastUpdatedAt:null 
                };
            });
        }

        // Steel Types
        const steelTypes = [
            'Steel', 'Rebars', 'Wire Rods', 'Coils', 'Plates', 'Beams', 'Pipes', 'Bars',
            'Sheets', 'Aluminum', 'Metal', 'Galvanized', 'Billets', 'Angles', 'Channels'
        ];

        // Steel Whitelist for filtering
        const STEEL_WHITELIST = [
            'Alloyed Galvanized Wire','Alloyed Wire','Aluminum Billets','Aluminum Ingots','Aluminum Wire Rods',
            'Galvanized Wire','Merchant Bars','Rebars in spools','Sheet Piles','Steel','Steel Angles','Steel Bars',
            'Steel Beams','Steel Billets','Steel Billets In Bundles','Steel Channels','Steel Coils','Steel Debars',
            'Steel Debars in Coils','Steel Piles','Steel Pipes','Steel Plates','Steel Products','Steel Profiles',
            'Steel Rails','Steel Rebars','Steel Rebars in Coils','Steel Sections','Steel Sheets','Steel Stripes',
            'Steel Welded Mesh','Steel Wire Rods','Steel Wire Rods in Coils','Stone Wool','Tear Drops','Wire Strand in Coils'
        ].map(x=>x.toLowerCase());

        // ==================== Initialize ====================
        async function init() {
            initTheme(); // Initialize theme before anything else
            listenToData(); // התחל להאזין לשינויים מהענן
            updateStats();
            updateActivities();
            setupEventListeners();
            setupDropZones(); // Setup drag and drop for tally input
        }

        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    const feed = document.getElementById('activityFeed');
                    if (feed.classList.contains('active')) {
                        toggleActivityFeed();
                    }
                }
            });

            // Smart search listener
            const searchInput = document.getElementById('smartSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentSearchTerm = e.target.value.toLowerCase();
                    renderShips(); // רנדר מחדש את הרשימה עם כל הקלדה
                });
            }
        }

        // ==================== Real-time Data Listeners ====================
        function listenToData() {
            // האזנה לאניות פעילות
            db.collection("ships").onSnapshot(snapshot => {
                ships = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Real-time update: Ships loaded/updated:", ships.length);

                // ודא שכל השדות קיימים
                ships = ships.map(ship => ensureShipFields(ship));

                // רנדר את התצוגה הנכונה
                if (currentTab === 'quick') {
                    renderQuickView();
                } else {
                    renderShips();
                }
                updateStats();
                updateBadges();

            }, error => {
                console.error("Error fetching ships:", error);
                showToast("שגיאה בסנכרון אניות", "error");
            });

            // האזנה לארכיון
            db.collection("archived").onSnapshot(snapshot => {
                archived = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Real-time update: Archived loaded/updated:", archived.length);
            }, error => console.error("Error fetching archived ships:", error));

            // האזנה לפעילויות
            db.collection("activities").orderBy("time", "desc").limit(50).onSnapshot(snapshot => {
                activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Real-time update: Activities loaded/updated:", activities.length);
                updateActivities();
            }, error => console.error("Error fetching activities:", error));
        }

        // ==================== Data Management ====================
        async function loadData() {
            // Load data version
            const savedVersion = localStorage.getItem('dataVersion');
            if (savedVersion) {
                dataVersion = parseInt(savedVersion);
            }
            
            const saved = localStorage.getItem('shipsData');
            if (saved) {
                try {
                    ships = JSON.parse(saved);
                    // Ensure all ships have the new fields
                    ships = ships.map(ship => ensureShipFields(ship));
                    console.log('Loaded ships from localStorage:', ships.length);
                } catch (e) {
                    console.error('Error loading data:', e);
                    ships = []; // No sample ships on error
                    console.log('No ships loaded due to error');
                }
            } else {
                // No ships by default - user must import data
                ships = [];
                console.log('No ships loaded - user must import data');
            }

            // Load activities
            const savedActivities = localStorage.getItem('activities');
            if (savedActivities) {
                try {
                    activities = JSON.parse(savedActivities);
                } catch (e) {
                    activities = [];
                }
            }
            
            // Load archived ships
            const savedArchived = localStorage.getItem('archivedShips');
            if (savedArchived) {
                try {
                    archived = JSON.parse(savedArchived);
                } catch (e) {
                    console.error('Error loading archived ships:', e);
                    archived = [];
                }
            }
        }

        function saveData() {
            // Increment data version on each save
            dataVersion++;
            
            localStorage.setItem('shipsData', JSON.stringify(ships));
            localStorage.setItem('activities', JSON.stringify(activities));
            localStorage.setItem('lastSync', new Date().toISOString());
            localStorage.setItem('dataVersion', dataVersion.toString());
            localStorage.setItem('archivedShips', JSON.stringify(archived));
            console.log(`Data saved. Version: ${dataVersion}, Ships: ${ships.length}, Archived: ${archived.length}`);
        }

        function syncData() {
            const lastSync = localStorage.getItem('lastSync');
            const localSync = sessionStorage.getItem('localSync');
            if (lastSync !== localSync) {
                loadData();
                renderShips();
                updateStats();
                sessionStorage.setItem('localSync', lastSync);
            }
        }

        function resetAllData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים ולאפס את המערכת?')) {
                localStorage.clear();
                sessionStorage.clear();
                ships = [];
                activities = [];
                renderShips();
                updateStats();
                updateActivities();
                showToast('המערכת אופסה בהצלחה', 'success');
                addActivity('איפוס מערכת', 'כל הנתונים נמחקו');
            }
        }

        function confirmReset() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = 'אישור איפוס מערכת';
            body.innerHTML = `
                <div style="text-align: center; padding: var(--spacing-lg);">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" style="margin-bottom: var(--spacing-lg);">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <path d="M12 9v4m0 4h.01"/>
                    </svg>
                    <h3 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">אזהרה: פעולה זו בלתי הפיכה!</h3>
                    <p style="margin-bottom: var(--spacing-xl); color: var(--text-secondary);">
                        כל הנתונים במערכת יימחקו לצמיתות:<br>
                        • כל האניות<br>
                        • כל המשימות<br>
                        • כל ההיסטוריה<br>
                        • כל ההגדרות
                    </p>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: center;">
                        <button class="btn btn-danger" onclick="resetAllData(); closeModal();">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            </svg>
                            מחק הכל
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // ==================== Rendering ====================
        let expandedShipId = null;

        function renderShips() {
            console.log('renderShips called. currentTab:', currentTab);

            // FIX: If we're in quick view, call renderQuickView instead
            if (currentTab === 'quick') {
                console.log('Redirecting to renderQuickView');
                return renderQuickView();
            }

            const grid = document.getElementById('shipsGrid');
            grid.style.display = 'block';

            const filtered = filterShips();

            updateBadges();

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M2 21l2-7h16l2 7M4 14V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10"/>
                            <path d="M12 2v12"/>
                        </svg>
                        <div class="empty-title">אין אניות להצגה</div>
                        <div class="empty-text">${ships.length === 0 ? 'לא נטענו אניות עדיין' : 'לא נמצאו אניות בסטטוס זה'}</div>
                        <button class="btn btn-primary" onclick="importExcel()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/>
                            </svg>
                            ייבא דוח Excel
                        </button>
                    </div>
                `;
                return;
            }

            // Render hybrid table view
            grid.innerHTML = renderShipsTable(filtered);
        }

        function renderShipsTable(ships) {
            return `
                <div class="ships-table-view">
                    <table class="ships-table">
                        <thead>
                            <tr>
                                <th style="width: 220px;">אנייה</th>
                                <th style="width: 100px;">סטטוס</th>
                                <th style="width: 120px;">ETA</th>
                                <th style="width: 130px;">משימות</th>
                                <th style="width: 120px;">מטען</th>
                                <th style="width: 100px;">נמל</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ships.map(ship => renderShipTableRow(ship)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderShipTableRow(ship) {
            const urgency = getShipUrgency(ship);
            const etaDays = calculateDaysUntilETA(ship.eta);
            const tasks = ship.tasks || [];
            const doneTasks = tasks.filter(t => t.status === 'done').length;
            const totalTasks = tasks.length;
            const taskPercent = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
            const isExpanded = expandedShipId === ship.id;

            return `
                <tr class="ship-row ${urgency}" onclick="toggleShipExpanded('${ship.id}')">
                    <td>
                        <div class="table-ship-name">
                            <button class="table-expand-btn ${isExpanded ? 'expanded' : ''}" onclick="event.stopPropagation(); toggleShipExpanded('${ship.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                            <div class="table-ship-info">
                                <span class="table-ship-title">${ship.name}</span>
                                ${ship.voyage ? `<span class="table-ship-voyage">${ship.voyage}</span>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="table-status ${getStatusClass(ship.status)}">${getStatusText(ship.status)}</span>
                    </td>
                    <td>
                        <div class="table-eta">
                            <span class="table-eta-date">${ship.eta ? formatEtaDate(ship.eta) : '-'}</span>
                            ${etaDays !== null ? `<span class="table-eta-days ${etaDays <= 1 ? 'urgent' : etaDays <= 3 ? 'warning' : ''}">${formatEtaDays(etaDays)}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="table-tasks">
                            <div class="table-tasks-bar">
                                <div class="table-tasks-progress" style="width: ${taskPercent}%"></div>
                            </div>
                            <span class="table-tasks-text">${doneTasks}/${totalTasks}</span>
                        </div>
                    </td>
                    <td>${ship.cargo || '-'}</td>
                    <td>${ship.port || '-'}</td>
                    <td><div class="table-urgency ${urgency}"></div></td>
                </tr>
                <tr class="ship-expanded-row ${isExpanded ? 'active' : ''}" id="expanded-${ship.id}">
                    <td colspan="7">
                        <div class="ship-expanded-content">
                            ${renderExpandedContent(ship)}
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderExpandedContent(ship) {
            const tasks = ship.tasks || [];
            const doneTasks = tasks.filter(t => t.status === 'done');
            const pendingTasks = tasks.filter(t => t.status !== 'done');
            const cargoItems = ship.cargoBreakdown || [];

            return `
                <div class="expanded-grid">
                    <div class="expanded-section">
                        <div class="expanded-section-title">פרטי הפלגה</div>
                        <div class="expanded-item">
                            <span class="expanded-label">מס' מסע</span>
                            <span class="expanded-value">${ship.voyage || '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">נמל יעד</span>
                            <span class="expanded-value">${ship.port || '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">ETA</span>
                            <span class="expanded-value">${ship.eta ? new Date(ship.eta).toLocaleString('he-IL') : '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">ETB</span>
                            <span class="expanded-value">${ship.expected_berth_time ? new Date(ship.expected_berth_time).toLocaleString('he-IL') : '-'}</span>
                        </div>
                    </div>
                    <div class="expanded-section">
                        <div class="expanded-section-title">בעלי עניין</div>
                        <div class="expanded-item">
                            <span class="expanded-label">בעלים</span>
                            <span class="expanded-value">${ship.owner || '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">ספק</span>
                            <span class="expanded-value">${ship.supplier || '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">מקבלים</span>
                            <span class="expanded-value">${ship.receivers || '-'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">סוכן</span>
                            <span class="expanded-value">${ship.agent || '-'}</span>
                        </div>
                    </div>
                    <div class="expanded-section expanded-tasks-section">
                        <div class="expanded-section-title">משימות (${doneTasks.length}/${tasks.length})</div>
                        ${tasks.slice(0, 6).map(task => `
                            <div class="expanded-task-item ${task.status}" onclick="event.stopPropagation(); toggleTaskFromDashboard('${ship.id}', '${task.key}')" title="לחץ לשנות סטטוס">
                                <span class="task-checkbox ${task.status}">
                                    ${task.status === 'done' ? '✓' : task.status === 'in-progress' ? '◐' : ''}
                                </span>
                                <span class="task-label ${task.status === 'done' ? 'done' : ''}">${task.title}</span>
                            </div>
                        `).join('')}
                        ${tasks.length > 6 ? `<div class="expanded-task-more" onclick="event.stopPropagation(); openShipDetails(ships.find(s => s.id === '${ship.id}'))">+${tasks.length - 6} נוספות...</div>` : ''}
                    </div>
                    <div class="expanded-section">
                        <div class="expanded-section-title">שירותים</div>
                        <div class="expanded-item">
                            <span class="expanded-label">מים</span>
                            <span class="expanded-value">${ship.waterSupply ? `כן (${ship.waterAmount || '?'} טון)` : 'לא'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">חבילות</span>
                            <span class="expanded-value">${ship.package ? `כן (${ship.packageWeight || '?'} ק"ג)` : 'לא'}</span>
                        </div>
                        <div class="expanded-item">
                            <span class="expanded-label">מס' מעקב</span>
                            <span class="expanded-value">${ship.trackingNumber || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- Cargo Breakdown Section -->
                <div class="cargo-breakdown-section">
                    <div class="cargo-breakdown-header">
                        <div class="cargo-breakdown-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                            פירוט מטען
                        </div>
                        <button class="cargo-save-btn" onclick="event.stopPropagation(); saveShipCargo('${ship.id}')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            שמור
                        </button>
                    </div>

                    <div class="cargo-parse-area">
                        <textarea id="cargoParseText-${ship.id}" placeholder="הדבק טקסט מ-BL / מניפסט / אימייל לניתוח אוטומטי..."></textarea>
                        <button class="cargo-parse-btn" onclick="event.stopPropagation(); parseCargoText('${ship.id}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            נתח אוטומטית
                        </button>
                    </div>

                    <div class="cargo-table-container">
                        <table class="cargo-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%">סוג מטען</th>
                                    <th style="width: 20%">כמות (יח')</th>
                                    <th style="width: 25%">משקל (MT)</th>
                                    <th style="width: 15%"></th>
                                </tr>
                            </thead>
                            <tbody id="cargoTableBody-${ship.id}">
                                ${renderCargoTableRows(ship.id, cargoItems)}
                            </tbody>
                        </table>
                        <div class="cargo-add-row" onclick="event.stopPropagation(); addCargoRow('${ship.id}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            הוסף סוג מטען
                        </div>
                    </div>

                    ${renderCargoSummary(cargoItems)}
                </div>

                <!-- Ship Images Section -->
                <div class="expanded-images-section">
                    <div class="expanded-images-header">
                        <span class="expanded-section-title" style="margin: 0;">תמונות</span>
                        <button class="expanded-images-upload" onclick="event.stopPropagation(); openShipImageUpload('${ship.id}', '${ship.name}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            העלה
                        </button>
                    </div>
                    <div class="expanded-images-grid" id="shipImagesGrid-${ship.id}">
                        <!-- Images loaded dynamically -->
                    </div>
                </div>

                <!-- Reports Section -->
                <div class="reports-section">
                    <div class="reports-section-header">
                        <div class="reports-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            דוחות הפלגה
                        </div>
                    </div>
                    <div class="reports-buttons">
                        <button class="report-btn" onclick="event.stopPropagation(); generateReport('${ship.id}', 'sof')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            דוח עובדות (SOF)
                        </button>
                        <button class="report-btn" onclick="event.stopPropagation(); generateReport('${ship.id}', 'operational')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20V10"/>
                                <path d="M18 20V4"/>
                                <path d="M6 20v-4"/>
                            </svg>
                            דוח תפעולי
                        </button>
                        <button class="report-btn" onclick="event.stopPropagation(); generateReport('${ship.id}', 'general')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            דוח כללי
                        </button>
                    </div>
                </div>

                <div class="expanded-actions">
                    <button onclick="event.stopPropagation(); openShipDetails(ships.find(s => s.id === '${ship.id}'))">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        ערוך פרטים
                    </button>
                    <button onclick="event.stopPropagation(); openEmailNotifyModal('${ship.id}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        שלח עדכון
                    </button>
                    <button class="primary" onclick="event.stopPropagation(); selectShipForDischarge('${ship.id}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        מעקב פריקה
                    </button>
                </div>
            `;
        }

        function toggleShipExpanded(shipId) {
            if (expandedShipId === shipId) {
                expandedShipId = null;
            } else {
                expandedShipId = shipId;
            }
            renderShips();

            // Load images for expanded ship
            if (expandedShipId) {
                const ship = ships.find(s => s.id === expandedShipId);
                if (ship) {
                    loadShipImages(expandedShipId, ship.name);
                }
            }
        }

        async function loadShipImages(shipId, vesselName) {
            const grid = document.getElementById(`shipImagesGrid-${shipId}`);
            if (!grid) return;

            try {
                // Query gallery for images of this vessel
                const snapshot = await db.collection('gallery')
                    .where('vesselName', '==', vesselName)
                    .orderBy('uploadedAt', 'desc')
                    .limit(6)
                    .get();

                const images = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (images.length === 0) {
                    grid.innerHTML = `
                        <div class="expanded-images-empty">
                            אין תמונות לאנייה זו. לחץ "העלה" להוספת תמונה.
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = images.slice(0, 5).map(img => `
                    <div class="expanded-image-item" onclick="event.stopPropagation(); openLightbox('${img.id}')" title="${img.imageType || 'תמונה'}">
                        <img src="${img.imageUrl}" alt="${img.imageType || 'תמונה'}" loading="lazy">
                    </div>
                `).join('');

                // Add "more" button if there are more images
                if (images.length > 5) {
                    grid.innerHTML += `
                        <div class="expanded-images-more" onclick="event.stopPropagation(); viewAllShipImages('${vesselName}')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <span>+${images.length - 5} עוד</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading ship images:', error);
                grid.innerHTML = `
                    <div class="expanded-images-empty">
                        לא הצלחנו לטעון תמונות
                    </div>
                `;
            }
        }

        // ======================== REPORTS MODULE ========================
        function generateReport(shipId, reportType) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) {
                showToast('אנייה לא נמצאה', 'error');
                return;
            }

            let reportContent = '';
            let reportTitle = '';

            switch (reportType) {
                case 'sof':
                    reportContent = generateSOFReport(ship);
                    reportTitle = 'Statement of Facts (SOF)';
                    break;
                case 'operational':
                    reportContent = generateOperationalReport(ship);
                    reportTitle = 'דוח תפעולי';
                    break;
                case 'general':
                    reportContent = generateGeneralReport(ship);
                    reportTitle = 'דוח כללי';
                    break;
            }

            showReportModal(reportTitle, reportContent, ship.name);
        }

        function generateSOFReport(ship) {
            const formatDate = (dateStr) => {
                if (!dateStr) return '________________';
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' +
                       d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            };

            const cargoTotal = (ship.cargoBreakdown || []).reduce((sum, c) => sum + (c.weight || 0), 0);
            const cargoQty = (ship.cargoBreakdown || []).reduce((sum, c) => sum + (c.quantity || 0), 0);

            return `
                <div class="report-header">
                    <h1>STATEMENT OF FACTS</h1>
                    <h2>M/V ${ship.name || '________________'}</h2>
                </div>

                <div class="report-section-title">Vessel Particulars</div>
                <table class="report-table">
                    <tr>
                        <th>Vessel Name</th>
                        <td>${ship.name || '-'}</td>
                        <th>Flag</th>
                        <td>${ship.flag || '-'}</td>
                    </tr>
                    <tr>
                        <th>IMO Number</th>
                        <td>${ship.imoNumber || '-'}</td>
                        <th>Voyage No.</th>
                        <td>${ship.voyageNumber || '-'}</td>
                    </tr>
                    <tr>
                        <th>LOA</th>
                        <td>${ship.loa || '-'} m</td>
                        <th>Draft</th>
                        <td>${ship.draft || '-'} m</td>
                    </tr>
                </table>

                <div class="report-section-title">Port Information</div>
                <table class="report-table">
                    <tr>
                        <th>Port</th>
                        <td>${ship.port || 'Ashdod'}</td>
                        <th>Berth</th>
                        <td>${ship.berth || '-'}</td>
                    </tr>
                    <tr>
                        <th>Agent</th>
                        <td colspan="3">${ship.agent || '-'}</td>
                    </tr>
                </table>

                <div class="report-section-title">Time Log</div>
                <table class="report-table">
                    <tr>
                        <th>Event</th>
                        <th>Date / Time</th>
                    </tr>
                    <tr>
                        <td>NOR Tendered</td>
                        <td>${formatDate(ship.norTendered)}</td>
                    </tr>
                    <tr>
                        <td>NOR Accepted</td>
                        <td>${formatDate(ship.norAccepted)}</td>
                    </tr>
                    <tr>
                        <td>Arrived at Anchorage (ETA)</td>
                        <td>${formatDate(ship.eta)}</td>
                    </tr>
                    <tr>
                        <td>All Fast (ETB)</td>
                        <td>${formatDate(ship.etb)}</td>
                    </tr>
                    <tr>
                        <td>Commenced Discharge</td>
                        <td>${formatDate(ship.commencedDischarge)}</td>
                    </tr>
                    <tr>
                        <td>Completed Discharge</td>
                        <td>${formatDate(ship.completedDischarge)}</td>
                    </tr>
                    <tr>
                        <td>Sailed (ETD/ETS)</td>
                        <td>${formatDate(ship.etd || ship.ets)}</td>
                    </tr>
                </table>

                <div class="report-section-title">Cargo Details</div>
                <table class="report-table">
                    <tr>
                        <th>Cargo Type</th>
                        <th>Quantity</th>
                        <th>Weight (MT)</th>
                    </tr>
                    ${(ship.cargoBreakdown || []).map(c => `
                        <tr>
                            <td>${c.type || '-'}</td>
                            <td>${c.quantity?.toLocaleString() || '-'}</td>
                            <td>${c.weight?.toLocaleString() || '-'}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="3">No cargo data</td></tr>'}
                    <tr style="font-weight: bold; background: #e8e8e8;">
                        <td>TOTAL</td>
                        <td>${cargoQty.toLocaleString()}</td>
                        <td>${cargoTotal.toLocaleString()} MT</td>
                    </tr>
                </table>

                <div class="report-section-title">Remarks</div>
                <div style="border: 1px solid #333; padding: 15px; min-height: 100px;">
                    ${ship.remarks || 'No remarks'}
                </div>

                <div class="report-signature">
                    <div class="report-signature-box">
                        <div class="report-signature-line">Master</div>
                    </div>
                    <div class="report-signature-box">
                        <div class="report-signature-line">Agent</div>
                    </div>
                </div>

                <div class="report-footer">
                    Generated: ${new Date().toLocaleString('en-GB')}
                </div>
            `;
        }

        function generateOperationalReport(ship) {
            const formatDateHeb = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                       d.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            };

            const tasks = ship.tasks || [];
            const completedTasks = tasks.filter(t => t.status === 'done');
            const pendingTasks = tasks.filter(t => t.status !== 'done');

            const cargoTotal = (ship.cargoBreakdown || []).reduce((sum, c) => sum + (c.weight || 0), 0);

            return `
                <div class="report-preview rtl">
                    <div class="report-header">
                        <h1>דוח תפעולי</h1>
                        <h2>${ship.name || '________________'}</h2>
                    </div>

                    <div class="report-section-title">פרטי אנייה</div>
                    <div class="report-row">
                        <span class="report-row-label">שם אנייה:</span>
                        <span>${ship.name || '-'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">מספר IMO:</span>
                        <span>${ship.imoNumber || '-'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">מספר הפלגה:</span>
                        <span>${ship.voyageNumber || '-'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">נמל יעד:</span>
                        <span>${ship.port || 'אשדוד'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">רציף:</span>
                        <span>${ship.berth || '-'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">סטטוס נוכחי:</span>
                        <span style="font-weight: bold; color: ${getStatusColor(ship.status)}">${translateStatus(ship.status)}</span>
                    </div>

                    <div class="report-section-title">זמנים</div>
                    <div class="report-row">
                        <span class="report-row-label">ETA (הגעה צפויה):</span>
                        <span>${formatDateHeb(ship.eta)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">ETB (עגינה):</span>
                        <span>${formatDateHeb(ship.etb)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">ETD/ETS (הפלגה):</span>
                        <span>${formatDateHeb(ship.etd || ship.ets)}</span>
                    </div>

                    <div class="report-section-title">פירוט מטען</div>
                    <table class="report-table">
                        <tr>
                            <th>סוג מטען</th>
                            <th>כמות (יח')</th>
                            <th>משקל (MT)</th>
                        </tr>
                        ${(ship.cargoBreakdown || []).map(c => `
                            <tr>
                                <td>${c.type || '-'}</td>
                                <td>${c.quantity?.toLocaleString() || '-'}</td>
                                <td>${c.weight?.toLocaleString() || '-'}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="3">אין נתוני מטען</td></tr>'}
                        <tr style="font-weight: bold; background: #e8e8e8;">
                            <td>סה"כ</td>
                            <td></td>
                            <td>${cargoTotal.toLocaleString()} MT</td>
                        </tr>
                    </table>

                    <div class="report-section-title">שירותים</div>
                    <div class="report-row">
                        <span class="report-row-label">מים:</span>
                        <span>${ship.waterSupply ? `כן (${ship.waterAmount || '?'} טון)` : 'לא'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">חבילות:</span>
                        <span>${ship.package ? `כן (${ship.packageWeight || '?'} ק"ג)` : 'לא'}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-row-label">מספר מעקב:</span>
                        <span>${ship.trackingNumber || '-'}</span>
                    </div>

                    <div class="report-section-title">משימות (${completedTasks.length}/${tasks.length})</div>
                    <table class="report-table">
                        <tr>
                            <th>משימה</th>
                            <th>סטטוס</th>
                        </tr>
                        ${tasks.map(t => `
                            <tr>
                                <td>${t.title}</td>
                                <td style="color: ${t.status === 'done' ? 'green' : t.status === 'in-progress' ? 'orange' : 'gray'}">
                                    ${t.status === 'done' ? '✓ בוצע' : t.status === 'in-progress' ? '◐ בתהליך' : '○ ממתין'}
                                </td>
                            </tr>
                        `).join('')}
                    </table>

                    <div class="report-section-title">הערות</div>
                    <div style="border: 1px solid #333; padding: 15px; min-height: 60px;">
                        ${ship.remarks || 'אין הערות'}
                    </div>

                    <div class="report-footer">
                        הופק: ${new Date().toLocaleString('he-IL')}
                    </div>
                </div>
            `;
        }

        function generateGeneralReport(ship) {
            const formatDateHeb = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            const cargoTotal = (ship.cargoBreakdown || []).reduce((sum, c) => sum + (c.weight || 0), 0);
            const cargoTypes = (ship.cargoBreakdown || []).map(c => c.type).filter(Boolean).join(', ') || '-';

            return `
                <div class="report-preview rtl">
                    <div class="report-header">
                        <h1>דוח כללי</h1>
                        <h2>${ship.name || '________________'}</h2>
                    </div>

                    <div class="report-section-title">סיכום הפלגה</div>

                    <table class="report-table">
                        <tr>
                            <th style="width: 30%">פרט</th>
                            <th>ערך</th>
                        </tr>
                        <tr>
                            <td>שם אנייה</td>
                            <td>${ship.name || '-'}</td>
                        </tr>
                        <tr>
                            <td>מספר הפלגה</td>
                            <td>${ship.voyageNumber || '-'}</td>
                        </tr>
                        <tr>
                            <td>נמל מוצא</td>
                            <td>${ship.origin || '-'}</td>
                        </tr>
                        <tr>
                            <td>נמל יעד</td>
                            <td>${ship.port || 'אשדוד'}</td>
                        </tr>
                        <tr>
                            <td>תאריך הגעה</td>
                            <td>${formatDateHeb(ship.eta)}</td>
                        </tr>
                        <tr>
                            <td>תאריך עגינה</td>
                            <td>${formatDateHeb(ship.etb)}</td>
                        </tr>
                        <tr>
                            <td>תאריך הפלגה</td>
                            <td>${formatDateHeb(ship.etd || ship.ets)}</td>
                        </tr>
                        <tr>
                            <td>סוגי מטען</td>
                            <td>${cargoTypes}</td>
                        </tr>
                        <tr>
                            <td>סה"כ משקל מטען</td>
                            <td>${cargoTotal.toLocaleString()} MT</td>
                        </tr>
                        <tr>
                            <td>ספק</td>
                            <td>${ship.supplier || '-'}</td>
                        </tr>
                        <tr>
                            <td>מקבלים</td>
                            <td>${ship.receivers || '-'}</td>
                        </tr>
                        <tr>
                            <td>סוכן</td>
                            <td>${ship.agent || '-'}</td>
                        </tr>
                        <tr>
                            <td>סטטוס</td>
                            <td>${translateStatus(ship.status)}</td>
                        </tr>
                    </table>

                    ${ship.remarks ? `
                        <div class="report-section-title">הערות</div>
                        <div style="border: 1px solid #333; padding: 15px;">
                            ${ship.remarks}
                        </div>
                    ` : ''}

                    <div class="report-footer">
                        הופק: ${new Date().toLocaleString('he-IL')}
                    </div>
                </div>
            `;
        }

        function translateStatus(status) {
            const statusMap = {
                'nominated': 'נומינציה',
                'loading': 'בטעינה',
                'en-route': 'בדרך',
                'at-anchor': 'בעוגן',
                'berthed': 'ברציף',
                'working': 'בפריקה',
                'sailed': 'הפליגה',
                'completed': 'הושלם'
            };
            return statusMap[status] || status || '-';
        }

        function getStatusColor(status) {
            const colors = {
                'nominated': '#9CA3AF',
                'loading': '#F59E0B',
                'en-route': '#3B82F6',
                'at-anchor': '#8B5CF6',
                'berthed': '#10B981',
                'working': '#EF4444',
                'sailed': '#6B7280',
                'completed': '#059669'
            };
            return colors[status] || '#9CA3AF';
        }

        function showReportModal(title, content, vesselName) {
            const modalHtml = `
                <div class="report-modal-overlay" id="reportModalOverlay" onclick="closeReportModal(event)">
                    <div class="report-modal" onclick="event.stopPropagation()">
                        <div class="report-modal-header">
                            <div class="report-modal-title">${title} - ${vesselName}</div>
                            <div class="report-modal-actions">
                                <button class="report-btn" onclick="printReport()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 6 2 18 2 18 9"/>
                                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                                        <rect x="6" y="14" width="12" height="8"/>
                                    </svg>
                                    הדפס
                                </button>
                                <button class="report-modal-close" onclick="closeReportModal()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="report-modal-content">
                            <div class="report-preview" id="reportPreviewContent">
                                ${content}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeReportModal(event) {
            if (event && event.target.id !== 'reportModalOverlay') return;
            const modal = document.getElementById('reportModalOverlay');
            if (modal) modal.remove();
        }

        function printReport() {
            const content = document.getElementById('reportPreviewContent');
            if (!content) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Report</title>
                    <style>
                        body {
                            font-family: 'Times New Roman', serif;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        .rtl { direction: rtl; font-family: 'David', 'Heebo', serif; }
                        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .report-header h1 { font-size: 24px; margin: 0 0 10px 0; text-transform: uppercase; }
                        .report-header h2 { font-size: 18px; margin: 0; font-weight: normal; }
                        .report-section-title { font-size: 14px; font-weight: bold; margin: 20px 0 10px 0; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .report-table th, .report-table td { border: 1px solid #333; padding: 8px 12px; text-align: left; }
                        .report-table th { background: #f0f0f0; font-weight: bold; }
                        .report-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dotted #ccc; }
                        .report-row-label { font-weight: bold; }
                        .report-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 12px; color: #666; }
                        .report-signature { margin-top: 60px; display: flex; justify-content: space-between; }
                        .report-signature-box { text-align: center; width: 200px; }
                        .report-signature-line { border-top: 1px solid #333; margin-top: 50px; padding-top: 5px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${content.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function openShipImageUpload(shipId, vesselName) {
            document.getElementById('modalTitle').textContent = `העלאת תמונה - ${vesselName}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; gap: 16px;">
                    <div class="form-group">
                        <label>אנייה</label>
                        <input type="text" id="shipUploadVesselName" value="${vesselName}" readonly
                            style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-hover); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>סוג תמונה</label>
                        <select id="shipUploadImageType" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="מעמסה">מעמסה (Hold)</option>
                            <option value="מסמך">מסמך</option>
                            <option value="נזק">נזק/ליקוי</option>
                            <option value="מטען">מטען</option>
                            <option value="כללי">כללי</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>תיאור (אופציונלי)</label>
                        <input type="text" id="shipUploadDescription" placeholder="תיאור התמונה"
                            style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>בחר תמונה</label>
                        <div style="border: 2px dashed var(--glass-border); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer;"
                             onclick="document.getElementById('shipUploadFileInput').click()"
                             id="shipUploadDropZone">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">לחץ לבחירת תמונה</p>
                        </div>
                        <input type="file" id="shipUploadFileInput" accept="image/*" style="display: none;" onchange="handleShipImageSelect(event)">
                        <div id="shipUploadPreview" style="margin-top: 12px; display: none;">
                            <img id="shipUploadPreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeModal()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                            ביטול
                        </button>
                        <button onclick="uploadShipImage('${shipId}', '${vesselName}')" id="shipUploadBtn" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; cursor: pointer; font-weight: 600;">
                            העלה
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        let shipSelectedImageBase64 = null;

        function handleShipImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showToast('הקובץ גדול מדי (מקסימום 10MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                shipSelectedImageBase64 = e.target.result;
                document.getElementById('shipUploadPreview').style.display = 'block';
                document.getElementById('shipUploadPreviewImg').src = e.target.result;
                document.getElementById('shipUploadDropZone').style.borderColor = 'var(--success)';
            };
            reader.readAsDataURL(file);
        }

        async function uploadShipImage(shipId, vesselName) {
            if (!shipSelectedImageBase64) {
                showToast('נא לבחור תמונה', 'warning');
                return;
            }

            const btn = document.getElementById('shipUploadBtn');
            btn.disabled = true;
            btn.textContent = 'מעלה...';

            try {
                const imageData = {
                    vesselName: vesselName,
                    shipId: shipId,
                    imageType: document.getElementById('shipUploadImageType').value,
                    description: document.getElementById('shipUploadDescription').value.trim(),
                    imageUrl: shipSelectedImageBase64,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('gallery').add(imageData);

                closeModal();
                shipSelectedImageBase64 = null;

                // Reload images in expanded row
                loadShipImages(shipId, vesselName);

                showToast('התמונה הועלתה בהצלחה!', 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showToast('שגיאה בהעלאה', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'העלה';
            }
        }

        function viewAllShipImages(vesselName) {
            // Switch to gallery view with search filter
            switchToGalleryView();
            setTimeout(() => {
                const searchInput = document.getElementById('gallerySearch');
                if (searchInput) {
                    searchInput.value = vesselName;
                    filterGallery();
                }
            }, 100);
        }

        // ======================== CARGO BREAKDOWN FUNCTIONS ========================

        const cargoColors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
        ];

        function getCargoTypeOptions(selectedValue = '') {
            const options = referenceData.cargo.map(cargo =>
                `<option value="${cargo.name}" ${cargo.name === selectedValue ? 'selected' : ''}>${cargo.name}</option>`
            ).join('');
            return `<option value="">בחר מטען...</option>${options}`;
        }

        function renderCargoTableRows(shipId, cargoItems) {
            if (!cargoItems || cargoItems.length === 0) {
                return `
                    <tr>
                        <td colspan="4" class="cargo-empty">
                            אין פירוט מטען. הדבק טקסט לניתוח או הוסף ידנית.
                        </td>
                    </tr>
                `;
            }

            return cargoItems.map((item, idx) => `
                <tr data-cargo-index="${idx}">
                    <td>
                        <div class="cargo-autocomplete-wrapper">
                            <input type="text" class="cargo-autocomplete-input"
                                id="cargoInput-${shipId}-${idx}"
                                value="${item.type || ''}"
                                placeholder="חפש סוג מטען..."
                                oninput="filterCargoSuggestions('${shipId}', ${idx}, this.value)"
                                onfocus="showCargoSuggestions('${shipId}', ${idx})"
                                onblur="setTimeout(() => hideCargoSuggestions('${shipId}', ${idx}), 200)"
                                onclick="event.stopPropagation()"
                                autocomplete="off">
                            <div class="cargo-autocomplete-list" id="cargoList-${shipId}-${idx}"></div>
                        </div>
                    </td>
                    <td>
                        <input type="number" value="${item.quantity || ''}" placeholder="0"
                            onchange="updateCargoItem('${shipId}', ${idx}, 'quantity', this.value)"
                            onclick="event.stopPropagation()">
                    </td>
                    <td>
                        <input type="number" step="0.001" value="${item.weight || ''}" placeholder="0"
                            onchange="updateCargoItem('${shipId}', ${idx}, 'weight', this.value)"
                            onclick="event.stopPropagation()">
                    </td>
                    <td>
                        <button class="cargo-delete-btn" onclick="event.stopPropagation(); removeCargoRow('${shipId}', ${idx})" title="מחק">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderCargoSummary(cargoItems) {
            if (!cargoItems || cargoItems.length === 0) {
                return '';
            }

            const totalQuantity = cargoItems.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
            const totalWeight = cargoItems.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);

            // Generate percentage bars
            const percentBars = cargoItems.map((item, idx) => {
                const percent = totalWeight > 0 ? ((parseFloat(item.weight) || 0) / totalWeight * 100) : 0;
                if (percent < 5) return '';
                const color = cargoColors[idx % cargoColors.length];
                const shortName = (item.type || 'N/A').split(' ').slice(-1)[0].substring(0, 8);
                return `<div class="cargo-percent-bar" style="width: ${percent}%; background: ${color};" title="${item.type}: ${percent.toFixed(1)}%">${shortName}</div>`;
            }).filter(b => b).join('');

            return `
                <div class="cargo-summary">
                    <div class="cargo-totals">
                        <div class="cargo-total-item">
                            <div class="cargo-total-value">${totalQuantity.toLocaleString()}</div>
                            <div class="cargo-total-label">יחידות</div>
                        </div>
                        <div class="cargo-total-item">
                            <div class="cargo-total-value">${totalWeight.toLocaleString()}</div>
                            <div class="cargo-total-label">MT</div>
                        </div>
                    </div>
                    <div class="cargo-percentages">
                        ${percentBars}
                    </div>
                </div>
            `;
        }

        function addCargoRow(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            if (!ship.cargoBreakdown) ship.cargoBreakdown = [];
            ship.cargoBreakdown.push({ type: '', quantity: 0, weight: 0 });

            refreshCargoTable(shipId);
        }

        function removeCargoRow(shipId, index) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.cargoBreakdown) return;

            ship.cargoBreakdown.splice(index, 1);
            refreshCargoTable(shipId);
        }

        function updateCargoItem(shipId, index, field, value) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.cargoBreakdown || !ship.cargoBreakdown[index]) return;

            if (field === 'quantity' || field === 'weight') {
                ship.cargoBreakdown[index][field] = parseFloat(value) || 0;
            } else {
                ship.cargoBreakdown[index][field] = value;
            }

            // Update summary without re-rendering the whole table
            const section = document.querySelector(`#cargoTableBody-${shipId}`).closest('.cargo-breakdown-section');
            const existingSummary = section.querySelector('.cargo-summary');
            const newSummaryHtml = renderCargoSummary(ship.cargoBreakdown);

            if (existingSummary) {
                existingSummary.outerHTML = newSummaryHtml;
            } else if (newSummaryHtml) {
                section.insertAdjacentHTML('beforeend', newSummaryHtml);
            }
        }

        function refreshCargoTable(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const tbody = document.getElementById(`cargoTableBody-${shipId}`);
            if (tbody) {
                tbody.innerHTML = renderCargoTableRows(shipId, ship.cargoBreakdown || []);
            }

            // Update summary
            const section = tbody.closest('.cargo-breakdown-section');
            const existingSummary = section.querySelector('.cargo-summary');
            const newSummaryHtml = renderCargoSummary(ship.cargoBreakdown || []);

            if (existingSummary) {
                existingSummary.outerHTML = newSummaryHtml || '<div></div>';
            } else if (newSummaryHtml) {
                section.insertAdjacentHTML('beforeend', newSummaryHtml);
            }
        }

        async function parseCargoText(shipId) {
            const textarea = document.getElementById(`cargoParseText-${shipId}`);
            const text = textarea?.value?.trim();

            if (!text) {
                showToast('נא להזין טקסט לניתוח', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            // Build cargo types list for the prompt
            const cargoTypesList = referenceData.cargo.map(c => c.name).join(', ');

            showToast('מנתח מטען...', 'info');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parseType: 'cargo',
                        content: text,
                        cargoTypes: cargoTypesList
                    })
                });

                if (!response.ok) throw new Error('API error');

                const result = await response.json();

                // API returns { success, parsed } where parsed contains the cargo data
                const parsedData = result.parsed || result;
                const cargoData = parsedData.cargo || [];

                if (cargoData.length > 0) {
                    // Merge with existing or replace
                    ship.cargoBreakdown = cargoData.map(item => ({
                        type: matchCargoType(item.type || item.name),
                        quantity: parseFloat(item.quantity) || 0,
                        weight: parseFloat(item.weight) || 0
                    }));

                    refreshCargoTable(shipId);
                    textarea.value = '';
                    showToast(`נמצאו ${cargoData.length} סוגי מטען`, 'success');
                } else {
                    // Fallback to local parsing
                    const localResult = parseCargoLocally(text);
                    if (localResult.length > 0) {
                        ship.cargoBreakdown = localResult;
                        refreshCargoTable(shipId);
                        textarea.value = '';
                        showToast(`נמצאו ${localResult.length} סוגי מטען (ניתוח מקומי)`, 'success');
                    } else {
                        showToast('לא נמצאו פרטי מטען בטקסט', 'warning');
                    }
                }
            } catch (error) {
                console.error('Cargo parse error:', error);
                // Fallback to local parsing
                const localResult = parseCargoLocally(text);
                if (localResult.length > 0) {
                    ship.cargoBreakdown = localResult;
                    refreshCargoTable(shipId);
                    textarea.value = '';
                    showToast(`נמצאו ${localResult.length} סוגי מטען`, 'success');
                } else {
                    showToast('לא הצלחנו לנתח את הטקסט', 'error');
                }
            }
        }

        function matchCargoType(inputType) {
            if (!inputType) return '';
            const input = inputType.toLowerCase().trim();

            // Try exact match first
            const exactMatch = referenceData.cargo.find(c => c.name.toLowerCase() === input);
            if (exactMatch) return exactMatch.name;

            // Try partial match
            const partialMatch = referenceData.cargo.find(c =>
                c.name.toLowerCase().includes(input) || input.includes(c.name.toLowerCase())
            );
            if (partialMatch) return partialMatch.name;

            // Return original if no match
            return inputType;
        }

        function parseCargoLocally(text) {
            const results = [];
            const lines = text.split(/[\n,;]/);

            // Patterns to match: "Steel Wire Rods 1500 pcs 8500 MT" or "8500 MT Steel Wire Rods"
            const patterns = [
                // Pattern: Type Qty Unit Weight Unit
                /([A-Za-z\s]+?)\s+(\d+[\d,\.]*)\s*(?:pcs|pieces|units|יח|יחידות)?\s*[\-–]?\s*(\d+[\d,\.]*)\s*(?:MT|tons?|טון)/gi,
                // Pattern: Weight MT Type
                /(\d+[\d,\.]*)\s*(?:MT|tons?|טון)\s+([A-Za-z\s]+)/gi,
                // Pattern: Type: Weight MT
                /([A-Za-z\s]+?)[\s:]+(\d+[\d,\.]*)\s*(?:MT|tons?|טון)/gi
            ];

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // Check each cargo type
                for (const cargo of referenceData.cargo) {
                    if (trimmed.toLowerCase().includes(cargo.name.toLowerCase())) {
                        // Try to extract numbers
                        const numbers = trimmed.match(/\d+[\d,\.]*/g) || [];
                        const parsedNumbers = numbers.map(n => parseFloat(n.replace(/,/g, '')));

                        // Heuristic: larger number is weight, smaller is quantity
                        let weight = 0, quantity = 0;
                        if (parsedNumbers.length >= 2) {
                            weight = Math.max(...parsedNumbers);
                            quantity = Math.min(...parsedNumbers);
                        } else if (parsedNumbers.length === 1) {
                            weight = parsedNumbers[0];
                        }

                        // Avoid duplicates
                        if (!results.find(r => r.type === cargo.name)) {
                            results.push({
                                type: cargo.name,
                                quantity: quantity,
                                weight: weight
                            });
                        }
                        break;
                    }
                }
            }

            return results;
        }

        async function saveShipCargo(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            try {
                // Update cargo field with summary
                const cargoSummary = (ship.cargoBreakdown || [])
                    .filter(c => c.type)
                    .map(c => c.type)
                    .join(', ');

                await db.collection("ships").doc(shipId).update({
                    cargoBreakdown: ship.cargoBreakdown || [],
                    cargo: cargoSummary,
                    updatedAt: new Date().toISOString()
                });

                showToast('פירוט המטען נשמר בהצלחה', 'success');
            } catch (error) {
                console.error('Error saving cargo:', error);
                showToast('שגיאה בשמירת המטען', 'error');
            }
        }

        // Cargo Autocomplete Functions
        function showCargoSuggestions(shipId, index) {
            filterCargoSuggestions(shipId, index, document.getElementById(`cargoInput-${shipId}-${index}`).value);
        }

        function hideCargoSuggestions(shipId, index) {
            const list = document.getElementById(`cargoList-${shipId}-${index}`);
            if (list) list.classList.remove('active');
        }

        function filterCargoSuggestions(shipId, index, searchText) {
            const list = document.getElementById(`cargoList-${shipId}-${index}`);
            if (!list) return;

            const search = searchText.toLowerCase().trim();
            const filtered = referenceData.cargo.filter(c =>
                c.name.toLowerCase().includes(search)
            ).slice(0, 10); // Limit to 10 suggestions

            if (filtered.length === 0 && search.length > 0) {
                // Allow custom entry
                list.innerHTML = `
                    <div class="cargo-autocomplete-item" onclick="selectCargoSuggestion('${shipId}', ${index}, '${searchText}')">
                        <span style="opacity: 0.7">הוסף: </span>"${searchText}"
                    </div>
                `;
            } else {
                list.innerHTML = filtered.map(cargo => {
                    // Highlight matching text
                    const name = cargo.name;
                    const matchIdx = name.toLowerCase().indexOf(search);
                    let displayName = name;
                    if (matchIdx >= 0 && search.length > 0) {
                        displayName = name.substring(0, matchIdx) +
                            `<span class="cargo-match">${name.substring(matchIdx, matchIdx + search.length)}</span>` +
                            name.substring(matchIdx + search.length);
                    }
                    return `
                        <div class="cargo-autocomplete-item" onclick="selectCargoSuggestion('${shipId}', ${index}, '${cargo.name}')">
                            ${displayName}
                        </div>
                    `;
                }).join('');
            }

            list.classList.add('active');
        }

        function selectCargoSuggestion(shipId, index, cargoName) {
            const input = document.getElementById(`cargoInput-${shipId}-${index}`);
            if (input) {
                input.value = cargoName;
            }
            hideCargoSuggestions(shipId, index);
            updateCargoItem(shipId, index, 'type', cargoName);
        }

        // ======================== END CARGO BREAKDOWN FUNCTIONS ========================

        function calculateDaysUntilETA(eta) {
            if (!eta) return null;
            const now = new Date();
            const etaDate = new Date(eta);
            if (isNaN(etaDate.getTime())) return null;
            return Math.ceil((etaDate - now) / (1000 * 60 * 60 * 24));
        }

        function formatEtaDays(days) {
            if (days <= 0) return 'היום!';
            if (days <= 1) return 'מחר';
            return `${Math.round(days)} ימים`;
        }

        function formatEtaDate(eta) {
            if (!eta) return '-';
            const etaDate = new Date(eta);
            if (isNaN(etaDate.getTime())) return '-';

            const currentYear = new Date().getFullYear();
            const etaYear = etaDate.getFullYear();

            // If different year, show year too
            if (etaYear !== currentYear) {
                return etaDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: '2-digit'});
            }
            return etaDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit'});
        }

        function getShipUrgency(ship) {
            const etaDays = calculateDaysUntilETA(ship.eta);
            if (ship.status === STATUS.SAILED) return 'normal';
            if (etaDays !== null && etaDays <= 1) return 'urgent';
            if (etaDays !== null && etaDays <= 3) return 'warning';
            return 'success';
        }

        function selectShipForDischarge(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                switchToDischargeView();
                setTimeout(() => {
                    const selector = document.getElementById('dischargeShipSelect');
                    if (selector) {
                        selector.value = shipId;
                        loadShipDischargeData();
                    }
                }, 100);
            }
        }

        function renderQuickView() {
            const grid = document.getElementById('shipsGrid');
            grid.style.display = 'block';

            const sailedShips = ships
                .filter(s => s.status === STATUS.SAILED)
                .sort((a, b) => a.name.localeCompare(b.name)); // אניות שהפליגו נשארות בסדר אלפביתי

            const activeShips = ships
                .filter(s => s.status !== STATUS.SAILED)
                .sort((a, b) => {
                    const priorityA = getSortPriority(a.status);
                    const priorityB = getSortPriority(b.status);
                    
                    if (priorityA !== priorityB) {
                        return priorityA - priorityB; // 1. מיין לפי עדיפות הסטטוס
                    }
                    
                    // 2. אם הסטטוס זהה, מיין לפי ETA (המוקדם ראשון)
                    // התייחס ל-ETA חסר כתאריך רחוק מאוד כדי שיופיע בסוף
                    const etaA = a.eta ? new Date(a.eta) : new Date('9999-12-31');
                    const etaB = b.eta ? new Date(b.eta) : new Date('9999-12-31');
                    
                    return etaA - etaB;
                });

            let finalHtml = '<div class="quick-view-container">';

            // --- Group Active Ships by Status ---
            const underOperationShips = activeShips.filter(s => s.status === STATUS.UNDER_OPERATION);
            const atPortShips = activeShips.filter(s => s.status === STATUS.AT_PORT);
            const atSeaShips = activeShips.filter(s => s.status === STATUS.AT_SEA);

            const activeTasks = PRE_ARRIVAL.map(task => task.title);

            // --- Table for Under Operation Ships ---
            if (underOperationShips.length > 0) {
                finalHtml += `
                    <h4 class="quick-view-title">אניות בפריקה</h4>
                    <div class="quick-view-table">
                    <div class="quick-view-header">
                            <div class="ship-details-header">אנייה</div>
                            <div class="tasks-header">
                                ${activeTasks.map(title => `<span>${title}</span>`).join('')}
                            </div>
                            </div>
                        <div class="quick-view-body">
                            ${underOperationShips.map(ship => {
                                const taskMap = new Map((ship.tasks || []).map(t => [t.key, t]));
                                return `
                                <div class="ship-row" id="ship-row-${ship.id}">
                                    <div class="ship-main-info-compact">
                                        <div class="ship-details-compact">
                                            <span class="ship-name-quick-view">${ship.name}</span>
                                            <span class="ship-status-compact ${getStatusClass(ship.status)}">${getStatusText(ship.status)}</span>
                                            <span class="quick-view-port">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                                ${ship.port || '-'}
                                            </span>
                            </div>
                                        <div class="task-dots-container">
                                            ${PRE_ARRIVAL.map(task => `<div class="task-dot ${taskMap.get(task.key)?.status || 'pending'}" onclick="cycleTaskStatus(event, '${ship.id}', '${task.key}')"></div>`).join('')}
                        </div>
                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            // --- Table for At Port Ships ---
            if (atPortShips.length > 0) {
                finalHtml += `
                    <h4 class="quick-view-title" style="margin-top: var(--spacing-xl);">אניות על עוגן</h4>
                    <div class="quick-view-table">
                        <div class="quick-view-header">
                            <div class="ship-details-header">אנייה</div>
                            <div class="tasks-header">
                                ${activeTasks.map(title => `<span>${title}</span>`).join('')}
                            </div>
                        </div>
                        <div class="quick-view-body">
                            ${atPortShips.map(ship => {
                                const taskMap = new Map((ship.tasks || []).map(t => [t.key, t]));
                                return `
                                <div class="ship-row" id="ship-row-${ship.id}">
                                    <div class="ship-main-info-compact">
                                        <div class="ship-details-compact">
                                            <span class="ship-name-quick-view">${ship.name}</span>
                                            <span class="ship-status-compact ${getStatusClass(ship.status)}">${getStatusText(ship.status)}</span>
                                            <span class="quick-view-port">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                                ${ship.port || '-'}
                                            </span>
                                        </div>
                                        <div class="task-dots-container">
                                            ${PRE_ARRIVAL.map(task => `<div class="task-dot ${taskMap.get(task.key)?.status || 'pending'}" onclick="cycleTaskStatus(event, '${ship.id}', '${task.key}')"></div>`).join('')}
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            // --- Table for At Sea Ships ---
            if (atSeaShips.length > 0) {
                finalHtml += `
                    <h4 class="quick-view-title" style="margin-top: var(--spacing-xl);">אניות בדרך</h4>
                    <div class="quick-view-table">
                        <div class="quick-view-header">
                            <div class="ship-details-header">אנייה</div>
                            <div class="tasks-header">
                                ${activeTasks.map(title => `<span>${title}</span>`).join('')}
                        </div>
                        </div>
                        <div class="quick-view-body">
                            ${atSeaShips.map(ship => {
                                const taskMap = new Map((ship.tasks || []).map(t => [t.key, t]));
                                return `
                                <div class="ship-row" id="ship-row-${ship.id}">
                                    <div class="ship-main-info-compact">
                                        <div class="ship-details-compact">
                                            <span class="ship-name-quick-view">${ship.name}</span>
                                            <span class="ship-status-compact ${getStatusClass(ship.status)}">${getStatusText(ship.status)}</span>
                                            <span class="quick-view-port">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                                ${ship.port || '-'}
                                            </span>
                                        </div>
                                        <div class="task-dots-container">
                                            ${PRE_ARRIVAL.map(task => `<div class="task-dot ${taskMap.get(task.key)?.status || 'pending'}" onclick="cycleTaskStatus(event, '${ship.id}', '${task.key}')"></div>`).join('')}
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            // --- Table for Sailed Ships ---
            if (sailedShips.length > 0) {
                const sailedTasks = POST_SAILED.map(task => task.title);
                finalHtml += `
                    <h4 class="quick-view-title" style="margin-top: var(--spacing-xl);">אניות שהפליגו</h4>
                    <div class="quick-view-table">
                        <div class="quick-view-header">
                            <div class="ship-details-header">אנייה</div>
                            <div class="tasks-header sailed-tasks">
                                ${sailedTasks.map(title => `<span>${title}</span>`).join('')}
                            </div>
                        </div>
                        <div class="quick-view-body">
                             ${sailedShips.map(ship => {
                                const taskMap = new Map((ship.tasks || []).map(t => [t.key, t]));
                                return `
                                <div class="ship-row" id="ship-row-${ship.id}">
                                    <div class="ship-main-info-compact">
                                        <div class="ship-details-compact">
                                            <span class="ship-name-quick-view">${ship.name}</span>
                                            <span class="ship-status-compact ${getStatusClass(ship.status)}">${getStatusText(ship.status)}</span>
                                            <span class="quick-view-port">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                                ${ship.port || '-'}
                                            </span>
                                        </div>
                                        <div class="task-dots-container sailed-tasks">
                                            ${POST_SAILED.map(task => `<div class="task-dot ${taskMap.get(task.key)?.status || 'pending'}" onclick="cycleTaskStatus(event, '${ship.id}', '${task.key}')"></div>`).join('')}
                                        </div>
                                    </div>
                                </div>`;
                    }).join('')}
                        </div>
                    </div>`;
            }

            if (activeShips.length === 0 && sailedShips.length === 0) {
                finalHtml += `<div class="empty-state" style="padding: var(--spacing-2xl); text-align: center;">אין אניות להצגה בתצוגה מהירה.</div>`;
            }

            finalHtml += '</div>'; // close .quick-view-container
            grid.innerHTML = finalHtml;
            document.getElementById('quickBadge').textContent = activeShips.length + sailedShips.length;
        }

        function cycleTaskStatus(event, shipId, taskKey) {
            // מניעת הפעלת הרחבת השורה
            event.stopPropagation();
            
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const task = ship.tasks.find(t => t.key === taskKey);
            if (!task) return;

            // שינוי הסטטוס במעגל: pending -> in-progress -> done -> pending
            const statusCycle = ['pending', 'in-progress', 'done'];
            const currentIndex = statusCycle.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            task.status = statusCycle[nextIndex];
            
            // עדכון פרטי המשימה
            task.lastUpdatedAt = new Date().toISOString();
            if (task.status === 'done') {
                task.doneAt = new Date().toISOString();
                task.doneBy = currentUser;
            } else {
                task.doneAt = null;
                task.doneBy = null;
            }

            // עדכון ל-Firestore
            db.collection("ships").doc(ship.id).update({ 
                tasks: ship.tasks, 
                updatedAt: new Date().toISOString() 
            }).then(() => {
                // toast הוסר לבקשת המשתמש
            }).catch(e => console.error(e));
            
            // הוספת פעילות
            const statusText = task.status === 'pending' ? 'ממתין' : 
                              task.status === 'in-progress' ? 'בטיפול' : 'הושלם';
            addActivity('עדכון משימה', `שינוי סטטוס משימה: ${task.title} לאנייה: ${ship.name} - ${statusText}`);
            
            // בדוק אם כל משימות ההפלגה הושלמו
            checkPostSailedTasksComplete(ship);
        }

        async function toggleTaskFromDashboard(shipId, taskKey) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.tasks) return;

            const task = ship.tasks.find(t => t.key === taskKey);
            if (!task) return;

            // Cycle status: pending -> in-progress -> done -> pending
            const statusCycle = ['pending', 'in-progress', 'done'];
            const currentIndex = statusCycle.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            task.status = statusCycle[nextIndex];

            // Update task details
            task.lastUpdatedAt = new Date().toISOString();
            if (task.status === 'done') {
                task.doneAt = new Date().toISOString();
                task.doneBy = currentUser;
            } else {
                task.doneAt = null;
                task.doneBy = null;
            }

            // Update UI immediately
            const expandedRow = document.getElementById(`expanded-${shipId}`);
            if (expandedRow) {
                const taskItem = expandedRow.querySelector(`[onclick*="${taskKey}"]`);
                if (taskItem) {
                    taskItem.className = `expanded-task-item ${task.status}`;
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    const label = taskItem.querySelector('.task-label');
                    if (checkbox) {
                        checkbox.className = `task-checkbox ${task.status}`;
                        checkbox.textContent = task.status === 'done' ? '✓' : task.status === 'in-progress' ? '◐' : '';
                    }
                    if (label) {
                        label.className = `task-label ${task.status === 'done' ? 'done' : ''}`;
                    }
                }
                // Update task count in header
                const header = expandedRow.querySelector('.expanded-section-title');
                if (header && header.textContent.includes('משימות')) {
                    const doneTasks = ship.tasks.filter(t => t.status === 'done').length;
                    header.textContent = `משימות (${doneTasks}/${ship.tasks.length})`;
                }
            }

            // Save to Firestore
            try {
                await db.collection("ships").doc(shipId).update({
                    tasks: ship.tasks,
                    updatedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating task:', error);
                showToast('שגיאה בעדכון משימה', 'error');
            }

            // Add activity
            const statusText = task.status === 'pending' ? 'ממתין' :
                              task.status === 'in-progress' ? 'בטיפול' : 'הושלם';
            addActivity('עדכון משימה', `${task.title} - ${ship.name}: ${statusText}`);
        }

        function toggleShipDetails(shipId) {
            const shipRow = document.getElementById('ship-row-' + shipId);
            if (!shipRow) return;
            
            // הוספה או הסרה של class expanded
            shipRow.classList.toggle('expanded');
        }

        function filterShips(){
            // 1. בצע סינון בסיסי לפי הטאב הנבחר
            let base = currentTab === 'all' ? ships.slice()
                        : currentTab === 'quick' ? ships.slice() // FIX: quick view shows all ships
                        : ships.filter(s => {
                            const map = {'at-sea':STATUS.AT_SEA, 'at-port':STATUS.AT_PORT, 'under-operation':STATUS.UNDER_OPERATION, 'sailed':STATUS.SAILED};
                            return s.status === map[currentTab];
                        });

            // 2. בצע סינון נוסף לפי החיפוש החכם (אם יש)
            if (currentSearchTerm) {
                base = base.filter(ship => {
                    const term = currentSearchTerm;
                    
                    // המרת תאריכים למחרוזת כדי שיהיו ניתנים לחיפוש
                    const etaString = formatDate(ship.eta).toLowerCase();
                    const etbString = (ship.etb && ship.etb.displayValue) ? ship.etb.displayValue.toLowerCase() : '';

                    return (
                        (ship.name && ship.name.toLowerCase().includes(term)) ||
                        (ship.cargo && ship.cargo.toLowerCase().includes(term)) ||
                        (ship.pic && ship.pic.toLowerCase().includes(term)) || // 'pic' הוא שדה הסוכן (Agent)
                        (etaString.includes(term)) ||
                        (etbString.includes(term))
                    );
                });
            }
            
            // סדר לפי STATUS_UI_ORDER, ואז תתי-כללים
            base.sort((a,b)=>{
                const so = STATUS_UI_ORDER.indexOf(a.status) - STATUS_UI_ORDER.indexOf(b.status);
                if (so!==0) return so;
                if (a.status===STATUS.AT_SEA) return new Date(a.eta)-new Date(b.eta);
                if (a.status===STATUS.UNDER_OPERATION) return (new Date(a.expected_finish_time||'9999') - new Date(b.expected_finish_time||'9999'));
                if (a.status===STATUS.AT_PORT) return (new Date(a.expected_berth_time||a.eta||'9999') - new Date(b.expected_berth_time||b.eta||'9999'));
                return 0; // SAILED: השאר
            });
            
            return base;
        }

        function createShipCard(ship) {
            const urgency = calculateUrgency(ship);
            const progress = calculateProgress(ship);
            const allTasks = ship.tasks || [];
            const pendingTasks = allTasks.filter(t => t.status !== 'done').length;
            
            // Build service indicators HTML from the new services array
            let serviceIndicatorsHtml = '';
            const activeServices = ship.services || [];
            // Filter active services (not completed or cancelled)
            const pendingServices = activeServices.filter(s => s.status !== 'completed' && s.status !== 'cancelled');
            
            if (pendingServices.some(s => s.type === 'water')) {
                const waterService = pendingServices.find(s => s.type === 'water');
                serviceIndicatorsHtml += `
                    <div class="indicator-item water">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        <span>מים (${waterService?.details?.amount || '?'})</span>
                    </div>`;
            }
            if (pendingServices.some(s => s.type === 'package')) {
                const packageCount = pendingServices.filter(s => s.type === 'package').length;
                serviceIndicatorsHtml += `
                    <div class="indicator-item package">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="M16.5 9.4 7.55 4.24"/><path d="M3.29 7 12 12l8.71-5"/><path d="m12 22 8.71-5"/><circle cx="18" cy="15" r="3"/><path d="M20.6 17.5 22 19"/></svg>
                        <span>חבילה (${packageCount})</span>
                    </div>`;
            }
            
            return `
                <div class="ship-card ${urgency} card-${getStatusClass(ship.status)}" id="${ship.id}">
                    <div class="ship-header">
                        <div class="ship-title">
                            <div>
                                <div class="ship-name">${ship.name}</div>
                                <div class="ship-voyage">${ship.voyage || ''}</div>
                            </div>
                            <div class="ship-status ${getStatusClass(ship.status)}">
                                ${getStatusText(ship.status)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="ship-body">
                        ${serviceIndicatorsHtml ? `<div class="service-indicators">${serviceIndicatorsHtml}</div>` : ''}
                        <div class="ship-info-grid">
                            <div class="info-item">
                                <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                <div>
                                    <span class="info-label">נמל פריקה</span>
                                <span class="info-value">${ship.port || '-'}</span>
                            </div>
                            </div>
                            <div class="info-item">
                                <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                                <div>
                                    <span class="info-label">ETA</span>
                                <span class="info-value">${formatDate(ship.eta)}</span>
                            </div>
                            </div>
                            <div class="info-item">
                               <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                <div>
                                    <span class="info-label">ETB</span>
                                    <span class="info-value">${(ship.etb && ship.etb.displayValue) ? ship.etb.displayValue : formatETBDate(ship.expected_berth_time)}</span>
                            </div>
                            </div>
                        </div>

                        <div class="progress-container">
                            <div class="progress-header">
                                <span class="progress-label">התקדמות משימות</span>
                                <span class="progress-value">${allTasks.length - pendingTasks} / ${allTasks.length} הושלמו</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="quick-actions">
                            <div class="trader-toggle">
                                <button class="toggle-btn ${ship.trader_flag === 'M' ? 'active' : ''}" onclick="setTraderFlag('${ship.id}', 'M', event)">M</button>
                                <button class="toggle-btn ${ship.trader_flag === 'D' ? 'active' : ''}" onclick="setTraderFlag('${ship.id}', 'D', event)">D</button>
                                <button class="toggle-btn ${!ship.trader_flag || ship.trader_flag === 'X' ? 'active' : ''}" onclick="setTraderFlag('${ship.id}', 'X', event)">X</button>
                            </div>
                            <button class="quick-action" onclick="editShip('${ship.id}')">
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                <span>עריכה</span>
                            </button>
                            <button class="quick-action" onclick="openTasks('${ship.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                                <span>משימות</span>
                            </button>
                            <button class="quick-action" onclick="openServices('${ship.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                <span>שירותים</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateUrgency(ship) {
            const now = new Date();
            const eta = new Date(ship.eta);
            const days = Math.ceil((eta - now) / (1000 * 60 * 60 * 24));
            
            const urgentTasks = ship.checklist.filter(t => 
                !t.completed && 
                t.daysBefore && 
                days <= t.daysBefore &&
                t.statuses.includes(ship.status)
            );
            
            if (urgentTasks.length > 0) {
                if (days <= 1) return 'urgent';
                if (days <= 3) return 'warning';
            }
            return 'success';
        }

        function getStatusClass(status) {
            return 'status-' + status.toLowerCase().replace(' ', '-');
        }

        function calculateProgress(ship) {
            const t = ship.tasks || [];
            if (!t.length) return 0;
            const done = t.filter(x => x.done).length;
            return Math.round((done / t.length) * 100);
        }

        // ==================== File System Sync ====================
        let fileHandle = null;





        let archived = JSON.parse(localStorage.getItem('archivedShips')||'[]');

        function daysUntil(dateISO){
            const now = new Date();
            const d = new Date(dateISO);
            return Math.ceil((d - now) / (1000*60*60*24));
        }

        function taskUrgency(task, ship){
            const eta = ship.eta;
            if (!eta) return ''; // אין ETA -> לא צובע (אפשר 'warning' אם תרצה)
            const n = daysUntil(eta);

            switch(task.due){
                case 'eta_minus_days:3': return n < 0 ? 'urgent' : (n <= 3 ? (n<=1?'urgent':'warning') : '');
                case 'eta_minus_days:2': return n < 0 ? 'urgent' : (n <= 2 ? (n<=1?'urgent':'warning') : '');
                case 'at_sea_window':     return (ship.status===STATUS.AT_SEA && n<=7) ? 'warning' : '';
                case 'prefer_at_sea':     return (ship.status===STATUS.AT_PORT && task.status !== 'done') ? 'warning' : '';
                case 'must_before_discharge':
                    return (ship.status===STATUS.UNDER_OPERATION && task.status !== 'done') ? 'urgent' : '';
                case 'day0_to_day1':      return (ship.status===STATUS.SAILED) ? 'warning' : '';
                default: return '';
            }
        }

        function getPendingTasks(ship){
            return (ship.tasks||[]).filter(t=>t.status !== 'done');
        }

        function calculateUrgency(ship){
            // אם יש משימה דחופה → 'urgent', אם יש אזהרה → 'warning', אחרת 'success'
            const pend = getPendingTasks(ship);
            if (pend.some(t=>taskUrgency(t,ship)==='urgent')) return 'urgent';
            if (pend.some(t=>taskUrgency(t,ship)==='warning')) return 'warning';
            return 'success';
        }

        function getStatusClass(status) {
            return 'status-' + status.toLowerCase().replace(' ', '-');
        }

        function getStatusText(status) {
            const map = {
                'At Sea': 'בדרך',
                'At Port': 'על עוגן',
                'Under Operation': 'בפריקה',
                'Sailed': 'הפליגה'
            };
            return map[status] || status;
        }

        function getSortPriority(status) {
            switch (status) {
                case STATUS.UNDER_OPERATION: return 1;
                case STATUS.AT_PORT: return 2;
                case STATUS.AT_SEA: return 3;
                default: return 99; // אניות שהפליגו או סטטוס אחר יגיעו לסוף
            }
        }

        function formatDate(date) {
            if (!date) return '-';
            
            try {
            const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                
                return d.toLocaleDateString('he-IL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }) + ' ' + d.toLocaleTimeString('he-IL', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            } catch (e) {
                console.error('Error formatting date:', date, e);
                return '-';
            }
        }

        function formatETBDate(date) {
            if (!date) return '-';
            
            // אם זה כבר מחרוזת עם פורמט מיוחד, החזר כפי שזה
            if (typeof date === 'string') {
                // בדוק אם זה מכיל מילות מפתח של משמרות או טווחים
                if (date.includes('משמרת') || date.includes('בין') || date.includes('ל-') || 
                    date.includes('/') || date.includes('א') || date.includes('ב') || date.includes('ג')) {
                    return date;
                }
                
                // אם זה תאריך בפורמט ISO, נסה לפרסר אותו
                if (date.includes('T') || date.includes('-')) {
                    try {
                        const d = new Date(date);
                        if (!isNaN(d.getTime())) {
                            return d.toLocaleDateString('he-IL', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        }
                    } catch (e) {
                        // אם הפירסור נכשל, החזר את הטקסט המקורי
                        return date;
                    }
                }
                
                // אם זה לא תאריך ISO, החזר את הטקסט המקורי
                return date;
            }
            
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return '-';
                
                // החזר רק תאריך ללא שעה
                return d.toLocaleDateString('he-IL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                console.error('Error formatting ETB date:', date, e);
                return '-';
            }
        }

        // ==================== UI Actions ====================
        function switchTab(tab, btn) {
            // FIX: Handle the 'quick' view tab separately
            if (tab === 'quick') {
                // Find the sidebar nav item for quick view and activate it
                document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('.nav-menu .nav-item:last-of-type').classList.add('active');
                return switchToQuickView();
            }

            // Keep original logic for all other dashboard tabs
            switchToDashboardView();
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderShips();
        }

        function switchToDashboardView() {
            // הסר 'active' מכל כפתורי הניווט הראשי
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // הוסף 'active' לכפתור "לוח בקרה"
            document.querySelector('.nav-menu .nav-item:first-child').classList.add('active');

            // הצג את הטאבים והסטטיסטיקות
            document.querySelector('.tabs').style.display = 'flex';
            document.querySelector('.stats-grid').style.display = 'grid';

            // הסתר את תצוגות אחרות והצג את הגריד
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('shipsGrid').style.display = 'grid';

            currentTab = 'all'; // אפס לטאב "כל האניות"
            // אפס את כפתורי הטאבים למצב ברירת מחדל
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tabs .tab:first-child').classList.add('active');

            renderShips(); // רנדר מחדש את תצוגת הקלפים
            
            // פוקוס אוטומטי על שדה החיפוש
            const searchInput = document.getElementById('smartSearchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }

        function switchToQuickView() {
            // הסר 'active' מכל כפתורי הניווט הראשי
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // הוסף 'active' לכפתור "מבט מהיר"
            document.querySelectorAll('.nav-menu .nav-item')[2].classList.add('active');

            // הסתר את הטאבים והסטטיסטיקות שאינם רלוונטיים
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            // הסתר את תצוגות אחרות והצג את הגריד
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('shipsGrid').style.display = 'grid';

            currentTab = 'quick'; // עדכן את המצב הנוכחי
            renderQuickView(); // רנדר את תצוגת "מבט מהיר"
        }

        function switchToParserView() {
            // הסר 'active' מכל כפתורי הניווט הראשי
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // הוסף 'active' לכפתור "ניתוח הודעות"
            document.querySelectorAll('.nav-menu .nav-item')[3].classList.add('active');

            // הסתר את הטאבים והסטטיסטיקות
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            // הסתר תצוגות אחרות והצג את תצוגת הפרסר
            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('emailParserView').classList.add('active');

            currentTab = 'parser';
        }

        // ==================== EMAIL PARSER MODULE (Claude AI) ====================
        let lastParsedData = null;
        const CLAUDE_ANALYZE_API = '/api/analyze';

        async function parseEmailMessage() {
            const emailText = document.getElementById('emailInput').value.trim();
            if (!emailText) {
                showToast('נא להדביק הודעה לניתוח', 'warning');
                return;
            }

            // Show loading state
            const btn = document.querySelector('.parse-btn') || document.querySelector('button[onclick*="parseEmailMessage"]');
            let originalBtnText = '';
            if (btn) {
                originalBtnText = btn.innerHTML;
                btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-left:8px;"></div> מעבד נתונים...';
                btn.disabled = true;
            }

            // Show loading in results area
            document.getElementById('parsedResult').innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                    <div class="spinner" style="width:32px;height:32px;border:3px solid var(--glass-border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
                    <p>מנתח הודעה...</p>
                </div>
            `;

            try {
                // Get existing ship names for context
                const existingShipNames = ships.map(s => s.name).filter(Boolean);

                const response = await fetch(CLAUDE_ANALYZE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parseType: 'email',
                        content: emailText,
                        existingShips: existingShipNames
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'API error');
                }

                if (data.parsed) {
                    // Convert Claude response to our format
                    const parsedData = convertClaudeResponseToShipData(data.parsed);
                    lastParsedData = parsedData;
                    displayParsedResult(parsedData);
                    showToast('ההודעה נותחה בהצלחה', 'success');
                } else if (data.raw) {
                    showToast('התקבל ניתוח אך לא בפורמט מובנה', 'warning');
                    document.getElementById('parsedResult').innerHTML = `
                        <div class="warning-message" style="background:var(--warning-glow);border:1px solid var(--warning);border-radius:8px;padding:16px;">
                            <p style="margin-bottom:8px;font-weight:600;">ניתוח גולמי:</p>
                            <pre style="white-space:pre-wrap;font-size:12px;direction:ltr;text-align:left;">${data.raw}</pre>
                        </div>
                    `;
                } else {
                    throw new Error('לא התקבלו נתונים מהניתוח');
                }
            } catch (error) {
                console.error('Claude API error:', error);
                showToast(`שגיאה בניתוח: ${error.message}`, 'error');
                document.getElementById('parsedResult').innerHTML = `
                    <div class="warning-message" style="background:var(--danger-glow);border:1px solid var(--danger);border-radius:8px;padding:16px;text-align:center;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" style="margin-bottom:8px;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <p style="font-weight:600;margin-bottom:4px;">שגיאה בניתוח</p>
                        <p style="font-size:13px;color:var(--text-secondary);">${error.message}</p>
                        <p style="font-size:12px;color:var(--text-tertiary);margin-top:8px;">נא לפנות לתמיכה טכנית</p>
                    </div>
                `;
            } finally {
                if (btn) {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                }
            }
        }

        // Message type labels in Hebrew
        const MESSAGE_TYPE_LABELS = {
            'NOMINATION': '📋 מינוי חדש',
            'ETA_UPDATE': '📍 עדכון ETA',
            'ARRIVAL_NOTICE': '⚓ הודעת הגעה',
            'BERTHING_NOTICE': '🚢 הודעת עגינה',
            'SAILING_NOTICE': '🚀 הודעת הפלגה',
            'SERVICE_REQUEST': '🔧 בקשת שירות',
            'DOCUMENTS': '📄 מסמכים',
            'DAILY_REPORT': '📊 דוח יומי',
            'CARGO_INFO': '📦 פרטי מטען',
            'DISCHARGE_REPORT': '📊 דוח פריקה',
            'BULK_UPDATE': '📊 עדכון מרובה',
            'OTHER': '📝 אחר'
        };

        // Status labels in Hebrew
        const STATUS_LABELS = {
            'NOMINATED': 'מינוי',
            'LOADING': 'בטעינה',
            'EN_ROUTE': 'בדרך',
            'AT_ANCHOR': 'על עוגן',
            'BERTHED': 'ברציף',
            'WORKING': 'עובדת',
            'SAILED': 'הפליגה'
        };

        function convertClaudeResponseToShipData(claudeData) {
            const result = {
                messageType: claudeData.messageType || 'OTHER',
                messageTypeLabel: MESSAGE_TYPE_LABELS[claudeData.messageType] || MESSAGE_TYPE_LABELS['OTHER'],
                messageTypeConfidence: claudeData.messageTypeConfidence || 0,
                match_confidence: claudeData.extractionConfidence || 0,
                identified_ship_id: null,
                matched_ship: null,
                is_new_ship: false,
                bulkVessels: [], // For BULK_UPDATE message type
                updates: {
                    name: null,
                    status: null,
                    eta: null,
                    etb: null,
                    etd: null,
                    ets: null,
                    port: null,
                    originPort: null,
                    cargo: null,
                    services_to_add: [],
                    notes_delta: null,
                    owner: null,
                    charterer: null,
                    voyageNumber: null
                },
                dates: {
                    eta: null,
                    etb: null,
                    etd: null,
                    ets: null
                },
                uncertainty_note: null,
                contacts: [],
                parties: {},
                rawClaudeData: claudeData
            };

            // Map vessel name
            if (claudeData.vesselName) {
                result.updates.name = claudeData.vesselName.toUpperCase();

                // Try to match with existing ships
                const matchedShip = findMatchingShip(claudeData.vesselName);
                if (matchedShip) {
                    result.matched_ship = matchedShip;
                    result.identified_ship_id = matchedShip.id;
                    result.match_confidence = Math.max(result.match_confidence, 0.9);
                } else {
                    result.is_new_ship = true;
                }
            }

            // Map voyage number
            if (claudeData.voyageNumber) {
                result.updates.voyageNumber = claudeData.voyageNumber;
            }

            // Map dates with new structure
            if (claudeData.dates) {
                ['eta', 'etb', 'etd', 'ets'].forEach(dateType => {
                    if (claudeData.dates[dateType] && claudeData.dates[dateType].iso) {
                        result.dates[dateType] = {
                            iso: claudeData.dates[dateType].iso,
                            original: claudeData.dates[dateType].original,
                            confidence: claudeData.dates[dateType].confidence || 0
                        };
                        result.updates[dateType] = claudeData.dates[dateType].iso;
                    }
                });
            }

            // Map ports
            if (claudeData.ports) {
                if (claudeData.ports.destination) {
                    result.updates.port = claudeData.ports.destination;
                }
                if (claudeData.ports.origin) {
                    result.updates.originPort = claudeData.ports.origin;
                }
            }

            // Map status
            if (claudeData.status && claudeData.status.current) {
                result.updates.status = STATUS_LABELS[claudeData.status.current] || claudeData.status.statusText;
            }

            // Map cargo
            if (claudeData.cargo && claudeData.cargo.types && claudeData.cargo.types.length > 0) {
                result.updates.cargo = {
                    types: claudeData.cargo.types,
                    totalWeight: claudeData.cargo.totalWeight,
                    totalQuantity: claudeData.cargo.totalQuantity,
                    blNumbers: claudeData.cargo.blNumbers || [],
                    hasTelex: claudeData.cargo.hasTelex || false
                };
            }

            // Map services
            if (claudeData.services && claudeData.services.requested) {
                const serviceTypeMap = {
                    'WATER': 'מים מתוקים',
                    'BUNKER': 'דלק',
                    'CREW_CHANGE': 'החלפת צוות',
                    'PROVISIONS': 'ציוד ומזון',
                    'SLUDGE': 'פינוי שמנים',
                    'REPAIRS': 'תיקונים',
                    'PARCELS': 'חבילות'
                };

                claudeData.services.requested.forEach(service => {
                    const hebrewName = serviceTypeMap[service.type] || service.type;
                    const serviceEntry = {
                        name: hebrewName,
                        details: service.details,
                        quantity: service.quantity,
                        date: service.date
                    };
                    result.updates.services_to_add.push(serviceEntry);
                });
            }

            // Map parties
            if (claudeData.parties) {
                result.parties = claudeData.parties;
                if (claudeData.parties.owner) result.updates.owner = claudeData.parties.owner;
                if (claudeData.parties.charterer) result.updates.charterer = claudeData.parties.charterer;
            }

            // Map notes
            if (claudeData.notes && claudeData.notes.length > 0) {
                result.updates.notes_delta = claudeData.notes.join('\n');
            }

            // Map contacts
            if (claudeData.contacts && claudeData.contacts.length > 0) {
                result.contacts = claudeData.contacts;
            }

            // Handle bulk vessels (for BULK_UPDATE message type)
            if (claudeData.bulkVessels && claudeData.bulkVessels.length > 0) {
                result.bulkVessels = claudeData.bulkVessels.map(vessel => {
                    const matchedShip = findMatchingShip(vessel.vesselName);
                    return {
                        vesselName: vessel.vesselName?.toUpperCase() || '',
                        matchedShip: matchedShip,
                        isMatched: !!matchedShip,
                        etb: vessel.etb ? {
                            iso: vessel.etb.iso,
                            original: vessel.etb.original,
                            display: formatDateFromISO(vessel.etb.iso)
                        } : null,
                        eta: vessel.eta ? {
                            iso: vessel.eta.iso,
                            original: vessel.eta.original,
                            display: formatDateFromISO(vessel.eta.iso)
                        } : null,
                        berth: vessel.berth || null,
                        selected: true // Default selected for bulk update
                    };
                });
            }

            return result;
        }

        function extractShipData(text) {
            // Legacy function - kept for compatibility but now using Claude AI
            // This is called as fallback only
            const result = {
                match_confidence: 0,
                identified_ship_id: null,
                matched_ship: null,
                is_new_ship: false,
                updates: {
                    name: null,
                    status: null,
                    eta: null,
                    etb: null,
                    etd: null,
                    port: null,
                    cargo: null,
                    services_to_add: [],
                    notes_delta: null
                },
                uncertainty_note: 'נא להשתמש בניתוח Claude AI לתוצאות טובות יותר'
            };
            return result;
        }

        function extractVesselName(text) {
            // Common patterns for vessel names
            const patterns = [
                /(?:M\/?V|MV|m\.v\.|mv)[\s.:]*["']?([A-Z][A-Za-z\s\-\.]+?)["']?(?:\s*\/|\s*$|\s*\n|\s*<)/i,
                /(?:vessel|ship|from)[\s:]+["']?([A-Z][A-Za-z\s\-\.]+?)["']?(?:\s*\/|\s*$|\s*\n)/i,
                /Subject:.*?(?:M\/?V|MV|m\.v\.|VESSEL)[\s.:]*["']?([A-Z][A-Za-z\s\-\.]+?)["']?/i,
                /^(?:M\/?V|MV|m\.v\.|VESSEL)[\s.:]*["']?([A-Z][A-Za-z\s\-\.]+?)["']?/im,
                /VESSEL[\s:]+["']?([A-Z][A-Za-z\s\-\.]+?)["']?(?:\s*\/|\s*$|\s*\n|\s*,)/i,
                /(?:RE|FW|Fwd)[\s:]+.*?(?:M\/?V|MV|VESSEL)[\s.:]*["']?([A-Z][A-Za-z\s\-\.]+?)["']?/i
            ];

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    // Clean up the name
                    let name = match[1].trim()
                        .replace(/\s+/g, ' ')
                        .replace(/[<>]/g, '')
                        .replace(/\s*\/\s*$/, '')
                        .replace(/\s*Msg.*$/i, '')
                        .trim();

                    // Validate it looks like a ship name
                    if (name.length >= 3 && name.length <= 50 && /^[A-Za-z]/.test(name)) {
                        return name.toUpperCase();
                    }
                }
            }

            return null;
        }

        function findMatchingShip(vesselName) {
            if (!vesselName || !ships || ships.length === 0) return null;

            const normalizedSearch = vesselName.toLowerCase().replace(/[^a-z0-9]/g, '');

            // Try exact match first
            let match = ships.find(s =>
                s.name && s.name.toLowerCase().replace(/[^a-z0-9]/g, '') === normalizedSearch
            );
            if (match) return match;

            // Try partial match
            match = ships.find(s => {
                if (!s.name) return false;
                const shipName = s.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                return shipName.includes(normalizedSearch) || normalizedSearch.includes(shipName);
            });
            if (match) return match;

            // Try fuzzy match (at least 70% similarity)
            for (const ship of ships) {
                if (!ship.name) continue;
                const similarity = calculateSimilarity(
                    vesselName.toLowerCase(),
                    ship.name.toLowerCase()
                );
                if (similarity > 0.7) {
                    return ship;
                }
            }

            return null;
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const costs = [];
            for (let i = 0; i <= shorter.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= longer.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (shorter.charAt(i - 1) !== longer.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[longer.length] = lastValue;
            }

            return (longer.length - costs[longer.length]) / longer.length;
        }

        function calculateMatchConfidence(extractedName, matchedName) {
            const similarity = calculateSimilarity(
                extractedName.toLowerCase(),
                matchedName.toLowerCase()
            );
            return Math.round(similarity * 100) / 100;
        }

        function extractDates(text) {
            const result = { eta: null, etb: null, etd: null };
            const currentYear = new Date().getFullYear();

            // Patterns for different date formats
            const datePatterns = [
                // DD.MM.YYYY / HH:MM or DD/MM/YYYY HH:MM
                /(\d{1,2})[.\/](\d{1,2})[.\/](\d{2,4})[\s\/]*(?:at\s*)?(\d{1,2})[:\.](\d{2})/gi,
                // DD.MM / HH:MM (no year)
                /(\d{1,2})[.\/](\d{1,2})[\s\/]+(\d{1,2})[:\.](\d{2})/g,
                // YYYY-MM-DD HH:MM (ISO-ish)
                /(\d{4})-(\d{2})-(\d{2})[\sT](\d{2}):(\d{2})/g
            ];

            // Find ETA
            const etaMatch = text.match(/ETA[^:]*:?\s*[^\d]*(\d{1,2}[.\/]\d{1,2}[.\/]?\d{0,4}[\s\/]*(?:at\s*)?(?:\d{1,2}[:\.]?\d{2})?)/i);
            if (etaMatch) {
                const parsed = parseDateTime(etaMatch[1], currentYear);
                if (parsed) result.eta = parsed;
            }

            // Find ETB
            const etbMatch = text.match(/ETB[^:]*:?\s*[^\d]*(\d{1,2}[.\/]\d{1,2}[.\/]?\d{0,4}[\s\/]*(?:at\s*)?(?:\d{1,2}[:\.]?\d{2})?)/i);
            if (etbMatch) {
                const parsed = parseDateTime(etbMatch[1], currentYear);
                if (parsed) result.etb = parsed;
            }

            // Find ETD
            const etdMatch = text.match(/ETD[^:]*:?\s*[^\d]*(\d{1,2}[.\/]\d{1,2}[.\/]?\d{0,4}[\s\/]*(?:at\s*)?(?:\d{1,2}[:\.]?\d{2})?)/i);
            if (etdMatch) {
                const parsed = parseDateTime(etdMatch[1], currentYear);
                if (parsed) result.etd = parsed;
            }

            return result;
        }

        function parseDateTime(dateStr, defaultYear) {
            if (!dateStr) return null;

            // Clean up the string
            dateStr = dateStr.trim().replace(/\s+/g, ' ');

            // Try DD.MM.YYYY HH:MM format
            let match = dateStr.match(/(\d{1,2})[.\/](\d{1,2})[.\/](\d{2,4})[\s\/]*(?:at\s*)?(\d{1,2})[:\.](\d{2})/i);
            if (match) {
                let year = parseInt(match[3]);
                if (year < 100) year += 2000;
                const date = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]), parseInt(match[4]), parseInt(match[5]));
                return date.toISOString();
            }

            // Try DD.MM HH:MM format (no year)
            match = dateStr.match(/(\d{1,2})[.\/](\d{1,2})[\s\/]+(\d{1,2})[:\.](\d{2})/);
            if (match) {
                let year = defaultYear;
                const month = parseInt(match[2]) - 1;
                const day = parseInt(match[1]);
                // If the date is in the past, assume next year
                const testDate = new Date(year, month, day);
                if (testDate < new Date()) {
                    year++;
                }
                const date = new Date(year, month, day, parseInt(match[3]), parseInt(match[4]));
                return date.toISOString();
            }

            // Try DD.MM.YYYY format (no time)
            match = dateStr.match(/(\d{1,2})[.\/](\d{1,2})[.\/](\d{2,4})/);
            if (match) {
                let year = parseInt(match[3]);
                if (year < 100) year += 2000;
                const date = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]), 0, 0);
                return date.toISOString();
            }

            return null;
        }

        function extractPort(text) {
            const textLower = text.toLowerCase();

            // Port mapping with all variations
            const portMap = {
                // חיפה ונמליה
                'haifa': 'חיפה',
                'חיפה': 'חיפה',
                'מספנות': 'מספנות ישראל',
                'מספנות ישראל': 'מספנות ישראל',
                'israel shipyards': 'מספנות ישראל',
                'shipyards': 'מספנות ישראל',
                'נמל המפרץ': 'נמל המפרץ',
                'bay port': 'נמל המפרץ',
                'haifa bay': 'נמל המפרץ',
                // אשדוד
                'ashdod': 'אשדוד',
                'אשדוד': 'אשדוד',
                'נמל הדרום': 'נמל הדרום',
                'south port': 'נמל הדרום',
                // אחרים
                'eilat': 'אילת',
                'אילת': 'אילת',
                'ashkelon': 'אשקלון',
                'אשקלון': 'אשקלון'
            };

            // Check for port mentions (longer patterns first for better matching)
            const sortedPorts = Object.keys(portMap).sort((a, b) => b.length - a.length);

            for (const port of sortedPorts) {
                if (textLower.includes(port.toLowerCase())) {
                    return portMap[port];
                }
            }

            return null;
        }

        function determineStatus(text, dates) {
            const textLower = text.toLowerCase();

            // Check for explicit status mentions
            if (textLower.includes('sailed') || textLower.includes('departed') || textLower.includes('הפלגה')) {
                return 'Sailed';
            }
            if (textLower.includes('berthing') || textLower.includes('alongside') || textLower.includes('עוגנת')) {
                return 'At Port';
            }
            if (textLower.includes('operation') || textLower.includes('discharging') || textLower.includes('loading') ||
                textLower.includes('פריקה') || textLower.includes('טעינה')) {
                return 'Under Operation';
            }

            // Infer from dates
            if (dates.eta && !dates.etb) {
                return 'At Sea';
            }
            if (dates.etb && !dates.etd) {
                return 'At Port';
            }

            // Check for notice patterns (6 hrs notice usually means approaching)
            if (text.match(/\d+\s*(?:hrs?|hours?)\s*notice/i)) {
                return 'At Sea';
            }

            return 'At Sea'; // Default
        }

        function extractServices(text) {
            const services = [];
            const textLower = text.toLowerCase();

            // Water supply
            const waterMatch = text.match(/(\d+)\s*(?:tons?|טון|t\.?)\s*(?:of\s*)?(?:fresh\s*)?water/i) ||
                              text.match(/water[:\s]+(\d+)\s*(?:tons?|טון|t\.?)/i) ||
                              text.match(/מים[:\s]+(\d+)\s*טון/);
            if (waterMatch) {
                services.push({
                    type: 'water',
                    status: 'requested',
                    details: { amount: parseInt(waterMatch[1]) }
                });
            } else if (textLower.includes('fresh water') || textLower.includes('water supply') || textLower.includes('מים')) {
                services.push({
                    type: 'water',
                    status: 'requested',
                    details: { amount: null }
                });
            }

            // Crew change
            const crewMatch = text.match(/crew\s*(?:change)?[:\s]*(\d+)\s*(?:joining|on|נכנסים)[,\s]*(\d+)\s*(?:leaving|off|יוצאים)/i) ||
                             text.match(/(\d+)\s*(?:joining|on|נכנסים)[,\s]*(\d+)\s*(?:leaving|off|יוצאים)/i) ||
                             text.match(/חילוף\s*צוות[:\s]*(\d+)\s*נכנסים[,\s]*(\d+)\s*יוצאים/);
            if (crewMatch) {
                services.push({
                    type: 'crew_change',
                    status: 'requested',
                    details: {
                        crewIn: parseInt(crewMatch[1]),
                        crewOut: parseInt(crewMatch[2])
                    }
                });
            } else if (textLower.includes('crew change') || textLower.includes('חילוף צוות')) {
                services.push({
                    type: 'crew_change',
                    status: 'requested',
                    details: { crewIn: null, crewOut: null }
                });
            }

            // Package/Parcel
            const packageMatch = text.match(/(?:package|parcel|חבילה)[:\s]*(?:(\d+(?:\.\d+)?)\s*(?:kg|ק"ג|קג))?/i);
            if (packageMatch || textLower.includes('package') || textLower.includes('parcel') || textLower.includes('חבילה')) {
                const details = {};
                if (packageMatch && packageMatch[1]) {
                    details.weight = parseFloat(packageMatch[1]);
                }
                // Try to find tracking number
                const trackingMatch = text.match(/(?:tracking|מספר מעקב)[:\s]*([A-Z0-9]+)/i);
                if (trackingMatch) {
                    details.tracking = trackingMatch[1];
                }
                services.push({
                    type: 'package',
                    status: 'requested',
                    details: details
                });
            }

            // Sludge
            const sludgeMatch = text.match(/sludge[:\s]*(\d+)\s*(?:m3|מ"ק|cbm)/i);
            if (sludgeMatch || textLower.includes('sludge')) {
                services.push({
                    type: 'sludge',
                    status: 'requested',
                    details: { amount: sludgeMatch ? parseInt(sludgeMatch[1]) : null }
                });
            }

            // Bilge
            const bilgeMatch = text.match(/bilge[:\s]*(\d+)\s*(?:m3|מ"ק|cbm)/i);
            if (bilgeMatch || textLower.includes('bilge')) {
                services.push({
                    type: 'bilge',
                    status: 'requested',
                    details: { amount: bilgeMatch ? parseInt(bilgeMatch[1]) : null }
                });
            }

            return services;
        }

        function extractCargo(text) {
            const cargoPatterns = [
                /cargo[:\s]+([^,\n]+)/i,
                /מטען[:\s]+([^,\n]+)/,
                /loading[:\s]+([^,\n]+)/i,
                /discharging[:\s]+([^,\n]+)/i
            ];

            for (const pattern of cargoPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }

            // Common cargo types
            const cargoTypes = ['fertilizer', 'grain', 'coal', 'steel', 'cement', 'דשנים', 'תבואה', 'פחם', 'פלדה', 'מלט'];
            const textLower = text.toLowerCase();
            for (const cargo of cargoTypes) {
                if (textLower.includes(cargo.toLowerCase())) {
                    return cargo;
                }
            }

            return null;
        }

        function extractNotes(text) {
            const notes = [];

            // Master/Captain name
            const masterMatch = text.match(/(?:master|captain|capt\.?|רב חובל)[:\s]+([A-Za-z\s\.]+?)(?:\n|$|<)/i);
            if (masterMatch) {
                notes.push(`Master: ${masterMatch[1].trim()}`);
            }

            // Phone number
            const phoneMatch = text.match(/(?:mobile|phone|tel|טלפון)[:\s]*([+\d\s\-()]+)/i);
            if (phoneMatch) {
                notes.push(`Tel: ${phoneMatch[1].trim()}`);
            }

            // Notice period
            const noticeMatch = text.match(/(\d+)\s*(?:hrs?|hours?)\s*notice/i);
            if (noticeMatch) {
                notes.push(`${noticeMatch[1]} Hrs Notice`);
            }

            return notes.length > 0 ? notes.join('. ') : null;
        }

        function checkUncertainty(text) {
            const uncertaintyMarkers = [
                { pattern: /iagw|if all goes well/i, message: 'ETA מותנה ב-"אם הכל ילך כשורה"' },
                { pattern: /wp|weather permitting/i, message: 'תלוי בתנאי מזג האוויר' },
                { pattern: /approx|approximately|בערך/i, message: 'זמן משוער' },
                { pattern: /tbc|to be confirmed/i, message: 'דורש אישור' },
                { pattern: /subject to/i, message: 'כפוף לשינויים' }
            ];

            const uncertainties = [];
            for (const marker of uncertaintyMarkers) {
                if (marker.pattern.test(text)) {
                    uncertainties.push(marker.message);
                }
            }

            return uncertainties.length > 0 ? uncertainties.join(', ') : null;
        }

        function displayParsedResult(data) {
            const container = document.getElementById('parsedResult');

            // Handle BULK_UPDATE message type
            if (data.messageType === 'BULK_UPDATE' && data.bulkVessels && data.bulkVessels.length > 0) {
                displayBulkUpdateResult(data, container);
                return;
            }

            if (!data.updates.name && !data.updates.eta && data.updates.services_to_add.length === 0) {
                container.innerHTML = `
                    <div class="uncertainty-note">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        <span>לא נמצאו נתונים רלוונטיים בהודעה. נסה להדביק הודעה עם מידע על אנייה.</span>
                    </div>
                `;
                return;
            }

            let html = '';

            // Message Type Header
            if (data.messageTypeLabel) {
                html += `
                    <div class="message-type-header" style="background: linear-gradient(135deg, var(--primary-glow), transparent); border: 1px solid var(--primary); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 16px; font-weight: 600; color: var(--primary);">${data.messageTypeLabel}</span>
                        <span style="font-size: 12px; color: var(--text-secondary);">ודאות: ${Math.round((data.messageTypeConfidence || 0) * 100)}%</span>
                    </div>
                `;
            }

            // Confidence badge and new ship indicator
            const confidenceClass = data.match_confidence >= 0.8 ? 'high' : data.match_confidence >= 0.5 ? 'medium' : 'low';
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <span class="confidence-badge confidence-${confidenceClass}">
                        רמת חילוץ: ${Math.round(data.match_confidence * 100)}%
                    </span>
                    ${data.is_new_ship ? '<span class="new-ship-indicator">אנייה חדשה</span>' : ''}
                </div>
            `;

            // Ship selector
            html += `
                <div class="ship-selector">
                    <label>בחר אנייה לעדכון:</label>
                    <select id="targetShipSelect" onchange="updateApplyButtons()">
                        ${data.is_new_ship ? '<option value="new">+ הוסף אנייה חדשה</option>' : ''}
                        ${data.matched_ship ? `<option value="${data.matched_ship.id}" selected>${data.matched_ship.name}</option>` : ''}
                        ${ships.filter(s => !data.matched_ship || s.id !== data.matched_ship.id).map(s =>
                            `<option value="${s.id}">${s.name}</option>`
                        ).join('')}
                    </select>
                </div>
            `;

            // Vessel name
            if (data.updates.name) {
                html += createParsedField('שם אנייה', data.updates.name, 'name');
            }

            // Status
            if (data.updates.status) {
                // Map status to Hebrew predefined options
                const statusLower = data.updates.status.toLowerCase();
                let hebrewStatus = data.updates.status;

                if (statusLower.includes('loading') || statusLower.includes('טעינה')) {
                    hebrewStatus = 'בטעינה';
                } else if (statusLower.includes('sailing') || statusLower.includes('transit') || statusLower.includes('en route') || statusLower.includes('underway') || statusLower.includes('at sea') || statusLower.includes('בדרך')) {
                    hebrewStatus = 'בדרך';
                } else if (statusLower.includes('anchor') || statusLower.includes('waiting') || statusLower.includes('עוגן')) {
                    hebrewStatus = 'על עוגן';
                } else if (statusLower.includes('discharg') || statusLower.includes('unloading') || statusLower.includes('operation') || statusLower.includes('פריקה')) {
                    hebrewStatus = 'בפריקה';
                } else if (statusLower.includes('sailed') || statusLower.includes('departed') || statusLower.includes('הפליגה')) {
                    hebrewStatus = 'הפליגה';
                } else if (statusLower.includes('arrived') || statusLower.includes('berthed') || statusLower.includes('alongside')) {
                    hebrewStatus = 'ברציף';
                }

                html += createParsedField('סטטוס', hebrewStatus, 'status', hebrewStatus);
            }

            // Origin Port
            if (data.updates.originPort) {
                html += createParsedField('נמל טעינה', data.updates.originPort, 'originPort');
            }

            // Destination Port
            if (data.updates.port) {
                html += createParsedField('נמל יעד', data.updates.port, 'port');
            }

            // ETA with original text
            if (data.updates.eta) {
                const displayEta = formatDateFromISO(data.updates.eta);
                const originalText = data.dates?.eta?.original ? ` (${data.dates.eta.original})` : '';
                html += createParsedFieldWithOriginal('ETA', displayEta, originalText, 'eta', data.updates.eta);
            }

            // ETB with original text
            if (data.updates.etb) {
                const displayEtb = formatDateFromISO(data.updates.etb);
                const originalText = data.dates?.etb?.original ? ` (${data.dates.etb.original})` : '';
                html += createParsedFieldWithOriginal('ETB', displayEtb, originalText, 'etb', data.updates.etb);
            }

            // ETD with original text
            if (data.updates.etd) {
                const displayEtd = formatDateFromISO(data.updates.etd);
                const originalText = data.dates?.etd?.original ? ` (${data.dates.etd.original})` : '';
                html += createParsedFieldWithOriginal('ETD', displayEtd, originalText, 'etd', data.updates.etd);
            }

            // ETS with original text
            if (data.updates.ets) {
                const displayEts = formatDateFromISO(data.updates.ets);
                const originalText = data.dates?.ets?.original ? ` (${data.dates.ets.original})` : '';
                html += createParsedFieldWithOriginal('ETS', displayEts, originalText, 'ets', data.updates.ets);
            }

            // Owner
            if (data.updates.owner) {
                html += createParsedField('בעלים', data.updates.owner, 'owner');
            }

            // Charterer
            if (data.updates.charterer) {
                html += createParsedField('חוכר', data.updates.charterer, 'charterer');
            }

            // Voyage Number
            if (data.updates.voyageNumber) {
                html += createParsedField('מספר מסע', data.updates.voyageNumber, 'voyageNumber');
            }

            // Cargo
            if (data.updates.cargo) {
                html += createParsedField('מטען', data.updates.cargo, 'cargo');
            }

            // Services
            if (data.updates.services_to_add.length > 0) {
                html += `
                    <div class="parsed-field">
                        <div class="parsed-field-header">
                            <span class="parsed-field-label">שירותים נדרשים</span>
                        </div>
                        <div class="parsed-services" style="display: flex; flex-direction: column; gap: 8px;">
                            ${data.updates.services_to_add.map((service, index) => {
                                const serviceName = typeof service === 'string' ? service : service.name;
                                const serviceDetails = typeof service === 'object' ?
                                    [service.details, service.quantity, service.date].filter(Boolean).join(' | ') : '';
                                return `
                                    <div class="parsed-service-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border);">
                                        <div class="parsed-service-info">
                                            <span class="parsed-service-type" style="font-weight: 600; color: var(--text-primary);">${serviceName}</span>
                                            ${serviceDetails ? `<span class="parsed-service-details" style="font-size: 12px; color: var(--text-secondary); margin-right: 8px;">${serviceDetails}</span>` : ''}
                                        </div>
                                        <button class="parsed-field-apply" onclick="applyService(${index})" style="padding: 4px 12px; font-size: 12px;">
                                            הוסף
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Notes
            if (data.updates.notes_delta) {
                html += createParsedField('הערות חדשות', data.updates.notes_delta, 'notes');
            }

            // Uncertainty note
            if (data.uncertainty_note) {
                html += `
                    <div class="uncertainty-note">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>${data.uncertainty_note}</span>
                    </div>
                `;
            }

            // Apply all button
            html += `
                <button class="apply-all-btn" onclick="applyAllUpdates()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    החל את כל העדכונים
                </button>
            `;

            container.innerHTML = html;
        }

        // Display bulk update result for multiple vessels (port schedule, berthing list)
        function displayBulkUpdateResult(data, container) {
            const bulkVessels = data.bulkVessels || [];

            if (bulkVessels.length === 0) {
                container.innerHTML = `
                    <div class="uncertainty-note">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        <span>לא נמצאו אניות בהודעה.</span>
                    </div>
                `;
                return;
            }

            // Store bulk data globally for apply function
            window.pendingBulkUpdate = bulkVessels;

            let html = `
                <div class="message-type-header" style="background: linear-gradient(135deg, var(--success-glow), transparent); border: 1px solid var(--success); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 16px; font-weight: 600; color: var(--success);">📊 עדכון מרובה - ${bulkVessels.length} אניות</span>
                    <span style="font-size: 12px; color: var(--text-secondary);">סמן לעדכון והחל</span>
                </div>

                <div class="bulk-actions" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button onclick="toggleAllBulkVessels(true)" class="btn-outline" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass); color: var(--text-secondary); cursor: pointer;">
                        בחר הכל
                    </button>
                    <button onclick="toggleAllBulkVessels(false)" class="btn-outline" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass); color: var(--text-secondary); cursor: pointer;">
                        נקה בחירה
                    </button>
                </div>

                <div class="bulk-vessels-list" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
            `;

            bulkVessels.forEach((vessel, index) => {
                const matchedShip = findMatchingShip(vessel.vesselName);
                const isMatched = !!matchedShip;
                const etbDisplay = vessel.etb ? formatDateFromISO(vessel.etb.iso) : '-';
                const etaDisplay = vessel.eta ? formatDateFromISO(vessel.eta.iso) : '-';
                const matchIndicator = isMatched
                    ? `<span style="color: var(--success); font-size: 11px;">✓ ${matchedShip.name}</span>`
                    : `<span style="color: var(--warning); font-size: 11px;">? חדשה</span>`;

                html += `
                    <div class="bulk-vessel-item" style="background: var(--bg-card); border-radius: 12px; padding: 14px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px; flex: 1;">
                                <label style="display: flex; align-items: center; cursor: pointer; margin-top: 3px;">
                                    <input type="checkbox" id="bulkVessel_${index}" ${isMatched ? 'checked' : ''}
                                        style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                </label>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-weight: 700; font-size: 15px; color: var(--text-primary);">${vessel.vesselName || 'לא זוהה'}</span>
                                        ${matchIndicator}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: var(--text-secondary);">
                                        ${vessel.etb ? `
                                            <div>
                                                <span style="color: var(--text-tertiary);">ETB:</span>
                                                <span style="font-weight: 600; color: var(--text-primary); margin-right: 4px;">${etbDisplay}</span>
                                                ${vessel.etb.original ? `<span style="font-size: 11px; color: var(--text-tertiary);">(${vessel.etb.original})</span>` : ''}
                                            </div>
                                        ` : ''}
                                        ${vessel.eta ? `
                                            <div>
                                                <span style="color: var(--text-tertiary);">ETA:</span>
                                                <span style="font-weight: 600; color: var(--text-primary); margin-right: 4px;">${etaDisplay}</span>
                                            </div>
                                        ` : ''}
                                        ${vessel.berth ? `
                                            <div>
                                                <span style="color: var(--text-tertiary);">רציף:</span>
                                                <span style="font-weight: 600; color: var(--text-primary); margin-right: 4px;">${vessel.berth}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ${!isMatched ? `
                                <select id="bulkShipSelect_${index}" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary); font-size: 12px;">
                                    <option value="new">+ הוסף חדשה</option>
                                    ${ships.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            ` : `
                                <input type="hidden" id="bulkShipSelect_${index}" value="${matchedShip.id}">
                            `}
                        </div>
                    </div>
                `;
            });

            html += `
                </div>

                <button class="apply-all-btn" onclick="applyBulkUpdates()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--success), var(--success-dark)); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    החל עדכונים נבחרים
                </button>
            `;

            container.innerHTML = html;
        }

        // Toggle all bulk vessel checkboxes
        function toggleAllBulkVessels(selectAll) {
            const checkboxes = document.querySelectorAll('[id^="bulkVessel_"]');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
            });
        }

        // Apply bulk updates for selected vessels
        function applyBulkUpdates() {
            const bulkVessels = window.pendingBulkUpdate || [];
            if (bulkVessels.length === 0) {
                showToast('אין נתונים להחלה', 'error');
                return;
            }

            let updatedCount = 0;
            let addedCount = 0;
            let errors = [];

            bulkVessels.forEach((vessel, index) => {
                const checkbox = document.getElementById(`bulkVessel_${index}`);
                if (!checkbox || !checkbox.checked) return;

                const shipSelectEl = document.getElementById(`bulkShipSelect_${index}`);
                const shipId = shipSelectEl ? shipSelectEl.value : null;

                try {
                    if (shipId === 'new') {
                        // Create new ship
                        const newShip = {
                            id: generateId(),
                            name: vessel.vesselName?.toUpperCase() || 'UNKNOWN',
                            status: 'מינוי',
                            port: 'Ashdod',
                            eta: vessel.eta?.iso || null,
                            etb: vessel.etb ? {
                                type: 'specific',
                                sortDate: vessel.etb.iso,
                                displayValue: formatDateFromISO(vessel.etb.iso)
                            } : null,
                            services: [],
                            checklist: {},
                            notes: [],
                            history: [{
                                date: new Date().toISOString(),
                                action: 'נוספה מעדכון מרובה',
                                user: currentUser
                            }]
                        };
                        ships.push(newShip);
                        addedCount++;
                    } else {
                        // Update existing ship
                        const ship = ships.find(s => s.id === shipId);
                        if (ship) {
                            if (vessel.etb?.iso) {
                                ship.etb = {
                                    type: 'specific',
                                    sortDate: vessel.etb.iso,
                                    displayValue: formatDateFromISO(vessel.etb.iso)
                                };
                            }
                            if (vessel.eta?.iso) {
                                ship.eta = vessel.eta.iso;
                            }
                            if (vessel.berth) {
                                ship.berth = vessel.berth;
                            }
                            // Add history entry
                            if (!ship.history) ship.history = [];
                            ship.history.push({
                                date: new Date().toISOString(),
                                action: `עודכן ETB מעדכון מרובה`,
                                user: currentUser
                            });
                            updatedCount++;
                        }
                    }
                } catch (e) {
                    errors.push(vessel.vesselName || `אנייה ${index + 1}`);
                }
            });

            // Save and refresh
            saveData();
            renderShips();
            updateStats();

            // Close modal and show result
            const modal = document.getElementById('parserModal');
            if (modal) modal.style.display = 'none';

            // Build result message
            let message = '';
            if (updatedCount > 0) message += `עודכנו ${updatedCount} אניות. `;
            if (addedCount > 0) message += `נוספו ${addedCount} אניות חדשות. `;
            if (errors.length > 0) message += `שגיאות: ${errors.join(', ')}`;

            if (updatedCount > 0 || addedCount > 0) {
                showToast(message || 'העדכונים הוחלו בהצלחה', 'success');
            } else {
                showToast('לא נבחרו אניות לעדכון', 'warning');
            }

            // Clear pending data
            window.pendingBulkUpdate = null;
        }

        function createParsedField(label, value, fieldKey, rawValue = null) {
            const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
            const escapedRawValue = (rawValue || displayValue || '').toString().replace(/'/g, "\\'");
            return `
                <div class="parsed-field" data-field="${fieldKey}">
                    <div class="parsed-field-header">
                        <span class="parsed-field-label">${label}</span>
                        <button class="parsed-field-apply" onclick="applyField('${fieldKey}', '${escapedRawValue}')">
                            החל
                        </button>
                    </div>
                    <span class="parsed-field-value">${displayValue}</span>
                </div>
            `;
        }

        // Create parsed field with original text shown in smaller font
        function createParsedFieldWithOriginal(label, value, originalText, fieldKey, rawValue = null) {
            const escapedRawValue = (rawValue || value || '').toString().replace(/'/g, "\\'");
            return `
                <div class="parsed-field" data-field="${fieldKey}">
                    <div class="parsed-field-header">
                        <span class="parsed-field-label">${label}</span>
                        <button class="parsed-field-apply" onclick="applyField('${fieldKey}', '${escapedRawValue}')">
                            החל
                        </button>
                    </div>
                    <div class="parsed-field-value">
                        <span style="font-weight: 600;">${value}</span>
                        ${originalText ? `<span style="font-size: 11px; color: var(--text-tertiary); margin-right: 8px;">${originalText}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function formatDateTimeHebrew(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Format ISO date string to display format
        function formatDateFromISO(isoStr) {
            if (!isoStr) return '';

            try {
                const date = new Date(isoStr);
                if (!isNaN(date.getTime())) {
                    return formatDateTimeHebrew(date);
                }
            } catch (e) {}

            // Return original if parsing fails
            return String(isoStr).replace(/T/, ' ').replace(/:00$/, '');
        }

        // Safe date formatter - handles various formats without NaN
        function formatDateSafe(dateStr) {
            if (!dateStr) return '';

            // Try to parse as Date object
            const date = new Date(dateStr);

            // Check if valid date
            if (!isNaN(date.getTime())) {
                return formatDateTimeHebrew(date);
            }

            // If not a valid date, just return the original string cleaned up
            return String(dateStr).replace(/\s+/g, ' ').trim();
        }

        function formatServiceDetails(service) {
            switch (service.type) {
                case 'water':
                    return service.details.amount ? `${service.details.amount} טון` : 'כמות לא צוינה';
                case 'crew_change':
                    const inOut = [];
                    if (service.details.crewIn) inOut.push(`${service.details.crewIn} נכנסים`);
                    if (service.details.crewOut) inOut.push(`${service.details.crewOut} יוצאים`);
                    return inOut.length > 0 ? inOut.join(', ') : 'פרטים לא צוינו';
                case 'package':
                    const parts = [];
                    if (service.details.weight) parts.push(`${service.details.weight} ק"ג`);
                    if (service.details.tracking) parts.push(`מעקב: ${service.details.tracking}`);
                    return parts.length > 0 ? parts.join(', ') : 'פרטים לא צוינו';
                case 'sludge':
                case 'bilge':
                    return service.details.amount ? `${service.details.amount} מ"ק` : 'כמות לא צוינה';
                default:
                    return '';
            }
        }

        function applyField(fieldKey, value) {
            const shipId = document.getElementById('targetShipSelect').value;

            if (shipId === 'new') {
                showToast('יש לבחור אנייה קיימת או להשתמש ב"החל את כל העדכונים" להוספת אנייה חדשה', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) {
                showToast('אנייה לא נמצאה', 'error');
                return;
            }

            // Apply the specific field
            switch (fieldKey) {
                case 'name':
                    ship.name = value;
                    break;
                case 'status':
                    ship.status = value;
                    ensureChecklistForStatus(ship);
                    break;
                case 'eta':
                    ship.eta = value;
                    break;
                case 'etb':
                    ship.etb = {
                        type: 'specific',
                        sortDate: value,
                        displayValue: formatDateTimeHebrew(new Date(value))
                    };
                    break;
                case 'etd':
                    ship.etd = value;
                    break;
                case 'port':
                    ship.port = value;
                    break;
                case 'cargo':
                    ship.cargo = value;
                    break;
                case 'notes':
                    ship.notes = value + (ship.notes ? '\n---\n' + ship.notes : '');
                    break;
            }

            saveData();
            renderShips();

            // Mark button as applied
            const btn = event.target;
            btn.textContent = 'הוחל ✓';
            btn.classList.add('applied');

            showToast(`שדה "${fieldKey}" עודכן בהצלחה`, 'success');
            addActivity('עדכון מניתוח', `עודכן ${fieldKey} לאנייה ${ship.name}`);

            // Prompt email notification for significant updates
            if (fieldKey === 'eta') {
                askToSendEmail(ship, 'eta', { eta: value });
            } else if (fieldKey === 'etb') {
                askToSendEmail(ship, 'etb', { etb: value });
            } else if (fieldKey === 'status') {
                // Map status to email type
                const statusLower = value.toLowerCase();
                if (statusLower.includes('הפליגה') || statusLower.includes('sailed')) {
                    askToSendEmail(ship, 'sailed');
                } else if (statusLower.includes('ברציף') || statusLower.includes('berthed')) {
                    askToSendEmail(ship, 'berthed');
                }
            }
        }

        function applyService(serviceIndex) {
            const shipId = document.getElementById('targetShipSelect').value;

            if (shipId === 'new') {
                showToast('יש לבחור אנייה קיימת', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) {
                showToast('אנייה לא נמצאה', 'error');
                return;
            }

            const service = lastParsedData.updates.services_to_add[serviceIndex];
            if (!service) return;

            // Initialize services array if needed
            ship.services = ship.services || [];

            // Add the service with a unique ID
            const newService = {
                id: 'service_' + Date.now(),
                type: service.type,
                status: 'requested',
                details: service.details,
                createdAt: new Date().toISOString()
            };

            ship.services.push(newService);
            saveData();

            // Mark button as applied
            const btn = event.target;
            btn.textContent = 'נוסף ✓';
            btn.classList.add('applied');

            showToast(`שירות ${getServiceTypeName(service.type)} נוסף בהצלחה`, 'success');
            addActivity('שירות חדש', `נוסף ${getServiceTypeName(service.type)} לאנייה ${ship.name}`);
        }

        function applyAllUpdates() {
            const shipId = document.getElementById('targetShipSelect').value;
            let ship;

            if (shipId === 'new') {
                // Create new ship
                ship = createShipObject({
                    name: lastParsedData.updates.name || 'אנייה חדשה',
                    status: lastParsedData.updates.status || 'At Sea'
                });
                ships.push(ship);
            } else {
                ship = ships.find(s => s.id === shipId);
                if (!ship) {
                    showToast('אנייה לא נמצאה', 'error');
                    return;
                }
            }

            // Apply all updates
            const updates = lastParsedData.updates;

            if (updates.name) ship.name = updates.name;
            if (updates.status) {
                ship.status = updates.status;
                ensureChecklistForStatus(ship);
            }
            if (updates.eta) ship.eta = updates.eta;
            if (updates.etb) {
                ship.etb = {
                    type: 'specific',
                    sortDate: updates.etb,
                    displayValue: formatDateTimeHebrew(new Date(updates.etb))
                };
            }
            if (updates.etd) ship.etd = updates.etd;
            if (updates.port) ship.port = updates.port;
            if (updates.cargo) ship.cargo = updates.cargo;
            if (updates.notes_delta) {
                ship.notes = updates.notes_delta + (ship.notes ? '\n---\n' + ship.notes : '');
            }

            // Add services
            if (updates.services_to_add.length > 0) {
                ship.services = ship.services || [];
                for (const service of updates.services_to_add) {
                    ship.services.push({
                        id: 'service_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        type: service.type,
                        status: 'requested',
                        details: service.details,
                        createdAt: new Date().toISOString()
                    });
                }
            }

            saveData();
            renderShips();

            showToast(shipId === 'new' ? 'אנייה חדשה נוספה בהצלחה!' : 'כל העדכונים הוחלו בהצלחה!', 'success');
            addActivity(shipId === 'new' ? 'אנייה חדשה' : 'עדכון מניתוח', `${ship.name} עודכנה מניתוח הודעה`);

            // Clear the form and show success
            document.getElementById('emailInput').value = '';
            document.getElementById('parsedResult').innerHTML = `
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--success);">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: var(--spacing-md);">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <h3>העדכונים הוחלו בהצלחה!</h3>
                    <p style="color: var(--text-secondary); margin-top: var(--spacing-sm);">
                        ${ship.name} עודכנה במערכת
                    </p>
                    <button class="btn btn-secondary" onclick="switchToDashboardView()" style="margin-top: var(--spacing-lg);">
                        חזור ללוח הבקרה
                    </button>
                </div>
            `;

            // Prompt email notification for significant updates
            if (updates.eta && updates.etb) {
                askToSendEmail(ship, 'eta_etb', { eta: updates.eta, etb: updates.etb });
            } else if (updates.eta) {
                askToSendEmail(ship, 'eta', { eta: updates.eta });
            } else if (updates.etb) {
                askToSendEmail(ship, 'etb', { etb: updates.etb });
            }
        }

        function updateApplyButtons() {
            // This function can be used to update button states when ship selection changes
        }

        // ==================== CONTACTS & EMAIL MANAGEMENT ====================
        let contacts = [];
        let emailGroups = [];
        let selectedRecipients = [];

        // Contact types
        const contactTypes = {
            agent: { label: 'סוכן', class: 'agent' },
            port: { label: 'נמל', class: 'port' },
            owner: { label: 'בעלים', class: 'owner' },
            charterer: { label: 'שוכר', class: 'charterer' },
            receiver: { label: 'מקבל', class: 'receiver' },
            other: { label: 'אחר', class: '' }
        };

        function switchToContactsView() {
            // Remove 'active' from all nav items
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // Add 'active' to contacts nav item (index 4)
            document.querySelectorAll('.nav-menu .nav-item')[4].classList.add('active');

            // Hide tabs and stats
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            // Hide other views, show contacts view
            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('contactsView').classList.add('active');

            currentTab = 'contacts';
            loadContacts();
            loadEmailGroups();
            populateShipSelector();
        }

        // ==================== Discharge Tracking View ====================
        let currentTallyData = null;
        let currentImageData = null;
        let currentPdfData = null;

        function switchToDischargeView() {
            // Remove 'active' from all nav items
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // Add 'active' to discharge nav item (index 5)
            document.querySelectorAll('.nav-menu .nav-item')[5].classList.add('active');

            // Hide tabs and stats
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            // Hide other views, show discharge view
            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('dischargeView').classList.add('active');

            currentTab = 'discharge';
            populateDischargeShipSelector();
        }

        // ==================== Reference Data View ====================
        let referenceData = {
            vessels: [],
            cargo: [],
            owners: [],
            receivers: []
        };

        function switchToReferenceView() {
            // Remove 'active' from all nav items
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            // Add 'active' to reference nav item (index 6)
            document.querySelectorAll('.nav-menu .nav-item')[6].classList.add('active');

            // Hide tabs and stats
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            // Hide other views, show reference view
            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('referenceView').classList.add('active');

            currentTab = 'reference';
            loadReferenceData();
        }

        // ==================== OPERATIONS VIEW ====================
        let currentOpsFilter = 'all';

        function switchToOperationsView() {
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-menu .nav-item')[1].classList.add('active');

            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('galleryView').classList.remove('active');
            document.getElementById('operationsView').classList.add('active');

            currentTab = 'operations';
            renderOperationsTasks();
        }

        function renderOperationsTasks() {
            const tasksList = document.getElementById('opsTasksList');
            const allTasks = [];

            // Collect all tasks from all active ships
            ships.filter(s => s.status !== STATUS.SAILED).forEach(ship => {
                const etaDays = calculateDaysUntilETA(ship.eta);

                (ship.tasks || []).forEach(task => {
                    // Only include tasks relevant to current status
                    if (!task.statuses || task.statuses.includes(ship.status)) {
                        allTasks.push({
                            ...task,
                            shipId: ship.id,
                            shipName: ship.name,
                            shipVoyage: ship.voyage,
                            shipStatus: ship.status,
                            shipEta: ship.eta,
                            etaDays: etaDays,
                            urgency: getTaskUrgency(task, ship)
                        });
                    }
                });
            });

            // Sort by urgency then by ETA
            allTasks.sort((a, b) => {
                const urgencyOrder = { urgent: 0, warning: 1, normal: 2, completed: 3 };
                if (urgencyOrder[a.urgency] !== urgencyOrder[b.urgency]) {
                    return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
                }
                return (a.etaDays || 999) - (b.etaDays || 999);
            });

            // Filter based on current filter
            const filteredTasks = filterTasksList(allTasks, currentOpsFilter);

            // Update summary counts
            updateOpsSummaryCounts(allTasks);

            if (filteredTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="ops-empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <h3>אין משימות להצגה</h3>
                        <p>כל המשימות הושלמו או שאין אניות פעילות</p>
                    </div>
                `;
                return;
            }

            tasksList.innerHTML = filteredTasks.map(task => `
                <div class="ops-task-item ${task.urgency} ${task.status === 'done' ? 'completed' : ''}" data-task-key="${task.key}" data-ship-id="${task.shipId}">
                    <button class="ops-task-checkbox ${task.status}" onclick="cycleOpsTaskStatus('${task.shipId}', '${task.key}')" title="שנה סטטוס">
                        ${task.status === 'done' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </button>
                    <div class="ops-task-content">
                        <span class="ops-task-title">${task.title}</span>
                        <span class="ops-task-ship">
                            <span class="ops-task-ship-link" onclick="openShipFromOps('${task.shipId}')">${task.shipName}</span>
                            ${task.shipVoyage ? `<span style="opacity: 0.6">• ${task.shipVoyage}</span>` : ''}
                        </span>
                    </div>
                    <span class="ops-task-eta">${formatEtaForOps(task.shipEta, task.etaDays)}</span>
                    <span class="ops-task-urgency ${task.urgency}">${getUrgencyLabel(task.urgency)}</span>
                    <span class="ops-task-status ${task.status}">${getStatusLabel(task.status)}</span>
                </div>
            `).join('');
        }

        function getTaskUrgency(task, ship) {
            if (task.status === 'done') return 'completed';

            const etaDays = calculateDaysUntilETA(ship.eta);

            // Check if task is overdue based on its due rule
            if (task.due && task.due.startsWith('eta_minus_days:')) {
                const daysBefore = parseInt(task.due.split(':')[1]);
                if (etaDays <= daysBefore - 2) return 'urgent';
                if (etaDays <= daysBefore) return 'warning';
            }

            // At port and task should have been done at sea
            if (ship.status !== STATUS.AT_SEA && task.due === 'at_sea_window') {
                return task.status === 'done' ? 'completed' : 'urgent';
            }

            // General urgency based on ETA
            if (etaDays <= 1) return 'urgent';
            if (etaDays <= 3) return 'warning';

            return 'normal';
        }

        function filterTasksList(tasks, filter) {
            switch (filter) {
                case 'urgent':
                    return tasks.filter(t => t.urgency === 'urgent');
                case 'today':
                    return tasks.filter(t => t.etaDays <= 1 && t.status !== 'done');
                case 'pending':
                    return tasks.filter(t => t.status === 'pending');
                case 'in-progress':
                    return tasks.filter(t => t.status === 'in-progress');
                default:
                    return tasks;
            }
        }

        function filterOperationsTasks(filter) {
            currentOpsFilter = filter;

            document.querySelectorAll('.ops-filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });

            renderOperationsTasks();
        }

        function updateOpsSummaryCounts(tasks) {
            const today = new Date().toDateString();

            document.getElementById('opsUrgentCount').textContent = tasks.filter(t => t.urgency === 'urgent').length;
            document.getElementById('opsWarningCount').textContent = tasks.filter(t => t.urgency === 'warning').length;
            document.getElementById('opsNormalCount').textContent = tasks.filter(t => t.urgency === 'normal' && t.status !== 'done').length;
            document.getElementById('opsCompletedCount').textContent = tasks.filter(t => t.status === 'done').length;
        }

        function formatEtaForOps(eta, days) {
            if (!eta) return '-';
            const date = new Date(eta);
            const dateStr = date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });

            if (days <= 0) return `${dateStr} (היום)`;
            if (days <= 1) return `${dateStr} (מחר)`;
            return `${dateStr} (${Math.round(days)} ימים)`;
        }

        function getUrgencyLabel(urgency) {
            const labels = {
                urgent: 'דחוף',
                warning: 'קרוב',
                normal: 'שוטף',
                completed: 'הושלם'
            };
            return labels[urgency] || urgency;
        }

        function getStatusLabel(status) {
            const labels = {
                pending: 'ממתין',
                'in-progress': 'בביצוע',
                done: 'הושלם'
            };
            return labels[status] || status;
        }

        async function cycleOpsTaskStatus(shipId, taskKey) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const task = ship.tasks.find(t => t.key === taskKey);
            if (!task) return;

            // Cycle status
            const statusOrder = ['pending', 'in-progress', 'done'];
            const currentIndex = statusOrder.indexOf(task.status);
            task.status = statusOrder[(currentIndex + 1) % statusOrder.length];

            await saveShipToFirestore(ship);
            renderOperationsTasks();
            showToast(`משימה עודכנה: ${getStatusLabel(task.status)}`, 'success');
        }

        function openShipFromOps(shipId) {
            switchToDashboardView();
            setTimeout(() => {
                const ship = ships.find(s => s.id === shipId);
                if (ship) openShipDetails(ship);
            }, 100);
        }

        // ==================== GALLERY VIEW ====================
        let galleryImages = [];

        function switchToGalleryView() {
            document.querySelectorAll('.nav-menu .nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-menu .nav-item')[7].classList.add('active');

            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';

            document.getElementById('shipsGrid').style.display = 'none';
            document.getElementById('emailParserView').classList.remove('active');
            document.getElementById('contactsView').classList.remove('active');
            document.getElementById('dischargeView').classList.remove('active');
            document.getElementById('referenceView').classList.remove('active');
            document.getElementById('operationsView').classList.remove('active');
            document.getElementById('galleryView').classList.add('active');

            currentTab = 'gallery';
            loadGalleryImages();
        }

        async function loadGalleryImages() {
            try {
                const snapshot = await db.collection('gallery').orderBy('uploadedAt', 'desc').get();
                galleryImages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGallery();
            } catch (error) {
                console.error('Error loading gallery:', error);
                galleryImages = [];
                renderGallery();
            }
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            const empty = document.getElementById('galleryEmpty');
            const searchTerm = document.getElementById('gallerySearch')?.value?.toLowerCase() || '';

            const filtered = searchTerm
                ? galleryImages.filter(img =>
                    (img.vesselName || '').toLowerCase().includes(searchTerm) ||
                    (img.description || '').toLowerCase().includes(searchTerm)
                  )
                : galleryImages;

            if (filtered.length === 0) {
                empty.style.display = 'block';
                grid.innerHTML = '';
                grid.appendChild(empty);
                return;
            }

            empty.style.display = 'none';
            grid.innerHTML = filtered.map(img => `
                <div class="gallery-item" onclick="openLightbox('${img.id}')">
                    <img class="gallery-item-image" src="${img.imageUrl}" alt="${img.vesselName || 'תמונה'}" loading="lazy">
                    <div class="gallery-item-info">
                        <p class="gallery-item-vessel">${img.vesselName || 'אנייה לא ידועה'}</p>
                        <div class="gallery-item-meta">
                            <span class="gallery-item-type">${img.imageType || 'כללי'}</span>
                            <span>${formatGalleryDate(img.uploadedAt)}</span>
                        </div>
                    </div>
                    <div class="gallery-item-actions">
                        <button onclick="event.stopPropagation(); downloadImage('${img.id}')">הורד</button>
                        <button class="delete" onclick="event.stopPropagation(); deleteGalleryImage('${img.id}')">מחק</button>
                    </div>
                </div>
            `).join('');
        }

        function filterGallery() {
            renderGallery();
        }

        function formatGalleryDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('he-IL');
        }

        function openGalleryUpload() {
            document.getElementById('modalTitle').textContent = 'העלאת תמונה';
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; gap: 16px;">
                    <div class="form-group">
                        <label>בחר אנייה</label>
                        <select id="uploadVesselSelect" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="">-- בחר אנייה --</option>
                            ${ships.map(s => `<option value="${s.name}">${s.name}${s.voyage ? ' - ' + s.voyage : ''}</option>`).join('')}
                            ${referenceData.vessels.map(v => `<option value="${v.name}">${v.name} (ממאגר)</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>או הקלד שם אנייה</label>
                        <input type="text" id="uploadVesselName" placeholder="שם האנייה" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>סוג תמונה</label>
                        <select id="uploadImageType" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="מעמסה">מעמסה (Hold)</option>
                            <option value="מסמך">מסמך</option>
                            <option value="נזק">נזק/ליקוי</option>
                            <option value="מטען">מטען</option>
                            <option value="כללי">כללי</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>תיאור (אופציונלי)</label>
                        <input type="text" id="uploadDescription" placeholder="תיאור התמונה" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>בחר תמונה</label>
                        <div style="border: 2px dashed var(--glass-border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 200ms;"
                             onclick="document.getElementById('uploadFileInput').click()"
                             id="uploadDropZone">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 12px; opacity: 0.5;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <p style="margin: 0; color: var(--text-secondary);">לחץ לבחירת תמונה או גרור לכאן</p>
                            <p style="margin: 8px 0 0; font-size: 12px; color: var(--text-tertiary);">JPG, PNG, WebP עד 10MB</p>
                        </div>
                        <input type="file" id="uploadFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <div id="uploadPreview" style="margin-top: 12px; display: none;">
                            <img id="uploadPreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeModal()" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                            ביטול
                        </button>
                        <button onclick="uploadGalleryImage()" id="uploadBtn" style="padding: 12px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; cursor: pointer; font-weight: 600;">
                            העלה תמונה
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        let selectedImageFile = null;
        let selectedImageBase64 = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showToast('הקובץ גדול מדי (מקסימום 10MB)', 'error');
                return;
            }

            selectedImageFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageBase64 = e.target.result;
                document.getElementById('uploadPreview').style.display = 'block';
                document.getElementById('uploadPreviewImg').src = e.target.result;
                document.getElementById('uploadDropZone').style.borderColor = 'var(--success)';
            };
            reader.readAsDataURL(file);
        }

        async function uploadGalleryImage() {
            const vesselSelect = document.getElementById('uploadVesselSelect').value;
            const vesselInput = document.getElementById('uploadVesselName').value.trim();
            const vesselName = vesselInput || vesselSelect;

            if (!vesselName) {
                showToast('נא לבחור או להקליד שם אנייה', 'warning');
                return;
            }

            if (!selectedImageBase64) {
                showToast('נא לבחור תמונה', 'warning');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'מעלה...';

            try {
                const imageData = {
                    vesselName: vesselName,
                    imageType: document.getElementById('uploadImageType').value,
                    description: document.getElementById('uploadDescription').value.trim(),
                    imageUrl: selectedImageBase64,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('gallery').add(imageData);

                closeModal();
                selectedImageFile = null;
                selectedImageBase64 = null;
                loadGalleryImages();
                showToast('התמונה הועלתה בהצלחה!', 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showToast('שגיאה בהעלאה', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'העלה תמונה';
            }
        }

        async function deleteGalleryImage(imageId) {
            if (!confirm('האם למחוק את התמונה?')) return;

            try {
                await db.collection('gallery').doc(imageId).delete();
                galleryImages = galleryImages.filter(img => img.id !== imageId);
                renderGallery();
                showToast('התמונה נמחקה', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showToast('שגיאה במחיקה', 'error');
            }
        }

        function openLightbox(imageId) {
            const image = galleryImages.find(img => img.id === imageId);
            if (!image) return;

            // Create lightbox if not exists
            let lightbox = document.getElementById('lightboxOverlay');
            if (!lightbox) {
                lightbox = document.createElement('div');
                lightbox.id = 'lightboxOverlay';
                lightbox.className = 'lightbox-overlay';
                lightbox.onclick = function(e) {
                    if (e.target === lightbox) closeLightbox();
                };
                document.body.appendChild(lightbox);
            }

            lightbox.innerHTML = `
                <button class="lightbox-close" onclick="closeLightbox()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </button>
                <div class="lightbox-content">
                    <img src="${image.imageUrl}" alt="${image.vesselName}">
                </div>
                <div class="lightbox-info">
                    <strong>${image.vesselName}</strong>
                    ${image.imageType ? `<span style="margin-right: 12px; opacity: 0.7;">${image.imageType}</span>` : ''}
                    ${image.description ? `<p style="margin: 8px 0 0; opacity: 0.8;">${image.description}</p>` : ''}
                </div>
            `;
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightboxOverlay');
            if (lightbox) lightbox.classList.remove('active');
        }

        function downloadImage(imageId) {
            const image = galleryImages.find(img => img.id === imageId);
            if (!image) return;

            const link = document.createElement('a');
            link.href = image.imageUrl;
            link.download = `${image.vesselName}_${image.imageType || 'image'}.jpg`;
            link.click();
        }

        function switchReferenceTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.reference-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update panels
            document.querySelectorAll('.reference-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            const panelMap = {
                'vessels': 'refVesselsPanel',
                'cargo': 'refCargoPanel',
                'owners': 'refOwnersPanel',
                'receivers': 'refReceiversPanel'
            };

            document.getElementById(panelMap[tabName]).classList.add('active');
        }

        async function loadReferenceData() {
            try {
                // Load vessels reference
                const vesselsSnapshot = await db.collection('referenceData').doc('vessels').get();
                if (vesselsSnapshot.exists) {
                    referenceData.vessels = vesselsSnapshot.data().items || [];
                }

                // Load cargo reference
                const cargoSnapshot = await db.collection('referenceData').doc('cargo').get();
                if (cargoSnapshot.exists) {
                    referenceData.cargo = cargoSnapshot.data().items || [];
                }

                // Load owners reference
                const ownersSnapshot = await db.collection('referenceData').doc('owners').get();
                if (ownersSnapshot.exists) {
                    referenceData.owners = ownersSnapshot.data().items || [];
                }

                // Load receivers reference
                const receiversSnapshot = await db.collection('referenceData').doc('receivers').get();
                if (receiversSnapshot.exists) {
                    referenceData.receivers = receiversSnapshot.data().items || [];
                }

                // Seed cargo types if empty
                if (referenceData.cargo.length === 0) {
                    await seedCargoTypes();
                }

                renderAllReferenceTables();
            } catch (error) {
                console.error('Error loading reference data:', error);
                showToast('שגיאה בטעינת נתוני יסוד', 'error');
            }
        }

        async function seedCargoTypes() {
            const steelCargoTypes = [
                'Alloyed Galvanized Wire',
                'Alloyed Wire',
                'Aluminum Billets',
                'Aluminum Ingots',
                'Aluminum Wire Rods',
                'Galvanized Wire',
                'Merchant Bars',
                'Rebars in spools',
                'Sheet Piles',
                'Steel',
                'Steel Angles',
                'Steel Bars',
                'Steel Beams',
                'Steel Billets',
                'Steel Billets In Bundles',
                'Steel channels',
                'Steel Coils',
                'Steel Debars',
                'Steel Debars in Coils',
                'Steel Piles',
                'Steel Pipes',
                'Steel Plates',
                'Steel Products',
                'Steel Profiles',
                'Steel Rails',
                'Steel Rebars',
                'Steel Rebars in Coils',
                'Steel Sections',
                'Steel Sheets',
                'Steel Stripes',
                'Steel Welded Mesh',
                'Steel Wire Rods',
                'Steel Wire Rods in Coils',
                'Stone Wool',
                'Tear Drops',
                'Wire strand in coils'
            ];

            referenceData.cargo = steelCargoTypes.map((name, idx) => ({
                id: Date.now().toString() + idx,
                sequentialId: idx + 1,
                name: name,
                category: 'Steel',
                unit: 'MT',
                notes: ''
            }));

            try {
                await db.collection('referenceData').doc('cargo').set({
                    items: referenceData.cargo,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Cargo types seeded successfully');
            } catch (error) {
                console.error('Error seeding cargo types:', error);
            }
        }

        function renderAllReferenceTables() {
            renderVesselsTable();
            renderCargoTable();
            renderOwnersTable();
            renderReceiversTable();
        }

        function renderVesselsTable() {
            const tbody = document.getElementById('refVesselsBody');
            if (referenceData.vessels.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="16">אין אניות במאגר. הוסף אנייה חדשה או השתמש בייבוא חכם.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = referenceData.vessels.map((vessel, idx) => `
                <tr>
                    <td>${vessel.sequentialId || idx + 1}</td>
                    <td><strong>${vessel.name || '-'}</strong></td>
                    <td>${vessel.flag || '-'}</td>
                    <td>${vessel.yearBuilt || '-'}</td>
                    <td>${vessel.holds || '-'}</td>
                    <td>${vessel.loa || '-'}</td>
                    <td>${vessel.beam || '-'}</td>
                    <td>${vessel.dwt || '-'}</td>
                    <td>${vessel.grain || '-'}</td>
                    <td>${vessel.bale || '-'}</td>
                    <td>${vessel.nrt || '-'}</td>
                    <td>${vessel.grt || '-'}</td>
                    <td>${vessel.imo || '-'}</td>
                    <td>${vessel.dagonCompatible || '-'}</td>
                    <td>${vessel.israeliPortNumber || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editReferenceItem('vessels', ${idx})" title="עריכה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" onclick="deleteReferenceItem('vessels', ${idx})" title="מחיקה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderCargoTable() {
            const tbody = document.getElementById('refCargoBody');
            if (referenceData.cargo.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="6">אין סוגי מטען במאגר. הוסף סוג מטען חדש.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = referenceData.cargo.map((cargo, idx) => `
                <tr>
                    <td>${cargo.sequentialId || idx + 1}</td>
                    <td><strong>${cargo.name || '-'}</strong></td>
                    <td>${cargo.category || '-'}</td>
                    <td>${cargo.unit || '-'}</td>
                    <td>${cargo.notes || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editReferenceItem('cargo', ${idx})" title="עריכה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" onclick="deleteReferenceItem('cargo', ${idx})" title="מחיקה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderOwnersTable() {
            const tbody = document.getElementById('refOwnersBody');
            if (referenceData.owners.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="6">אין בעלים/שוכרים במאגר. הוסף חדש.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = referenceData.owners.map((owner, idx) => `
                <tr>
                    <td><strong>${owner.name || '-'}</strong></td>
                    <td>${owner.type || '-'}</td>
                    <td>${owner.country || '-'}</td>
                    <td>${owner.email || '-'}</td>
                    <td>${owner.phone || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editReferenceItem('owners', ${idx})" title="עריכה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" onclick="deleteReferenceItem('owners', ${idx})" title="מחיקה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderReceiversTable() {
            const tbody = document.getElementById('refReceiversBody');
            if (referenceData.receivers.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="6">אין מקבלי מטען במאגר. הוסף חדש.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = referenceData.receivers.map((receiver, idx) => `
                <tr>
                    <td><strong>${receiver.name || '-'}</strong></td>
                    <td>${receiver.company || '-'}</td>
                    <td>${receiver.email || '-'}</td>
                    <td>${receiver.phone || '-'}</td>
                    <td>${receiver.address || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editReferenceItem('receivers', ${idx})" title="עריכה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" onclick="deleteReferenceItem('receivers', ${idx})" title="מחיקה">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterReferenceTable(type) {
            const searchInputMap = {
                'vessels': 'refVesselSearch',
                'cargo': 'refCargoSearch',
                'owners': 'refOwnersSearch',
                'receivers': 'refReceiversSearch'
            };

            const searchTerm = document.getElementById(searchInputMap[type]).value.toLowerCase();
            const tbody = document.getElementById(`ref${type.charAt(0).toUpperCase() + type.slice(1)}Body`);
            const rows = tbody.querySelectorAll('tr:not(.empty-row)');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function showAddReferenceModal(type) {
            const titles = {
                'vessels': 'הוספת אנייה',
                'cargo': 'הוספת סוג מטען',
                'owners': 'הוספת בעלים / שוכר',
                'receivers': 'הוספת מקבל מטען'
            };

            let formHtml = '';

            if (type === 'vessels') {
                formHtml = `
                    <div style="display: grid; gap: 16px; max-height: 60vh; overflow-y: auto; padding-left: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>שם האנייה *</label>
                                <input type="text" id="refItemName" placeholder="לדוגמה: ELA S" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>דגל</label>
                                <input type="text" id="refItemFlag" placeholder="לדוגמה: Panama" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>שנת בנייה</label>
                                <input type="number" id="refItemYearBuilt" placeholder="2010" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>מס' מעמסות</label>
                                <input type="number" id="refItemHolds" placeholder="5" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>מספר IMO</label>
                                <input type="text" id="refItemImo" placeholder="9123456" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>LOA (מ')</label>
                                <input type="number" step="0.01" id="refItemLoa" placeholder="185.00" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>רוחב (מ')</label>
                                <input type="number" step="0.01" id="refItemBeam" placeholder="28.50" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>DWT (טון)</label>
                                <input type="number" id="refItemDwt" placeholder="32000" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>Grain (cbf)</label>
                                <input type="number" id="refItemGrain" placeholder="1500000" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>Bale (cbf)</label>
                                <input type="number" id="refItemBale" placeholder="1400000" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>NRT (טון)</label>
                                <input type="number" id="refItemNrt" placeholder="12000" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>GRT (טון)</label>
                                <input type="number" id="refItemGrt" placeholder="20000" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>תאימות דגון</label>
                                <select id="refItemDagonCompatible" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <option value="">לא ידוע</option>
                                    <option value="כן">כן</option>
                                    <option value="לא">לא</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>מס' נמל ישראלי</label>
                                <input type="text" id="refItemIsraeliPortNumber" placeholder="12345" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'cargo') {
                formHtml = `
                    <div style="display: grid; gap: 16px;">
                        <div class="form-group">
                            <label>שם סוג המטען</label>
                            <input type="text" id="refItemName" placeholder="לדוגמה: Steel Coils" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>קטגוריה</label>
                                <select id="refItemCategory" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <option value="">בחר קטגוריה</option>
                                    <option value="Steel">Steel</option>
                                    <option value="Bulk">Bulk</option>
                                    <option value="General">General</option>
                                    <option value="Containers">Containers</option>
                                    <option value="Liquid">Liquid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>יחידת מידה</label>
                                <select id="refItemUnit" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <option value="MT">MT (טון)</option>
                                    <option value="PCS">PCS (יחידות)</option>
                                    <option value="Coils">Coils (סלילים)</option>
                                    <option value="Bundles">Bundles (חבילות)</option>
                                    <option value="M3">M3 (מ"ק)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>הערות</label>
                            <input type="text" id="refItemNotes" placeholder="הערות נוספות" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                `;
            } else if (type === 'owners') {
                formHtml = `
                    <div style="display: grid; gap: 16px;">
                        <div class="form-group">
                            <label>שם</label>
                            <input type="text" id="refItemName" placeholder="שם הבעלים או השוכר" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>סוג</label>
                                <select id="refItemOwnerType" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <option value="Owner">Owner (בעלים)</option>
                                    <option value="Charterer">Charterer (שוכר)</option>
                                    <option value="Operator">Operator (מפעיל)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>מדינה</label>
                                <input type="text" id="refItemCountry" placeholder="לדוגמה: Israel" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>אימייל</label>
                                <input type="email" id="refItemEmail" placeholder="email@example.com" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>טלפון</label>
                                <input type="text" id="refItemPhone" placeholder="+972-" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'receivers') {
                formHtml = `
                    <div style="display: grid; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>שם איש קשר</label>
                                <input type="text" id="refItemName" placeholder="שם מלא" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>חברה</label>
                                <input type="text" id="refItemCompany" placeholder="שם החברה" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>אימייל</label>
                                <input type="email" id="refItemEmail" placeholder="email@example.com" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>טלפון</label>
                                <input type="text" id="refItemPhone" placeholder="+972-" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>כתובת</label>
                            <input type="text" id="refItemAddress" placeholder="כתובת מלאה" style="width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                `;
            }

            document.getElementById('modalTitle').textContent = titles[type];
            document.getElementById('modalBody').innerHTML = `
                ${formHtml}
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button onclick="closeModal()" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                        ביטול
                    </button>
                    <button onclick="saveReferenceItem('${type}')" style="padding: 12px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; cursor: pointer; font-weight: 600;">
                        שמור
                    </button>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        async function saveReferenceItem(type) {
            let item = {};

            if (type === 'vessels') {
                // Calculate next sequential ID
                const maxSeqId = referenceData.vessels.reduce((max, v) => Math.max(max, v.sequentialId || 0), 0);
                item = {
                    id: Date.now().toString(),
                    sequentialId: maxSeqId + 1,
                    name: document.getElementById('refItemName').value.trim(),
                    flag: document.getElementById('refItemFlag').value.trim(),
                    yearBuilt: document.getElementById('refItemYearBuilt').value.trim(),
                    holds: document.getElementById('refItemHolds').value.trim(),
                    imo: document.getElementById('refItemImo').value.trim(),
                    loa: document.getElementById('refItemLoa').value.trim(),
                    beam: document.getElementById('refItemBeam').value.trim(),
                    dwt: document.getElementById('refItemDwt').value.trim(),
                    grain: document.getElementById('refItemGrain').value.trim(),
                    bale: document.getElementById('refItemBale').value.trim(),
                    nrt: document.getElementById('refItemNrt').value.trim(),
                    grt: document.getElementById('refItemGrt').value.trim(),
                    dagonCompatible: document.getElementById('refItemDagonCompatible').value,
                    israeliPortNumber: document.getElementById('refItemIsraeliPortNumber').value.trim()
                };
            } else if (type === 'cargo') {
                // Calculate next sequential ID for cargo
                const maxCargoSeqId = referenceData.cargo.reduce((max, c) => Math.max(max, c.sequentialId || 0), 0);
                item = {
                    id: Date.now().toString(),
                    sequentialId: maxCargoSeqId + 1,
                    name: document.getElementById('refItemName').value.trim(),
                    category: document.getElementById('refItemCategory').value,
                    unit: document.getElementById('refItemUnit').value,
                    notes: document.getElementById('refItemNotes').value.trim()
                };
            } else if (type === 'owners') {
                item = {
                    id: Date.now().toString(),
                    name: document.getElementById('refItemName').value.trim(),
                    type: document.getElementById('refItemOwnerType').value,
                    country: document.getElementById('refItemCountry').value.trim(),
                    email: document.getElementById('refItemEmail').value.trim(),
                    phone: document.getElementById('refItemPhone').value.trim()
                };
            } else if (type === 'receivers') {
                item = {
                    id: Date.now().toString(),
                    name: document.getElementById('refItemName').value.trim(),
                    company: document.getElementById('refItemCompany').value.trim(),
                    email: document.getElementById('refItemEmail').value.trim(),
                    phone: document.getElementById('refItemPhone').value.trim(),
                    address: document.getElementById('refItemAddress').value.trim()
                };
            }

            if (!item.name) {
                showToast('נא להזין שם', 'warning');
                return;
            }

            // Add to local array
            referenceData[type].push(item);

            // Save to Firestore
            try {
                await db.collection('referenceData').doc(type).set({
                    items: referenceData[type],
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal();
                renderAllReferenceTables();
                showToast('נשמר בהצלחה!', 'success');
            } catch (error) {
                console.error('Error saving reference item:', error);
                showToast('שגיאה בשמירה', 'error');
            }
        }

        async function deleteReferenceItem(type, index) {
            if (!confirm('האם למחוק פריט זה?')) return;

            referenceData[type].splice(index, 1);

            try {
                await db.collection('referenceData').doc(type).set({
                    items: referenceData[type],
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                renderAllReferenceTables();
                showToast('נמחק בהצלחה', 'success');
            } catch (error) {
                console.error('Error deleting reference item:', error);
                showToast('שגיאה במחיקה', 'error');
            }
        }

        // Add vessel to reference database when creating new ship
        async function addVesselToReferenceDatabase(parserData) {
            if (!parserData || !parserData.vesselName) return;

            const vesselName = parserData.vesselName.trim();

            // Check if vessel already exists in reference database
            const existingVessel = referenceData.vessels.find(v =>
                v.name.toLowerCase() === vesselName.toLowerCase()
            );

            if (existingVessel) {
                // Update existing vessel with new data if we have more info
                const vesselData = parserData.vessel || {};
                let updated = false;

                if (vesselData.loa && !existingVessel.loa) { existingVessel.loa = vesselData.loa; updated = true; }
                if (vesselData.beam && !existingVessel.beam) { existingVessel.beam = vesselData.beam; updated = true; }
                if (vesselData.dwt && !existingVessel.dwt) { existingVessel.dwt = vesselData.dwt; updated = true; }
                if (vesselData.draft && !existingVessel.draft) { existingVessel.draft = vesselData.draft; updated = true; }
                if (vesselData.gross && !existingVessel.grt) { existingVessel.grt = vesselData.gross; updated = true; }
                if (vesselData.net && !existingVessel.nrt) { existingVessel.nrt = vesselData.net; updated = true; }
                if (vesselData.holds && !existingVessel.holds) { existingVessel.holds = vesselData.holds; updated = true; }
                if (vesselData.grainCapacity && !existingVessel.grain) { existingVessel.grain = vesselData.grainCapacity; updated = true; }
                if (vesselData.yearBuilt && !existingVessel.yearBuilt) { existingVessel.yearBuilt = vesselData.yearBuilt; updated = true; }
                if (vesselData.placeBuilt && !existingVessel.placeBuilt) { existingVessel.placeBuilt = vesselData.placeBuilt; updated = true; }
                if (vesselData.class && !existingVessel.class) { existingVessel.class = vesselData.class; updated = true; }
                if (vesselData.cranes && !existingVessel.cranes) { existingVessel.cranes = vesselData.cranes; updated = true; }
                if (vesselData.imoNumber && !existingVessel.imo) { existingVessel.imo = vesselData.imoNumber; updated = true; }

                if (updated) {
                    await db.collection('referenceData').doc('vessels').set({
                        items: referenceData.vessels,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Vessel updated with new specs:', vesselName);
                    showToast(`פרטי ${vesselName} עודכנו במאגר`, 'success');
                    renderVesselsTable();
                }
                return;
            }

            // Extract vessel data from parser response
            const vesselData = parserData.vessel || {};

            // Calculate next sequential ID
            const maxSeqId = referenceData.vessels.reduce((max, v) => Math.max(max, v.sequentialId || 0), 0);

            const newVessel = {
                id: Date.now().toString(),
                sequentialId: maxSeqId + 1,
                name: vesselName,
                flag: vesselData.flag || parserData.flag || '',
                yearBuilt: vesselData.yearBuilt || '',
                placeBuilt: vesselData.placeBuilt || '',
                class: vesselData.class || '',
                holds: vesselData.holds || '',
                hatches: vesselData.hatches || '',
                imo: vesselData.imoNumber || parserData.imoNumber || '',
                loa: vesselData.loa || '',
                beam: vesselData.beam || '',
                draft: vesselData.draft || '',
                dwt: vesselData.dwt || '',
                grain: vesselData.grainCapacity || '',
                bale: vesselData.bale || '',
                nrt: vesselData.net || '',
                grt: vesselData.gross || '',
                cranes: vesselData.cranes || '',
                dagonCompatible: vesselData.dagonCompatible || '',
                israeliPortNumber: vesselData.israeliPortNumber || ''
            };

            // Add to local array
            referenceData.vessels.push(newVessel);

            // Save to Firestore
            try {
                await db.collection('referenceData').doc('vessels').set({
                    items: referenceData.vessels,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Vessel added to reference database:', vesselName);
                renderVesselsTable();
            } catch (error) {
                console.error('Error adding vessel to reference database:', error);
            }
        }

        function editReferenceItem(type, index) {
            const item = referenceData[type][index];
            showAddReferenceModal(type);

            // Pre-fill the form after a short delay to ensure modal is rendered
            setTimeout(() => {
                if (type === 'vessels') {
                    document.getElementById('refItemName').value = item.name || '';
                    document.getElementById('refItemFlag').value = item.flag || '';
                    document.getElementById('refItemYearBuilt').value = item.yearBuilt || '';
                    document.getElementById('refItemHolds').value = item.holds || '';
                    document.getElementById('refItemImo').value = item.imo || '';
                    document.getElementById('refItemLoa').value = item.loa || '';
                    document.getElementById('refItemBeam').value = item.beam || '';
                    document.getElementById('refItemDwt').value = item.dwt || '';
                    document.getElementById('refItemGrain').value = item.grain || '';
                    document.getElementById('refItemBale').value = item.bale || '';
                    document.getElementById('refItemNrt').value = item.nrt || '';
                    document.getElementById('refItemGrt').value = item.grt || '';
                    document.getElementById('refItemDagonCompatible').value = item.dagonCompatible || '';
                    document.getElementById('refItemIsraeliPortNumber').value = item.israeliPortNumber || '';
                } else if (type === 'cargo') {
                    document.getElementById('refItemName').value = item.name || '';
                    document.getElementById('refItemCategory').value = item.category || '';
                    document.getElementById('refItemUnit').value = item.unit || 'MT';
                    document.getElementById('refItemNotes').value = item.notes || '';
                } else if (type === 'owners') {
                    document.getElementById('refItemName').value = item.name || '';
                    document.getElementById('refItemOwnerType').value = item.type || 'Owner';
                    document.getElementById('refItemCountry').value = item.country || '';
                    document.getElementById('refItemEmail').value = item.email || '';
                    document.getElementById('refItemPhone').value = item.phone || '';
                } else if (type === 'receivers') {
                    document.getElementById('refItemName').value = item.name || '';
                    document.getElementById('refItemCompany').value = item.company || '';
                    document.getElementById('refItemEmail').value = item.email || '';
                    document.getElementById('refItemPhone').value = item.phone || '';
                    document.getElementById('refItemAddress').value = item.address || '';
                }

                // Remove the old item (will be replaced when saved)
                referenceData[type].splice(index, 1);
            }, 100);
        }

        function showAiImportModal(type) {
            const typeLabels = {
                'vessels': 'אניות',
                'cargo': 'סוגי מטען',
                'owners': 'בעלים',
                'receivers': 'מקבלי מטען'
            };

            document.getElementById('modalTitle').textContent = `ייבוא חכם - ${typeLabels[type]}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">
                        הדבק רשימה או טקסט חופשי והמערכת תזהה אוטומטית את הפרטים
                    </p>
                    <textarea id="aiImportInput" rows="8" placeholder="לדוגמה:
ELA S - Panama - 9123456 - Bulk Carrier
LUCKY SAILOR - Marshall Islands - 9876543

או טקסט חופשי עם פרטי אניות..."
                        style="width: 100%; padding: 16px; border: 1px solid var(--glass-border); border-radius: 12px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeModal()" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                        ביטול
                    </button>
                    <button onclick="processAiImport('${type}')" style="padding: 12px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary), #6366f1); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        נתח וייבא
                    </button>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        async function processAiImport(type) {
            const input = document.getElementById('aiImportInput').value.trim();
            if (!input) {
                showToast('נא להזין טקסט', 'warning');
                return;
            }

            showToast('מנתח...', 'info');

            try {
                // Simple parsing for common patterns
                const lines = input.split('\n').filter(line => line.trim());
                let imported = 0;

                for (const line of lines) {
                    if (type === 'vessels') {
                        // Try to parse vessel info
                        const parts = line.split(/[-–,\t]+/).map(p => p.trim()).filter(p => p);
                        if (parts.length >= 1) {
                            const item = {
                                id: Date.now().toString() + imported,
                                name: parts[0],
                                flag: parts[1] || '',
                                imo: parts[2] || '',
                                type: parts[3] || '',
                                owner: parts[4] || ''
                            };

                            // Check if not duplicate
                            if (!referenceData.vessels.some(v => v.name.toLowerCase() === item.name.toLowerCase())) {
                                referenceData.vessels.push(item);
                                imported++;
                            }
                        }
                    }
                    // Add similar parsing for other types as needed
                }

                if (imported > 0) {
                    await db.collection('referenceData').doc(type).set({
                        items: referenceData[type],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    renderAllReferenceTables();
                    closeModal();
                    showToast(`יובאו ${imported} פריטים בהצלחה!`, 'success');
                } else {
                    showToast('לא נמצאו פריטים חדשים לייבוא', 'warning');
                }
            } catch (error) {
                console.error('AI import error:', error);
                showToast('שגיאה בייבוא', 'error');
            }
        }

        function populateDischargeShipSelector() {
            const select = document.getElementById('dischargeShipSelect');
            select.innerHTML = '<option value="">-- בחר אנייה --</option>';

            // Filter ships that are at port or under operation
            const relevantShips = ships.filter(s =>
                s.status === 'At Port' || s.status === 'Under Operation'
            );

            relevantShips.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship.id;
                option.textContent = ship.name;
                select.appendChild(option);
            });

            // Also add all other ships
            const otherShips = ships.filter(s =>
                s.status !== 'At Port' && s.status !== 'Under Operation'
            );

            if (otherShips.length > 0 && relevantShips.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '── אניות אחרות ──';
                select.appendChild(separator);
            }

            otherShips.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship.id;
                option.textContent = ship.name;
                select.appendChild(option);
            });
        }

        function loadDischargeData() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                resetDischargeView();
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            // Load discharge data from ship or initialize
            const dischargeData = ship.dischargeData || {
                totalCargo: ship.cargo?.weight || 0,
                discharged: 0,
                units: 0,
                dailyLog: [],
                remarks: []
            };

            updateDischargeProgress(dischargeData, ship);
            renderDailyLog(dischargeData.dailyLog);
        }

        function resetDischargeView() {
            document.getElementById('totalDischarged').textContent = '0';
            document.getElementById('totalUnits').textContent = '0';
            document.getElementById('totalDays').textContent = '0';
            document.getElementById('avgPerDay').textContent = '0';
            document.getElementById('dischargeProgressBar').style.width = '0%';
            document.getElementById('dischargeProgressBar').textContent = '0%';
            document.getElementById('dischargedAmount').textContent = '0';
            document.getElementById('remainingAmount').textContent = '0';
            document.getElementById('totalCargo').textContent = '0';
            document.getElementById('dailyLogContainer').innerHTML = `
                <div class="empty-state">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <p>אין נתוני פריקה עדיין</p>
                    <span>קלוט טאלי יומי להתחלת מעקב</span>
                </div>
            `;
        }

        function switchTallyInputTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tally-input-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.tally-input-tab').classList.add('active');

            // Update content visibility
            document.querySelectorAll('.tally-input-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tallyInput${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');

            // Set today's date for manual entry
            if (tab === 'manual') {
                document.getElementById('manualTallyDate').value = new Date().toISOString().split('T')[0];
            }
        }

        // ==================== MANUAL TALLY ENTRY ====================
        function addManualCargoEntry() {
            const container = document.getElementById('manualCargoEntries');
            const entry = document.createElement('div');
            entry.className = 'manual-cargo-entry';
            entry.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px;';
            entry.innerHTML = `
                <input type="text" placeholder="סוג מטען" class="cargo-type-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                <input type="number" placeholder="כמות" class="cargo-qty-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                <input type="number" step="0.001" placeholder="משקל MT" class="cargo-weight-input" style="padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-primary);">
                <button onclick="removeCargoEntry(this)" style="padding: 8px; border-radius: 6px; border: none; background: var(--danger-glow); color: var(--danger); cursor: pointer;">✕</button>
            `;
            container.appendChild(entry);
        }

        function removeCargoEntry(btn) {
            const entries = document.querySelectorAll('.manual-cargo-entry');
            if (entries.length > 1) {
                btn.closest('.manual-cargo-entry').remove();
            } else {
                showToast('חייב להיות לפחות שורת מטען אחת', 'warning');
            }
        }

        function saveManualTally() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                showToast('יש לבחור אנייה קודם', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) {
                showToast('אנייה לא נמצאה', 'error');
                return;
            }

            const date = document.getElementById('manualTallyDate').value;
            const shiftNum = document.getElementById('manualTallyShift').value;
            const gangs = document.getElementById('manualTallyGangs').value;
            const remarks = document.getElementById('manualTallyRemarks').value;

            // Collect cargo entries
            const cargoMoved = [];
            let totalQty = 0;
            let totalWeight = 0;

            document.querySelectorAll('.manual-cargo-entry').forEach(entry => {
                const type = entry.querySelector('.cargo-type-input').value.trim();
                const qty = parseFloat(entry.querySelector('.cargo-qty-input').value) || 0;
                const weight = parseFloat(entry.querySelector('.cargo-weight-input').value) || 0;

                if (type && (qty > 0 || weight > 0)) {
                    cargoMoved.push({ type, quantity: qty, weight });
                    totalQty += qty;
                    totalWeight += weight;
                }
            });

            if (cargoMoved.length === 0) {
                showToast('יש להזין לפחות סוג מטען אחד', 'warning');
                return;
            }

            // Create shift entry
            const shiftNames = { '1': 'משמרת 1 (06:30-14:30)', '2': 'משמרת 2 (14:30-22:30)', '3': 'משמרת 3 (22:30-06:30)' };
            const shiftEntry = {
                id: 'shift_' + Date.now(),
                date: date,
                name: shiftNames[shiftNum] || `משמרת ${shiftNum}`,
                gangs: gangs,
                cargoMoved: cargoMoved,
                shiftTotalQuantity: totalQty,
                shiftTotalWeight: totalWeight,
                remarks: remarks ? [remarks] : [],
                createdAt: new Date().toISOString()
            };

            // Initialize discharge data on ship if needed
            ship.dischargeData = ship.dischargeData || { shifts: [], remarks: [] };
            ship.dischargeData.shifts.push(shiftEntry);
            if (remarks) {
                ship.dischargeData.remarks.push({ date, text: remarks });
            }

            saveData();
            showToast(`משמרת נשמרה: ${totalWeight.toLocaleString()} MT`, 'success');

            // Clear form
            document.getElementById('manualTallyGangs').value = '';
            document.getElementById('manualTallyRemarks').value = '';
            document.querySelectorAll('.manual-cargo-entry input').forEach(inp => inp.value = '');

            // Refresh discharge view
            loadDischargeData();
        }

        // ==================== VOYAGE CONTACTS UI ====================
        function loadVoyageContacts() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            const section = document.getElementById('voyageContactsSection');
            const list = document.getElementById('voyageContactsList');
            const inheritHint = document.getElementById('inheritContactsHint');

            if (!shipId) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const voyageContacts = ship.voyageContacts || [];
            list.innerHTML = '';

            if (voyageContacts.length === 0) {
                list.innerHTML = '<span style="color: var(--text-tertiary); font-size: 12px;">אין אנשי קשר להפלגה זו</span>';

                // Check if there are contacts from previous voyage
                const prevContacts = findPreviousVoyageContacts(ship.name);
                if (prevContacts && prevContacts.contacts.length > 0) {
                    inheritHint.style.display = 'block';
                    inheritHint.querySelector('button').textContent = `ייבא ${prevContacts.contacts.length} אנשי קשר מהפלגה ${prevContacts.fromVoyage}`;
                } else {
                    inheritHint.style.display = 'none';
                }
            } else {
                inheritHint.style.display = 'none';
                voyageContacts.forEach(contact => {
                    const chip = document.createElement('div');
                    chip.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--success-glow); border: 1px solid var(--success); border-radius: 16px; font-size: 12px;';
                    chip.innerHTML = `
                        <span>${contact.name || contact.email.split('@')[0]}</span>
                        <button onclick="removeVoyageContact('${shipId}', '${contact.email}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 14px;">✕</button>
                    `;
                    list.appendChild(chip);
                });
            }
        }

        function removeVoyageContact(shipId, email) {
            if (confirm('להסיר איש קשר זה מההפלגה?')) {
                removeContactFromVoyage(shipId, email);
                loadVoyageContacts();
            }
        }

        function showAddVoyageContactModal() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                showToast('יש לבחור אנייה קודם', 'warning');
                return;
            }

            // Create simple prompt for email
            const email = prompt('הזן כתובת אימייל של איש הקשר:');
            if (email && email.includes('@')) {
                const name = prompt('שם איש הקשר (אופציונלי):') || '';
                addContactToVoyage(shipId, email, name);
                loadVoyageContacts();
            }
        }

        function inheritPreviousVoyageContacts() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const prevContacts = findPreviousVoyageContacts(ship.name);
            if (prevContacts && prevContacts.contacts.length > 0) {
                ship.voyageContacts = [...prevContacts.contacts];
                saveData();
                loadVoyageContacts();
                showToast(`${prevContacts.contacts.length} אנשי קשר יובאו בהצלחה`, 'success');
            }
        }

        // ==================== Port Status Functions ====================
        const portStatusFields = [
            'arrivedOnRoads', 'norTendered', 'pilotOnBoard', 'vesselBerthed',
            'dlCommenced', 'dlCompleted', 'pilotOrdered', 'sailed'
        ];

        function loadPortStatus() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                // Clear all fields
                portStatusFields.forEach(field => {
                    const dateEl = document.getElementById(`ps_${field}_date`);
                    const timeEl = document.getElementById(`ps_${field}_time`);
                    if (dateEl) dateEl.value = '';
                    if (timeEl) timeEl.value = '';
                });
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            // Initialize portStatus if not exists
            ship.portStatus = ship.portStatus || {};

            portStatusFields.forEach(field => {
                const dateEl = document.getElementById(`ps_${field}_date`);
                const timeEl = document.getElementById(`ps_${field}_time`);
                const data = ship.portStatus[field] || {};

                if (dateEl) dateEl.value = data.date || '';
                if (timeEl) timeEl.value = data.time || '';
            });
        }

        async function savePortStatus() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) return;

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            // Initialize portStatus if not exists
            ship.portStatus = ship.portStatus || {};

            // Collect all field values
            portStatusFields.forEach(field => {
                const dateEl = document.getElementById(`ps_${field}_date`);
                const timeEl = document.getElementById(`ps_${field}_time`);

                ship.portStatus[field] = {
                    date: dateEl?.value || null,
                    time: timeEl?.value || null
                };
            });

            ship.updatedAt = new Date().toISOString();

            // Save to Firestore
            try {
                await db.collection("ships").doc(ship.id).update({
                    portStatus: ship.portStatus,
                    updatedAt: ship.updatedAt
                });
            } catch (error) {
                console.error('Error saving port status:', error);
            }
        }

        function generateSOF() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                showToast('יש לבחור אנייה קודם', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const ps = ship.portStatus || {};
            const formatDateTime = (data) => {
                if (!data || (!data.date && !data.time)) return '____________';
                const dateStr = data.date ? new Date(data.date).toLocaleDateString('en-GB') : '';
                const timeStr = data.time || '';
                return `${dateStr} ${timeStr}`.trim() || '____________';
            };

            const manifest = ship.manifest || {};
            const cargoItems = manifest.items || [];
            const cargoList = cargoItems.length > 0
                ? cargoItems.map(c => `${c.type}: ${c.weight?.toLocaleString() || 0} ${c.unit || 'MT'}`).join('\n        ')
                : ship.cargo || 'N/A';

            const sofContent = `
═══════════════════════════════════════════════════════════════════
                    STATEMENT OF FACTS
═══════════════════════════════════════════════════════════════════

VESSEL:         ${ship.name || 'N/A'}
VOYAGE:         ${ship.voyage || 'N/A'}
PORT:           ${ship.port || 'ASHDOD'}
BERTH:          ${ship.berth || 'N/A'}

CARGO:
        ${cargoList}

TOTAL:          ${manifest.totalWeight?.toLocaleString() || '0'} MT / ${manifest.totalQuantity?.toLocaleString() || '0'} PCS

───────────────────────────────────────────────────────────────────
                    PORT STATUS TIMES
───────────────────────────────────────────────────────────────────

1. Arrived on Roads / ETA:         ${formatDateTime(ps.arrivedOnRoads)}
2. Notice of Readiness Tendered:   ${formatDateTime(ps.norTendered)}
3. Pilot on Board:                 ${formatDateTime(ps.pilotOnBoard)}
4. Vessel Berthed:                 ${formatDateTime(ps.vesselBerthed)}
5. D/L Commenced:                  ${formatDateTime(ps.dlCommenced)}
6. D/L Completed:                  ${formatDateTime(ps.dlCompleted)}
7. Pilot Ordered:                  ${formatDateTime(ps.pilotOrdered)}
8. Sailed:                         ${formatDateTime(ps.sailed)}

───────────────────────────────────────────────────────────────────

REMARKS:
${ship.notes || 'N/A'}

───────────────────────────────────────────────────────────────────
Generated: ${new Date().toLocaleString('en-GB')}
═══════════════════════════════════════════════════════════════════
`.trim();

            // Show in modal
            document.getElementById('modalTitle').textContent = 'Statement of Facts';
            document.getElementById('modalBody').innerHTML = `
                <div style="background: #1a1a2e; padding: 16px; border-radius: 8px; overflow: auto; max-height: 60vh;">
                    <pre style="font-family: 'Courier New', monospace; font-size: 12px; color: #e0e0e0; white-space: pre-wrap; margin: 0; direction: ltr; text-align: left;">${sofContent}</pre>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button onclick="closeModal()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;">
                        סגור
                    </button>
                    <button onclick="copySOFToClipboard()" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        העתק
                    </button>
                </div>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function copySOFToClipboard() {
            const sofPre = document.querySelector('#modalBody pre');
            if (sofPre) {
                navigator.clipboard.writeText(sofPre.textContent)
                    .then(() => showToast('הדוח הועתק ללוח', 'success'))
                    .catch(() => showToast('שגיאה בהעתקה', 'error'));
            }
        }

        // API endpoint for Claude analysis (using unified endpoint)
        const CLAUDE_API_ENDPOINT = '/api/analyze';

        async function parseTallyText() {
            const text = document.getElementById('tallyTextArea').value.trim();
            if (!text) {
                showToast('אנא הכנס טקסט לניתוח', 'warning');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#tallyInputText .parse-tally-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite;"></div> מעבד נתונים...';
            btn.disabled = true;

            try {
                const response = await fetch(CLAUDE_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parseType: 'tally', content: text })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API error');
                }

                if (data.parsed) {
                    currentTallyData = data.parsed;
                    displayParsedTally(data.parsed);
                    showToast('הטאלי נותח בהצלחה', 'success');
                } else if (data.raw) {
                    showToast('התקבל ניתוח אך לא בפורמט מובנה', 'warning');
                    console.log('Raw Claude response:', data.raw);
                } else {
                    throw new Error('No parsed data returned');
                }
            } catch (error) {
                console.error('Claude API error:', error);
                showToast(`שגיאה בניתוח: ${error.message}`, 'error');

                // Fallback to local parsing
                const localParsed = extractTallyData(text);
                if (localParsed) {
                    currentTallyData = localParsed;
                    displayParsedTally(localParsed);
                    showToast('נותח עם ניתוח מקומי (fallback)', 'info');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function extractTallyData(text) {
            const result = {
                date: null,
                shifts: [],
                totalQuantity: 0,
                totalWeight: 0,
                remarks: []
            };

            // Extract date
            const datePatterns = [
                /(?:Date|DATE|תאריך)[:\s]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i,
                /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/
            ];

            for (const pattern of datePatterns) {
                const dateMatch = text.match(pattern);
                if (dateMatch) {
                    result.date = dateMatch[1];
                    break;
                }
            }

            // If no date found, use today
            if (!result.date) {
                const today = new Date();
                result.date = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            }

            // Extract shifts
            const shiftPatterns = [
                /(?:Shift|SHIFT|משמרת)\s*(\d+)[^:]*[:\s]*(?:Gang|GANG|כנופייה)[s]?\s*([\d\-,\s]+)/gi,
                /(?:Shift|SHIFT|משמרת)\s*(\d+)\s*\(([^\)]+)\)/gi
            ];

            const lines = text.split('\n');
            let currentShift = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Check for shift header
                const shiftMatch = line.match(/(?:Shift|SHIFT|משמרת)\s*(\d+)/i);
                if (shiftMatch) {
                    if (currentShift) {
                        result.shifts.push(currentShift);
                    }

                    // Extract time if present
                    const timeMatch = line.match(/\(([^\)]+)\)/);
                    const gangMatch = line.match(/(?:Gang|GANG|כנופייה)[s]?\s*([\d\-,\s]+)/i);

                    currentShift = {
                        name: `Shift ${shiftMatch[1]}`,
                        time: timeMatch ? timeMatch[1] : '',
                        gangs: gangMatch ? gangMatch[1].trim() : '',
                        cargo: [],
                        quantity: 0,
                        weight: 0
                    };
                    continue;
                }

                // Check for cargo lines (start with - or have units/MT)
                if (currentShift) {
                    const cargoMatch = line.match(/[-•]?\s*([^:]+)[:\s]+(\d+[\d,\.]*)\s*(?:units?|pcs?|יחידות)?[,\s]+(\d+[\d,\.]*)\s*(?:MT|tons?|טון)?/i);
                    if (cargoMatch) {
                        const quantity = parseFloat(cargoMatch[2].replace(/,/g, ''));
                        const weight = parseFloat(cargoMatch[3].replace(/,/g, ''));

                        currentShift.cargo.push({
                            type: cargoMatch[1].trim(),
                            quantity: quantity,
                            weight: weight
                        });
                        currentShift.quantity += quantity;
                        currentShift.weight += weight;
                        result.totalQuantity += quantity;
                        result.totalWeight += weight;
                    }

                    // Also try simpler pattern
                    const simpleMatch = line.match(/(\d+[\d,\.]*)\s*(?:units?|pcs?|יחידות)[,\s]+(\d+[\d,\.]*)\s*(?:MT|tons?|טון)/i);
                    if (simpleMatch && !cargoMatch) {
                        const quantity = parseFloat(simpleMatch[1].replace(/,/g, ''));
                        const weight = parseFloat(simpleMatch[2].replace(/,/g, ''));

                        currentShift.cargo.push({
                            type: 'Cargo',
                            quantity: quantity,
                            weight: weight
                        });
                        currentShift.quantity += quantity;
                        currentShift.weight += weight;
                        result.totalQuantity += quantity;
                        result.totalWeight += weight;
                    }
                }

                // Check for remarks
                const remarksMatch = line.match(/(?:Remarks?|REMARKS?|הערות)[:\s]*(.*)/i);
                if (remarksMatch && remarksMatch[1].trim()) {
                    result.remarks.push(remarksMatch[1].trim());
                }
            }

            // Add last shift
            if (currentShift) {
                result.shifts.push(currentShift);
            }

            // If no shifts found, try to extract total values
            if (result.shifts.length === 0) {
                const totalMatch = text.match(/(?:Total|TOTAL|סה"כ)[:\s]*(\d+[\d,\.]*)\s*(?:units?)?[,\s]+(\d+[\d,\.]*)\s*(?:MT)?/i);
                if (totalMatch) {
                    result.totalQuantity = parseFloat(totalMatch[1].replace(/,/g, ''));
                    result.totalWeight = parseFloat(totalMatch[2].replace(/,/g, ''));
                    result.shifts.push({
                        name: 'Total',
                        time: '',
                        gangs: '',
                        cargo: [{ type: 'Cargo', quantity: result.totalQuantity, weight: result.totalWeight }],
                        quantity: result.totalQuantity,
                        weight: result.totalWeight
                    });
                }
            }

            // Extract any additional remarks
            const allRemarks = text.match(/(?:Rain|Breakdown|Stoppage|Delay|Weather|Accident|stopped|commenced|completed)[^\.]*\./gi);
            if (allRemarks) {
                allRemarks.forEach(r => {
                    if (!result.remarks.includes(r.trim())) {
                        result.remarks.push(r.trim());
                    }
                });
            }

            return result.shifts.length > 0 || result.totalWeight > 0 ? result : null;
        }

        function displayParsedTally(data) {
            document.getElementById('tallyResults').style.display = 'block';
            document.getElementById('parsedTallyDate').textContent = data.date || 'לא זוהה תאריך';
            document.getElementById('parsedTallyTime').textContent = new Date().toLocaleTimeString('he-IL');

            const container = document.getElementById('parsedShiftsContainer');
            container.innerHTML = '';

            // Get selected ship for remaining calculation
            const shipId = document.getElementById('dischargeShipSelect')?.value;
            const ship = shipId ? ships.find(s => s.id === shipId) : null;

            // Calculate cumulative from ship's discharge data
            let cumulativeWeight = 0;
            let cumulativeQty = 0;
            if (ship && ship.dischargeData && ship.dischargeData.shifts) {
                ship.dischargeData.shifts.forEach(shift => {
                    cumulativeWeight += shift.shiftTotalWeight || 0;
                    cumulativeQty += shift.shiftTotalQuantity || 0;
                });
            }

            // Handle new API format with cargo breakdown
            if (data.cargo && (data.cargo.declared || data.cargo.discharged)) {
                const cargoSummary = document.createElement('div');
                cargoSummary.className = 'tally-cargo-summary';
                cargoSummary.style.cssText = 'margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card)); border-radius: 12px; border: 1px solid var(--glass-border);';

                let summaryHtml = '<h4 style="margin-bottom: 12px; color: var(--text-primary); font-size: 15px;">📦 סיכום מטען:</h4>';

                // Declared cargo (from manifest)
                const declaredWeight = data.cargo.totalDeclaredWeight || 0;
                const declaredQty = data.cargo.totalDeclaredQuantity || 0;

                if (data.cargo.declared && data.cargo.declared.length > 0) {
                    summaryHtml += '<div style="margin-bottom: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;"><strong style="color: var(--text-secondary);">📋 מוצהר (מניפסט):</strong></div>';
                    data.cargo.declared.forEach(item => {
                        const weight = item.weightDeclared || 0;
                        const qty = item.quantityDeclared || 0;
                        summaryHtml += `<div style="padding: 6px 12px; font-size: 13px; display: flex; justify-content: space-between;">
                            <span>${item.type}</span>
                            <span style="font-weight: 600;">${weight.toLocaleString()} MT (${qty.toLocaleString()} ${item.quantityUnit || 'pcs'})</span>
                        </div>`;
                    });
                }

                // Cumulative discharged (from system tracking)
                const cumulativeSection = data.cumulativeTotals || { weight: cumulativeWeight, quantity: cumulativeQty };
                const totalDischarged = cumulativeSection.weight + (data.dailyTotals?.weight || 0);
                const totalDischargedQty = cumulativeSection.quantity + (data.dailyTotals?.quantity || 0);

                summaryHtml += `<div style="margin: 12px 0; padding: 10px; background: var(--success-glow); border-radius: 8px; border: 1px solid var(--success);">
                    <strong style="color: var(--success);">✓ נפרק עד כה:</strong>
                    <div style="font-size: 18px; font-weight: 700; margin-top: 6px;">${totalDischarged.toLocaleString()} MT (${totalDischargedQty.toLocaleString()} pcs)</div>
                </div>`;

                // Calculate remaining = manifest - cumulative discharged
                const manifestWeight = declaredWeight || (ship?.cargoWeight || 0);
                const manifestQty = declaredQty || 0;
                const remainingWeight = Math.max(0, manifestWeight - totalDischarged);
                const remainingQty = Math.max(0, manifestQty - totalDischargedQty);
                const percentComplete = manifestWeight > 0 ? Math.round((totalDischarged / manifestWeight) * 100) : 0;

                if (remainingWeight > 0 || remainingQty > 0) {
                    summaryHtml += `<div style="margin: 12px 0; padding: 10px; background: var(--warning-glow); border-radius: 8px; border: 1px solid var(--warning);">
                        <strong style="color: var(--warning);">⏳ נותר לפריקה:</strong>
                        <div style="font-size: 18px; font-weight: 700; margin-top: 6px;">${remainingWeight.toLocaleString()} MT (${remainingQty.toLocaleString()} pcs)</div>
                    </div>`;
                } else {
                    summaryHtml += `<div style="margin: 12px 0; padding: 10px; background: var(--success-glow); border-radius: 8px; border: 1px solid var(--success);">
                        <strong style="color: var(--success);">🎉 פריקה הושלמה!</strong>
                    </div>`;
                }

                // Progress bar
                summaryHtml += `<div style="margin-top: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 13px; color: var(--text-secondary);">התקדמות כללית</span>
                        <span style="font-size: 15px; font-weight: 700; color: var(--primary);">${percentComplete}%</span>
                    </div>
                    <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; width: ${percentComplete}%; background: linear-gradient(90deg, var(--primary), var(--success)); border-radius: 5px; transition: width 0.3s;"></div>
                    </div>
                </div>`;

                cargoSummary.innerHTML = summaryHtml;
                container.appendChild(cargoSummary);
            }

            // Today's shifts section header
            const shiftsHeader = document.createElement('div');
            shiftsHeader.style.cssText = 'margin: 16px 0 10px 0; font-weight: 600; color: var(--text-primary); font-size: 14px;';
            shiftsHeader.textContent = `📊 משמרות היום (${data.date || 'היום'}):`;
            container.appendChild(shiftsHeader);

            // Handle shifts - support both old and new format
            const shifts = data.shifts || [];
            shifts.forEach(shift => {
                const cargoItems = shift.cargo || shift.cargoMoved || [];
                const cargoDetails = cargoItems.map(c => c.type).join(', ') || 'Cargo';
                const quantity = shift.quantity ?? shift.shiftTotalQuantity ?? 0;
                const weight = shift.weight ?? shift.shiftTotalWeight ?? 0;

                const row = document.createElement('div');
                row.className = 'tally-shift-row';
                row.style.cssText = 'display: grid; grid-template-columns: 1fr 1.5fr 0.8fr 1fr; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; align-items: center;';
                row.innerHTML = `
                    <span class="tally-shift-name" style="font-weight: 600; color: var(--primary);">${shift.name || 'משמרת'}</span>
                    <span class="tally-cargo-details" style="font-size: 12px; color: var(--text-secondary);">${cargoDetails}</span>
                    <span class="tally-quantity" style="text-align: center;">${quantity.toLocaleString()}</span>
                    <span class="tally-weight" style="text-align: left; font-weight: 600;">${weight.toLocaleString()} MT</span>
                `;
                container.appendChild(row);
            });

            // Calculate totals for today
            const totalQuantity = data.totalQuantity ?? data.dailyTotals?.quantity ?? data.cargo?.totalDischargedQuantity ?? 0;
            const totalWeight = data.totalWeight ?? data.dailyTotals?.weight ?? data.cargo?.totalDischargedWeight ?? 0;

            // Add total row
            const totalRow = document.createElement('div');
            totalRow.className = 'tally-shift-row';
            totalRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1.5fr 0.8fr 1fr; gap: 8px; padding: 12px; background: linear-gradient(135deg, var(--primary-glow), transparent); border: 1px solid var(--primary); border-radius: 8px; margin-top: 8px; align-items: center;';
            totalRow.innerHTML = `
                <span style="font-weight: 700; color: var(--primary);">סה"כ היום</span>
                <span></span>
                <span style="text-align: center; font-weight: 600;">${totalQuantity.toLocaleString()}</span>
                <span style="text-align: left; font-weight: 700; font-size: 16px;">${totalWeight.toLocaleString()} MT</span>
            `;
            container.appendChild(totalRow);

            // Show remarks if any
            const remarks = data.remarks || [];
            if (remarks.length > 0) {
                document.getElementById('parsedRemarks').style.display = 'block';
                document.getElementById('parsedRemarksText').textContent = remarks.join('\n');
            } else {
                document.getElementById('parsedRemarks').style.display = 'none';
            }

            // Show stoppages if any
            if (data.stoppages && data.stoppages.length > 0) {
                let stoppagesHtml = '<div style="margin-top: 12px; padding: 12px; background: var(--warning-glow); border-radius: 8px; border: 1px solid var(--warning);">';
                stoppagesHtml += '<strong style="color: var(--warning);">⚠️ עצירות:</strong><br>';
                data.stoppages.forEach(s => {
                    stoppagesHtml += `<div style="font-size: 13px; margin-top: 6px; padding: 4px 8px; background: rgba(255,193,7,0.1); border-radius: 4px;">${s.reason}${s.duration ? ` (${s.duration})` : ''}${s.time ? ` - ${s.time}` : ''}</div>`;
                });
                stoppagesHtml += '</div>';
                document.getElementById('parsedRemarksText').innerHTML += stoppagesHtml;
                document.getElementById('parsedRemarks').style.display = 'block';
            }
        }

        // Drag and drop for image
        function setupDropZones() {
            const imageDropZone = document.getElementById('imageDropZone');
            const pdfDropZone = document.getElementById('pdfDropZone');

            if (imageDropZone) {
                imageDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageDropZone.classList.add('dragover');
                });
                imageDropZone.addEventListener('dragleave', () => {
                    imageDropZone.classList.remove('dragover');
                });
                imageDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageDropZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        handleTallyImageFile(file);
                    }
                });
            }

            if (pdfDropZone) {
                pdfDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pdfDropZone.classList.add('dragover');
                });
                pdfDropZone.addEventListener('dragleave', () => {
                    pdfDropZone.classList.remove('dragover');
                });
                pdfDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pdfDropZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type === 'application/pdf') {
                        handleTallyPdfFile(file);
                    }
                });
            }
        }

        function handleTallyImage(event) {
            const file = event.target.files[0];
            if (file) {
                handleTallyImageFile(file);
            }
        }

        function handleTallyImageFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                showToast('הקובץ גדול מדי (מקסימום 10MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;

                // Show preview
                const preview = document.getElementById('tallyImagePreview');
                preview.style.display = 'block';
                preview.innerHTML = `<img src="${currentImageData}" alt="Tally Image">`;

                // Show parse button
                document.getElementById('parseImageBtn').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        async function parseImageTally() {
            if (!currentImageData) {
                showToast('אנא העלה תמונה קודם', 'warning');
                return;
            }

            document.getElementById('imageProcessing').classList.add('active');
            document.querySelector('#imageProcessing span').textContent = 'מעבד תמונה...';

            try {
                // Extract base64 data and mime type from data URL
                const matches = currentImageData.match(/^data:(.+);base64,(.+)$/);
                if (!matches) {
                    throw new Error('Invalid image data');
                }

                const mimeType = matches[1];
                const base64Data = matches[2];

                const response = await fetch(CLAUDE_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parseType: 'tally',
                        imageBase64: base64Data,
                        mimeType: mimeType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API error');
                }

                if (data.parsed) {
                    currentTallyData = data.parsed;
                    displayParsedTally(data.parsed);
                    document.getElementById('tallyResults').style.display = 'block';
                    showToast('התמונה נותחה בהצלחה', 'success');
                } else if (data.raw) {
                    showToast('התקבל ניתוח אך לא בפורמט מובנה', 'warning');
                    console.log('Raw Claude response:', data.raw);
                } else {
                    throw new Error('No parsed data returned');
                }
            } catch (error) {
                console.error('Claude Vision API error:', error);
                showToast(`שגיאה בניתוח תמונה: ${error.message}`, 'error');
            } finally {
                document.getElementById('imageProcessing').classList.remove('active');
            }
        }

        function handleTallyPdf(event) {
            const file = event.target.files[0];
            if (file) {
                handleTallyPdfFile(file);
            }
        }

        function handleTallyPdfFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                showToast('הקובץ גדול מדי (מקסימום 10MB)', 'error');
                return;
            }

            currentPdfData = file;
            document.getElementById('pdfFileName').style.display = 'block';
            document.getElementById('pdfFileName').innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-left: 8px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                ${file.name}
            `;
            document.getElementById('parsePdfBtn').style.display = 'flex';
        }

        async function parsePdfTally() {
            if (!currentPdfData) {
                showToast('אנא העלה קובץ PDF קודם', 'warning');
                return;
            }

            document.getElementById('pdfProcessing').classList.add('active');
            document.querySelector('#pdfProcessing span').textContent = 'ממיר PDF לתמונה...';

            try {
                // Load PDF.js if not already loaded
                if (typeof pdfjsLib === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                // Read PDF file as array buffer
                const arrayBuffer = await currentPdfData.arrayBuffer();

                // Load PDF document
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                // Get first page
                const page = await pdf.getPage(1);

                // Set scale for good quality
                const scale = 2;
                const viewport = page.getViewport({ scale });

                // Create canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Render page to canvas
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                document.querySelector('#pdfProcessing span').textContent = 'מעבד מסמך...';

                // Convert canvas to base64
                const imageDataUrl = canvas.toDataURL('image/png');
                const matches = imageDataUrl.match(/^data:(.+);base64,(.+)$/);

                if (!matches) {
                    throw new Error('Failed to convert PDF to image');
                }

                const mimeType = matches[1];
                const base64Data = matches[2];

                // Send to Claude Vision
                const response = await fetch(CLAUDE_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parseType: 'tally',
                        imageBase64: base64Data,
                        mimeType: mimeType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API error');
                }

                if (data.parsed) {
                    currentTallyData = data.parsed;
                    displayParsedTally(data.parsed);
                    document.getElementById('tallyResults').style.display = 'block';
                    showToast('ה-PDF נותח בהצלחה', 'success');
                } else if (data.raw) {
                    showToast('התקבל ניתוח אך לא בפורמט מובנה', 'warning');
                    console.log('Raw Claude response:', data.raw);
                } else {
                    throw new Error('No parsed data returned');
                }
            } catch (error) {
                console.error('PDF parsing error:', error);
                showToast(`שגיאה בניתוח PDF: ${error.message}`, 'error');
            } finally {
                document.getElementById('pdfProcessing').classList.remove('active');
            }
        }

        // Helper to dynamically load scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function applyTallyToShip() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                showToast('אנא בחר אנייה קודם', 'warning');
                return;
            }

            if (!currentTallyData) {
                showToast('אין נתוני טאלי להחלה', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            // Initialize discharge data if not exists
            if (!ship.dischargeData) {
                ship.dischargeData = {
                    totalCargo: ship.cargo?.weight || 0,
                    discharged: 0,
                    units: 0,
                    dailyLog: [],
                    remarks: []
                };
            }

            // Add today's tally to the log
            const logEntry = {
                date: currentTallyData.date,
                timestamp: new Date().toISOString(),
                shifts: currentTallyData.shifts,
                quantity: currentTallyData.totalQuantity,
                weight: currentTallyData.totalWeight,
                remarks: currentTallyData.remarks
            };

            ship.dischargeData.dailyLog.push(logEntry);
            ship.dischargeData.discharged += currentTallyData.totalWeight;
            ship.dischargeData.units += currentTallyData.totalQuantity;
            ship.dischargeData.remarks = [...ship.dischargeData.remarks, ...currentTallyData.remarks];

            // Update in Firestore
            db.collection('ships').doc(ship.id).update({
                dischargeData: ship.dischargeData
            }).then(() => {
                showToast('נתוני הטאלי נוספו בהצלחה', 'success');
                addActivity('עדכון פריקה', `נוספו ${currentTallyData.totalWeight.toLocaleString()} MT לאנייה ${ship.name}`);

                // Update display
                updateDischargeProgress(ship.dischargeData, ship);
                renderDailyLog(ship.dischargeData.dailyLog);

                // Clear current data
                currentTallyData = null;
                document.getElementById('tallyResults').style.display = 'none';
                document.getElementById('tallyTextArea').value = '';
            }).catch(error => {
                console.error('Error updating discharge data:', error);
                showToast('שגיאה בשמירת הנתונים', 'error');
            });
        }

        function updateDischargeProgress(data, ship) {
            const totalCargo = data.totalCargo || ship.cargo?.weight || 0;
            const discharged = data.discharged || 0;
            const remaining = Math.max(0, totalCargo - discharged);
            const percentage = totalCargo > 0 ? Math.min(100, (discharged / totalCargo) * 100) : 0;
            const days = data.dailyLog?.length || 0;
            const avgPerDay = days > 0 ? Math.round(discharged / days) : 0;

            document.getElementById('totalDischarged').textContent = discharged.toLocaleString();
            document.getElementById('totalUnits').textContent = (data.units || 0).toLocaleString();
            document.getElementById('totalDays').textContent = days;
            document.getElementById('avgPerDay').textContent = avgPerDay.toLocaleString();

            document.getElementById('dischargeProgressBar').style.width = `${percentage}%`;
            document.getElementById('dischargeProgressBar').textContent = `${Math.round(percentage)}%`;

            document.getElementById('dischargedAmount').textContent = discharged.toLocaleString();
            document.getElementById('remainingAmount').textContent = remaining.toLocaleString();
            document.getElementById('totalCargo').textContent = totalCargo.toLocaleString();
        }

        function renderDailyLog(dailyLog) {
            const container = document.getElementById('dailyLogContainer');

            if (!dailyLog || dailyLog.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <p>אין נתוני פריקה עדיין</p>
                        <span>קלוט טאלי יומי להתחלת מעקב</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            // Sort by date descending
            const sortedLog = [...dailyLog].sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            sortedLog.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'daily-log-item';
                item.innerHTML = `
                    <div class="daily-log-date">${entry.date}</div>
                    <div class="daily-log-details">
                        <div class="daily-log-cargo">
                            <span><strong>כמות:</strong> ${entry.quantity.toLocaleString()} יחידות</span>
                            <span><strong>משקל:</strong> ${entry.weight.toLocaleString()} MT</span>
                            <span><strong>משמרות:</strong> ${entry.shifts.length}</span>
                        </div>
                        ${entry.remarks.length > 0 ? `<div class="daily-log-remarks">${entry.remarks.join(' | ')}</div>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function clearTallyData() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                // Just clear the form
                currentTallyData = null;
                currentImageData = null;
                currentPdfData = null;
                document.getElementById('tallyResults').style.display = 'none';
                document.getElementById('tallyTextArea').value = '';
                document.getElementById('tallyImagePreview').style.display = 'none';
                document.getElementById('parseImageBtn').style.display = 'none';
                document.getElementById('pdfFileName').style.display = 'none';
                document.getElementById('parsePdfBtn').style.display = 'none';
                showToast('הטופס נוקה', 'info');
                return;
            }

            if (!confirm('האם אתה בטוח שברצונך למחוק את כל נתוני הפריקה לאנייה זו?')) {
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            ship.dischargeData = {
                totalCargo: ship.cargo?.weight || 0,
                discharged: 0,
                units: 0,
                dailyLog: [],
                remarks: []
            };

            db.collection('ships').doc(ship.id).update({
                dischargeData: ship.dischargeData
            }).then(() => {
                showToast('נתוני הפריקה נמחקו', 'success');
                loadDischargeData();
            }).catch(error => {
                console.error('Error clearing discharge data:', error);
                showToast('שגיאה במחיקת הנתונים', 'error');
            });
        }

        function exportDischargeReport() {
            const shipId = document.getElementById('dischargeShipSelect').value;
            if (!shipId) {
                showToast('אנא בחר אנייה', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.dischargeData) {
                showToast('אין נתוני פריקה לייצוא', 'warning');
                return;
            }

            const data = ship.dischargeData;
            const totalCargo = data.totalCargo || 0;
            const discharged = data.discharged || 0;
            const remaining = totalCargo - discharged;
            const percentage = totalCargo > 0 ? ((discharged / totalCargo) * 100).toFixed(1) : 0;

            let report = `DISCHARGE REPORT\n`;
            report += `================\n\n`;
            report += `Vessel: ${ship.name}\n`;
            report += `Port: ${ship.port || 'N/A'}\n`;
            report += `Generated: ${new Date().toLocaleString('en-GB')}\n\n`;
            report += `SUMMARY\n`;
            report += `-------\n`;
            report += `Total Cargo: ${totalCargo.toLocaleString()} MT\n`;
            report += `Discharged: ${discharged.toLocaleString()} MT (${percentage}%)\n`;
            report += `Remaining: ${remaining.toLocaleString()} MT\n`;
            report += `Total Units: ${(data.units || 0).toLocaleString()}\n`;
            report += `Days of Discharge: ${data.dailyLog?.length || 0}\n`;
            report += `Average per Day: ${data.dailyLog?.length > 0 ? Math.round(discharged / data.dailyLog.length).toLocaleString() : 0} MT\n\n`;

            if (data.dailyLog && data.dailyLog.length > 0) {
                report += `DAILY LOG\n`;
                report += `---------\n`;
                data.dailyLog.forEach(entry => {
                    report += `\n${entry.date}:\n`;
                    report += `  Quantity: ${entry.quantity.toLocaleString()} units\n`;
                    report += `  Weight: ${entry.weight.toLocaleString()} MT\n`;
                    report += `  Shifts: ${entry.shifts.length}\n`;
                    if (entry.remarks.length > 0) {
                        report += `  Remarks: ${entry.remarks.join('; ')}\n`;
                    }
                });
            }

            if (data.remarks && data.remarks.length > 0) {
                report += `\nALL REMARKS\n`;
                report += `-----------\n`;
                data.remarks.forEach(r => {
                    report += `- ${r}\n`;
                });
            }

            // Create and download file
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Discharge_Report_${ship.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('הדוח יוצא בהצלחה', 'success');
        }

        function loadContacts() {
            // Load from Firestore
            db.collection('contacts').orderBy('name').onSnapshot(snapshot => {
                contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContacts();
            }, error => {
                console.error('Error loading contacts:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('shipops_contacts');
                contacts = saved ? JSON.parse(saved) : [];
                renderContacts();
            });
        }

        function loadEmailGroups() {
            // Load from Firestore
            db.collection('emailGroups').orderBy('name').onSnapshot(snapshot => {
                emailGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGroups();
            }, error => {
                console.error('Error loading groups:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('shipops_emailGroups');
                emailGroups = saved ? JSON.parse(saved) : [];
                renderGroups();
            });
        }

        function saveContacts() {
            localStorage.setItem('shipops_contacts', JSON.stringify(contacts));
        }

        function saveEmailGroups() {
            localStorage.setItem('shipops_emailGroups', JSON.stringify(emailGroups));
        }

        function renderContacts() {
            const list = document.getElementById('contactsList');
            const count = document.getElementById('contactsCount');

            if (!contacts || contacts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <p>אין אנשי קשר עדיין</p>
                        <button class="btn btn-primary btn-sm" onclick="openAddContactModal()">הוסף איש קשר</button>
                    </div>
                `;
                count.textContent = '0';
                return;
            }

            count.textContent = contacts.length;
            list.innerHTML = contacts.map(contact => `
                <div class="contact-item" data-id="${contact.id}">
                    <div class="contact-info">
                        <span class="contact-name">${contact.name}</span>
                        <span class="contact-email">${contact.email}</span>
                    </div>
                    <span class="contact-type ${contactTypes[contact.type]?.class || ''}">${contactTypes[contact.type]?.label || contact.type}</span>
                    <div class="contact-actions">
                        <button class="contact-btn" onclick="editContact('${contact.id}')" title="ערוך">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="contact-btn delete" onclick="deleteContact('${contact.id}')" title="מחק">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderGroups() {
            const list = document.getElementById('groupsList');
            const count = document.getElementById('groupsCount');

            if (!emailGroups || emailGroups.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <p>אין קבוצות עדיין</p>
                        <button class="btn btn-primary btn-sm" onclick="openAddGroupModal()">צור קבוצה</button>
                    </div>
                `;
                count.textContent = '0';
                return;
            }

            count.textContent = emailGroups.length;
            list.innerHTML = emailGroups.map(group => {
                const memberCount = group.contactIds ? group.contactIds.length : 0;
                return `
                    <div class="group-item" onclick="selectGroup('${group.id}')">
                        <div class="group-info">
                            <span class="group-name">${group.name}</span>
                            <span class="group-count">${memberCount} אנשי קשר</span>
                        </div>
                        <div class="group-actions">
                            <button class="contact-btn" onclick="event.stopPropagation(); editGroup('${group.id}')" title="ערוך">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="contact-btn delete" onclick="event.stopPropagation(); deleteGroup('${group.id}')" title="מחק">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterContacts() {
            const search = document.getElementById('contactSearch').value.toLowerCase();
            const items = document.querySelectorAll('#contactsList .contact-item');

            items.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                const email = item.querySelector('.contact-email').textContent.toLowerCase();
                item.style.display = (name.includes(search) || email.includes(search)) ? 'flex' : 'none';
            });
        }

        function openAddContactModal() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'הוספת איש קשר חדש';
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label>שם:</label>
                        <input type="text" id="contactName" placeholder="שם איש הקשר">
                    </div>
                    <div class="form-group">
                        <label>אימייל:</label>
                        <input type="email" id="contactEmail" placeholder="email@example.com" dir="ltr">
                    </div>
                    <div class="form-group">
                        <label>חברה:</label>
                        <input type="text" id="contactCompany" placeholder="שם החברה">
                    </div>
                    <div class="form-group">
                        <label>סוג:</label>
                        <select id="contactType">
                            <option value="agent">סוכן</option>
                            <option value="port">נמל</option>
                            <option value="owner">בעלים</option>
                            <option value="charterer">שוכר</option>
                            <option value="receiver">מקבל</option>
                            <option value="other">אחר</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button class="btn btn-primary" onclick="saveNewContact()">שמור</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function saveNewContact() {
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const company = document.getElementById('contactCompany').value.trim();
            const type = document.getElementById('contactType').value;

            if (!name || !email) {
                showToast('נא למלא שם ואימייל', 'warning');
                return;
            }

            const newContact = {
                name,
                email,
                company,
                type,
                createdAt: new Date().toISOString()
            };

            try {
                await db.collection('contacts').add(newContact);
                showToast('איש קשר נוסף בהצלחה', 'success');
            } catch (error) {
                console.error('Error saving contact:', error);
                // Fallback to local
                newContact.id = 'contact_' + Date.now();
                contacts.push(newContact);
                saveContacts();
                renderContacts();
                showToast('איש קשר נוסף (מקומי)', 'success');
            }

            closeModal();
        }

        function editContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'עריכת איש קשר';
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label>שם:</label>
                        <input type="text" id="contactName" value="${contact.name || ''}">
                    </div>
                    <div class="form-group">
                        <label>אימייל:</label>
                        <input type="email" id="contactEmail" value="${contact.email || ''}" dir="ltr">
                    </div>
                    <div class="form-group">
                        <label>חברה:</label>
                        <input type="text" id="contactCompany" value="${contact.company || ''}">
                    </div>
                    <div class="form-group">
                        <label>סוג:</label>
                        <select id="contactType">
                            ${Object.entries(contactTypes).map(([key, val]) =>
                                `<option value="${key}" ${contact.type === key ? 'selected' : ''}>${val.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button class="btn btn-primary" onclick="updateContact('${contactId}')">שמור</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function updateContact(contactId) {
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const company = document.getElementById('contactCompany').value.trim();
            const type = document.getElementById('contactType').value;

            if (!name || !email) {
                showToast('נא למלא שם ואימייל', 'warning');
                return;
            }

            try {
                await db.collection('contacts').doc(contactId).update({ name, email, company, type });
                showToast('איש קשר עודכן', 'success');
            } catch (error) {
                console.error('Error updating contact:', error);
                const idx = contacts.findIndex(c => c.id === contactId);
                if (idx !== -1) {
                    contacts[idx] = { ...contacts[idx], name, email, company, type };
                    saveContacts();
                    renderContacts();
                }
                showToast('איש קשר עודכן (מקומי)', 'success');
            }

            closeModal();
        }

        async function deleteContact(contactId) {
            if (!confirm('האם למחוק את איש הקשר?')) return;

            try {
                await db.collection('contacts').doc(contactId).delete();
                showToast('איש קשר נמחק', 'success');
            } catch (error) {
                console.error('Error deleting contact:', error);
                contacts = contacts.filter(c => c.id !== contactId);
                saveContacts();
                renderContacts();
                showToast('איש קשר נמחק (מקומי)', 'success');
            }
        }

        function openAddGroupModal() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'יצירת קבוצת מייל חדשה';
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label>שם הקבוצה:</label>
                        <input type="text" id="groupName" placeholder="לדוגמה: אשדוד - ARM Shipping">
                    </div>
                    <div class="form-group">
                        <label>בחר אנשי קשר:</label>
                        <div class="checkbox-list" id="groupContactsList">
                            ${contacts.map(c => `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="gc_${c.id}" value="${c.id}">
                                    <label for="gc_${c.id}">${c.name} (${c.email})</label>
                                </div>
                            `).join('')}
                            ${contacts.length === 0 ? '<p style="color: var(--text-tertiary); text-align: center;">אין אנשי קשר. הוסף אנשי קשר קודם.</p>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button class="btn btn-primary" onclick="saveNewGroup()">צור קבוצה</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function saveNewGroup() {
            const name = document.getElementById('groupName').value.trim();
            const checkboxes = document.querySelectorAll('#groupContactsList input[type="checkbox"]:checked');
            const contactIds = Array.from(checkboxes).map(cb => cb.value);

            if (!name) {
                showToast('נא להזין שם לקבוצה', 'warning');
                return;
            }

            if (contactIds.length === 0) {
                showToast('נא לבחור לפחות איש קשר אחד', 'warning');
                return;
            }

            const newGroup = {
                name,
                contactIds,
                createdAt: new Date().toISOString()
            };

            try {
                await db.collection('emailGroups').add(newGroup);
                showToast('קבוצה נוצרה בהצלחה', 'success');
            } catch (error) {
                console.error('Error saving group:', error);
                newGroup.id = 'group_' + Date.now();
                emailGroups.push(newGroup);
                saveEmailGroups();
                renderGroups();
                showToast('קבוצה נוצרה (מקומי)', 'success');
            }

            closeModal();
        }

        function editGroup(groupId) {
            const group = emailGroups.find(g => g.id === groupId);
            if (!group) return;

            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'עריכת קבוצה';
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label>שם הקבוצה:</label>
                        <input type="text" id="groupName" value="${group.name || ''}">
                    </div>
                    <div class="form-group">
                        <label>בחר אנשי קשר:</label>
                        <div class="checkbox-list" id="groupContactsList">
                            ${contacts.map(c => `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="gc_${c.id}" value="${c.id}" ${group.contactIds?.includes(c.id) ? 'checked' : ''}>
                                    <label for="gc_${c.id}">${c.name} (${c.email})</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button class="btn btn-primary" onclick="updateGroup('${groupId}')">שמור</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function updateGroup(groupId) {
            const name = document.getElementById('groupName').value.trim();
            const checkboxes = document.querySelectorAll('#groupContactsList input[type="checkbox"]:checked');
            const contactIds = Array.from(checkboxes).map(cb => cb.value);

            if (!name) {
                showToast('נא להזין שם לקבוצה', 'warning');
                return;
            }

            try {
                await db.collection('emailGroups').doc(groupId).update({ name, contactIds });
                showToast('קבוצה עודכנה', 'success');
            } catch (error) {
                console.error('Error updating group:', error);
                const idx = emailGroups.findIndex(g => g.id === groupId);
                if (idx !== -1) {
                    emailGroups[idx] = { ...emailGroups[idx], name, contactIds };
                    saveEmailGroups();
                    renderGroups();
                }
                showToast('קבוצה עודכנה (מקומי)', 'success');
            }

            closeModal();
        }

        async function deleteGroup(groupId) {
            if (!confirm('האם למחוק את הקבוצה?')) return;

            try {
                await db.collection('emailGroups').doc(groupId).delete();
                showToast('קבוצה נמחקה', 'success');
            } catch (error) {
                console.error('Error deleting group:', error);
                emailGroups = emailGroups.filter(g => g.id !== groupId);
                saveEmailGroups();
                renderGroups();
                showToast('קבוצה נמחקה (מקומי)', 'success');
            }
        }

        function selectGroup(groupId) {
            const group = emailGroups.find(g => g.id === groupId);
            if (!group) return;

            // Add all group contacts to selected recipients
            group.contactIds.forEach(contactId => {
                const contact = contacts.find(c => c.id === contactId);
                if (contact && !selectedRecipients.find(r => r.id === contact.id)) {
                    selectedRecipients.push({ ...contact, fromGroup: group.name });
                }
            });

            renderRecipients();
            updateEmailPreview();
            showToast(`נוספו ${group.contactIds.length} נמענים מקבוצה "${group.name}"`, 'success');
        }

        function openRecipientSelector() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = 'בחירת נמענים';
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                    <div>
                        <h4 style="margin-bottom: var(--spacing-sm);">קבוצות מייל</h4>
                        <div class="checkbox-list">
                            ${emailGroups.map(g => `
                                <div class="checkbox-item" onclick="addGroupToRecipients('${g.id}')">
                                    <span style="flex: 1;">📁 ${g.name} (${g.contactIds?.length || 0})</span>
                                    <button class="btn btn-sm btn-primary">הוסף</button>
                                </div>
                            `).join('')}
                            ${emailGroups.length === 0 ? '<p style="color: var(--text-tertiary);">אין קבוצות</p>' : ''}
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: var(--spacing-sm);">אנשי קשר</h4>
                        <div class="checkbox-list" style="max-height: 250px;">
                            ${contacts.map(c => `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="rec_${c.id}" value="${c.id}" ${selectedRecipients.find(r => r.id === c.id) ? 'checked' : ''}>
                                    <label for="rec_${c.id}">${c.name} (${c.email})</label>
                                </div>
                            `).join('')}
                            ${contacts.length === 0 ? '<p style="color: var(--text-tertiary);">אין אנשי קשר</p>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal()">סגור</button>
                        <button class="btn btn-primary" onclick="applySelectedRecipients()">החל</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        function addGroupToRecipients(groupId) {
            selectGroup(groupId);
            closeModal();
            openRecipientSelector(); // Reopen to show updated state
        }

        function applySelectedRecipients() {
            const checkboxes = document.querySelectorAll('.checkbox-list input[type="checkbox"]:checked');
            selectedRecipients = [];

            checkboxes.forEach(cb => {
                const contact = contacts.find(c => c.id === cb.value);
                if (contact) {
                    selectedRecipients.push(contact);
                }
            });

            renderRecipients();
            updateEmailPreview();
            closeModal();
        }

        function renderRecipients() {
            const container = document.getElementById('composerRecipients');

            if (selectedRecipients.length === 0) {
                container.innerHTML = '<button class="add-recipient-btn" onclick="openRecipientSelector()">+ הוסף נמענים</button>';
                return;
            }

            container.innerHTML = selectedRecipients.map(r => `
                <span class="recipient-tag ${r.fromGroup ? 'group' : ''}">
                    ${r.name}
                    <span class="remove" onclick="removeRecipient('${r.id}')">&times;</span>
                </span>
            `).join('') + '<button class="add-recipient-btn" onclick="openRecipientSelector()">+</button>';
        }

        function removeRecipient(contactId) {
            selectedRecipients = selectedRecipients.filter(r => r.id !== contactId);
            renderRecipients();
            updateEmailPreview();
        }

        function populateShipSelector() {
            const select = document.getElementById('shipSelectForEmail');
            if (!select) return;

            select.innerHTML = '<option value="">בחר אנייה...</option>' +
                ships.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        function updateEmailPreview() {
            const shipId = document.getElementById('shipSelectForEmail')?.value;
            const ship = ships.find(s => s.id === shipId);
            const preview = document.getElementById('emailPreview');
            const subjectInput = document.getElementById('emailSubject');

            if (!ship) {
                preview.textContent = 'בחר אנייה ונמענים ליצירת הדוח...';
                return;
            }

            // Generate subject
            const today = new Date().toLocaleDateString('en-GB');
            const subject = `${ship.name} ${ship.voyage || ''} - Daily Report ${today}`;
            if (subjectInput) subjectInput.value = subject;

            // Generate email body
            const body = generateEmailBody(ship);
            preview.textContent = body;
        }

        function generateEmailBody(ship) {
            const today = new Date().toLocaleDateString('en-GB');
            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            let body = `Daily Report\n${today} ${time}\n\n`;
            body += `Vessel: ${ship.name}\n`;
            if (ship.voyage) body += `Voyage: ${ship.voyage}\n`;
            body += `Port: ${ship.port || 'N/A'}\n\n`;

            if (ship.cargo) {
                body += `Cargo (declared):\n${ship.cargo}\n\n`;
            }

            // Add timeline if exists
            if (ship.eta) {
                const etaDate = new Date(ship.eta);
                body += `ETA: ${etaDate.toLocaleDateString('en-GB')} ${etaDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}\n`;
            }
            if (ship.etb?.displayValue) {
                body += `ETB: ${ship.etb.displayValue}\n`;
            }

            body += `Status: ${ship.status}\n\n`;

            // Add services if any
            if (ship.services && ship.services.length > 0) {
                body += `Services:\n`;
                ship.services.forEach(s => {
                    body += `- ${getServiceTypeName(s.type)}: ${formatServiceDetails(s)} (${s.status})\n`;
                });
                body += '\n';
            }

            if (ship.notes) {
                body += `Notes:\n${ship.notes}\n\n`;
            }

            body += `Best Regards`;

            return body;
        }

        function openInOutlook() {
            if (selectedRecipients.length === 0) {
                showToast('נא לבחור נמענים', 'warning');
                return;
            }

            const shipId = document.getElementById('shipSelectForEmail')?.value;
            if (!shipId) {
                showToast('נא לבחור אנייה', 'warning');
                return;
            }

            const ship = ships.find(s => s.id === shipId);
            const emails = selectedRecipients.map(r => r.email).join(',');
            const subject = document.getElementById('emailSubject')?.value || '';
            const body = generateEmailBody(ship);

            // Create mailto link
            const mailtoLink = `mailto:${emails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // Open in Outlook/default mail client
            window.location.href = mailtoLink;

            showToast('נפתח ב-Outlook...', 'success');
            addActivity('דוח מייל', `הוכן דוח לאנייה ${ship.name}`);
        }

        function updateStats() {
            document.getElementById('totalShips').textContent = ships.length;
            document.getElementById('atSeaCount').textContent = ships.filter(s => s.status === 'At Sea').length;
            document.getElementById('atPortCount').textContent = ships.filter(s => s.status === 'At Port').length;
            document.getElementById('underOperationCount').textContent = ships.filter(s => s.status === 'Under Operation').length;
            
            // Calculate urgent tasks using the new task system
            let urgentCount = 0;
            ships.forEach(ship => {
                if (ship.tasks && Array.isArray(ship.tasks)) {
                    ship.tasks.forEach(task => {
                        if (task.status !== 'done' && taskUrgency(task, ship) === 'urgent') {
                        urgentCount++;
                    }
                });
                }
            });
            document.getElementById('urgentTasks').textContent = urgentCount;
        }

        function updateBadges() {
            document.getElementById('allBadge').textContent = ships.length;
            document.getElementById('underOperationBadge').textContent = ships.filter(s => s.status === 'Under Operation').length;
            document.getElementById('atPortBadge').textContent = ships.filter(s => s.status === 'At Port').length;
            document.getElementById('atSeaBadge').textContent = ships.filter(s => s.status === 'At Sea').length;
            document.getElementById('sailedBadge').textContent = ships.filter(s => s.status === 'Sailed').length;
            document.getElementById('quickBadge').textContent = ships.length;
        }

        function toggleActivityFeed() {
            const feed = document.getElementById('activityFeed');
            feed.classList.toggle('active');
        }


        function clearAllData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים ולהתחיל מחדש?')) {
                localStorage.clear();
                sessionStorage.clear();
                ships = [];
                activities = [];
                archived = [];
                fileHandle = null;
                renderShips();
                updateStats();
                updateActivities();
                showToast('כל הנתונים נמחקו', 'success');
                addActivity('מחיקת נתונים', 'כל הנתונים נמחקו מהמערכת');
            }
        }

        function clearLocalStorage() {
            clearAllData();
        }

        function toggleActivityFeed() {
            const feed = document.getElementById('activityFeed');
            if (feed) {
                feed.classList.toggle('active');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update icon
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (newTheme === 'light') {
                    themeIcon.innerHTML = `
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    `;
                } else {
                    themeIcon.innerHTML = `
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    `;
                }
            }
        }

        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            if (savedTheme === 'light') {
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
                }
            }
        }


        async function fullReset() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים ולטעון מחדש מהקובץ החיצוני?')) {
                localStorage.clear();
                ships = [];
                await loadData();
                renderShips();
                updateStats();
                updateActivities();
                showToast('המערכת אופסה ונטענה מחדש', 'success');
                addActivity('איפוס מלא', 'כל הנתונים נמחקו ונטענו מחדש מהקובץ');
            }
        }

        async function loadFromExternalFile() {
            try {
                showToast('טוען נתונים מהקובץ...', 'info');
                
                const response = await fetch('./imports/Report.xls');
                if (!response.ok) {
                    console.log('Could not load external file, status:', response.status);
                    showToast('לא ניתן לטעון את הקובץ (קובץ לא נמצא)', 'error');
                    return;
                }
                
                const htmlContent = await response.text();
                console.log('File content length:', htmlContent.length);
                
                if (htmlContent.length < 100) {
                    showToast('הקובץ ריק או לא תקין', 'error');
                    return;
                }
                
                const newShips = parseShipDataFromHTML(htmlContent);
                
                // Replace existing ships with new ones
                ships = newShips;
                console.log('Loaded ships from external file:', ships.length);
                
                if (ships.length > 0) {
                    // Save to localStorage for future use
                    saveData();
                    showToast(`נטענו ${ships.length} אניות מהקובץ`, 'success');
                    addActivity('טעינת נתונים', `${ships.length} אניות נטענו מהקובץ החיצוני`);
                } else {
                    showToast('לא נמצאו אניות בקובץ', 'warning');
                }
                } catch (error) {
                console.error('Error loading external file:', error);
                showToast('שגיאה בטעינת הקובץ: ' + error.message, 'error');
            }
        }

        function parseShipDataFromHTML(htmlContent) {
            const ships = [];
            
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const rows = doc.querySelectorAll('tbody tr');
                
                console.log('Found rows:', rows.length);
                
                rows.forEach((row, index) => {
                    try {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 13) {
                            const nameCell = cells[1].textContent.trim();
                            const nameMatch = nameCell.match(/^(.+?)\s*-\s*(.+)$/);
                            const shipName = nameMatch ? nameMatch[1].trim() : nameCell;
                            const voyage = nameMatch ? nameMatch[2].trim() : '';
                            
                            const portAbroad = cells[2].textContent.trim();
                            const port = cells[3].textContent.trim();
                            const status = cells[5].textContent.trim();
                            const eta = cells[6].textContent.trim();
                            const cargo = cells[7].textContent.trim();
                            const owner = cells[9].textContent.trim();
                            const supplier = cells[10].textContent.trim();
                            const receivers = cells[11].textContent.trim();
                            const pic = cells[13].textContent.trim();
                            
                            console.log(`Ship ${index + 1}: ${shipName} - ${status}`);
                            
                            // Convert status to our format
                            let convertedStatus = 'At Sea';
                            if (status === 'Sailed') convertedStatus = 'Sailed';
                            else if (status === 'At Port') convertedStatus = 'At Port';
                            else if (status === 'Under Operation') convertedStatus = 'Under Operation';
                            
                            // Parse ETA date
                            let etaDate = new Date();
                            if (eta && eta !== '' && eta !== '23/10') {
                                try {
                                    // Handle different date formats
                                    if (eta.includes('/')) {
                                        const parts = eta.split(' ');
                                        const datePart = parts[0];
                                        const timePart = parts[1] || '00:00';
                                        
                                        if (datePart.includes('/')) {
                                            const [day, month] = datePart.split('/');
                                            const currentYear = new Date().getFullYear();
                                            etaDate = new Date(`${currentYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}:00`);
                                        }
                                    }
                                } catch (e) {
                                    console.log('Error parsing date:', eta, e);
                                }
                            }
                            
                            const ship = {
                                id: (index + 1).toString(),
                                name: shipName,
                                voyage: voyage,
                                status: convertedStatus,
                                port: port,
                                eta: etaDate.toISOString(),
                                cargo: cargo,
                                owner: owner,
                                supplier: supplier,
                                receivers: receivers,
                                notes: '',
                                trader: pic,
                                waterSupply: false,
                                waterAmount: '',
                                package: false,
                                packageWeight: '',
                                trackingNumber: '',
                                estimatedDischargeStart: '',
                                estimatedDischargeEnd: '',
                                checklist: createChecklist(),
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                            ships.push(ship);
                        }
                    } catch (rowError) {
                        console.error(`Error processing row ${index + 1}:`, rowError);
                    }
                });
                
                console.log('Parsed ships:', ships.length);
            } catch (error) {
                console.error('Error parsing HTML:', error);
            }
            
            return ships;
        }

        // ==================== Import & Merge Functions ====================
        async function importExcel() {
            document.getElementById('fileInput').click();
        }

        function handleFileUpload(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            
            console.log('File selected:', file.name, file.size, 'bytes');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                console.log('File read successfully, processing...');
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { defval: null, raw: true, blankrows:false });

                console.log('Excel data converted to JSON:', rows.length, 'rows');
                console.log('First few rows:', rows.slice(0, 3));
                console.log('Column names in first row:', Object.keys(rows[0] || {}));

                const mapped = mapRows(rows);                  // מיפוי כותרות
                console.log('Mapped rows:', mapped.length);
                console.log('Sample mapped row:', mapped[0]);
                
                const filtered = mapped.filter(isRelevant);    // I בלבד + Steel ללא Scrap
                console.log('Filtered rows:', filtered.length);
                console.log('Sample filtered row:', filtered[0]);
                
                const normalized = filtered.map(normalizeShip);// נירמול + id + שדות חסרים
                console.log('Normalized ships:', normalized.length);
                console.log('Sample normalized ship:', normalized[0]);
                
                // קרא לפונקציית המיזוג החדשה
                await mergeShips(normalized);

                // אין צורך ב-saveData או renderShips, ה-listener יטפל בזה.
            };
            reader.readAsArrayBuffer(file);
            // אפס קלט לקבצים
            evt.target.value = '';
        }

        // פונקציית עזר חדשה לקריאת ערך לפי מספר שמות אפשריים
        function getValue(row, possibleKeys) {
            for (const key of possibleKeys) {
                if (row[key] !== undefined && row[key] !== null) {
                    return row[key];
                }
            }
            return null; // אם אף מפתח לא נמצא
        }

        function mapRows(rows) {
            console.log("Starting mapRows for", rows.length, "rows.");
            return rows.map((r, index) => {
                const mappedRow = {
                    // נסה למצוא כל שדה תחת מספר שמות נפוצים
                    Name: getValue(r, ['Name', 'Vessel', 'שם אנייה', 'שם']),
                    Port: getValue(r, ['Port', 'נמל פריקה', 'נמל']),
                    IE: getValue(r, ['I/E', 'I\\E', 'IE', 'י/י']),
                    Status: getValue(r, ['Status', 'סטטוס']),
                    ETA: getValue(r, ['ETA', 'צפי הגעה']) ? excelToISO(getValue(r, ['ETA', 'צפי הגעה'])) : null,
                    Cargo: getValue(r, ['Cargo', 'מטען']),
                    Owner: getValue(r, ['Owner', 'בעלים']),
                    Supplier: getValue(r, ['Supplier', 'ספק']),
                    Receivers: getValue(r, ['Receivers', 'מטענים']),
                    Alerts: getValue(r, ['Alerts', 'הערות']),
                    PIC: getValue(r, ['PIC', 'אחראי', 'סוכן'])
                };
                // console.log(`Row ${index} mapped:`, mappedRow); // Uncomment for detailed debugging
                return mappedRow;
            });
        }

        function excelToISO(v) {
            if (!v) return null;
            let date = null;

            // 1. אם זה מספר (תאריך סריאלי של אקסל)
            if (typeof v === 'number') {
                // המר את המספר לתאריך JavaScript
                // מספר הימים בין 1900-01-01 (כולל) ל-1970-01-01 (לא כולל) הוא 25569 באקסל (כולל יום מעובר ב-1900)
                const d = new Date(Math.round((v - 25569) * 86400 * 1000));
                // בדוק אם התאריך תקין ולוגי (משנת 2023 ואילך)
                if (!isNaN(+d) && d.getFullYear() >= 2023) {
                     date = d;
                } else {
                     console.warn('Excel serial date is invalid or before 2023:', v);
                }
            }
            // 2. אם זו מחרוזת
            else if (typeof v === 'string') {
                v = v.trim();
                if (v === "") return null;

                let parsedDate = null;

                // נסה פורמט ישראלי ארוך: DD/MM/YYYY (עם או בלי שעה)
                const israeliMatch = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
                if (israeliMatch) {
                    const [, day, month, year, hour = 0, minute = 0] = israeliMatch;
                    parsedDate = new Date(year, month - 1, day, hour, minute);
                } else {
                    // נסה פורמט ישראלי קצר: DD/MM (עם או בלי שעה, מניח שנה נוכחית או הבאה)
                    const shortMatch = v.match(/^(\d{1,2})\/(\d{1,2})(?:\s+(\d{1,2}):(\d{2}))?/);
                    if (shortMatch) {
                        const [, day, month, hour = 0, minute = 0] = shortMatch;
                        const currentYear = new Date().getFullYear();
                        const potentialDate = new Date(currentYear, month - 1, day, hour, minute);

                        // בדוק אם התאריך בעבר (למשל, היום ינואר והתאריך דצמבר)
                        const now = new Date();
                        now.setHours(0,0,0,0); // אפס שעה להשוואה
                        if (!isNaN(+potentialDate) && potentialDate < now) {
                            // אם בעבר, נניח שמדובר בשנה הבאה
                            parsedDate = new Date(currentYear + 1, month - 1, day, hour, minute);
                        } else if (!isNaN(+potentialDate)) {
                            parsedDate = potentialDate; // אם בעתיד או היום, השתמש בשנה הנוכחית
                        }
                    } else {
                        // ניסיון אחרון: תן לדפדפן לנסות (לפורמטי ISO וכו')
                        parsedDate = new Date(v);
                    }
                }

                // בדוק אם התאריך שפירסרנו תקין והגיוני (משנת 2023 ואילך)
                if (parsedDate && !isNaN(+parsedDate) && parsedDate.getFullYear() >= 2023) {
                     date = parsedDate;
                } else {
                     console.warn('Could not parse valid date string or date is before 2023:', v);
                }
            }

            // אם הצלחנו לפרסר תאריך תקין, החזר ISO string, אחרת null
            return date ? date.toISOString() : null;
        }

        function isRelevant(row) {
            const ieValue = (row.IE || '').trim().toUpperCase();
            if (ieValue !== 'I') {
                // console.log("Filtered out (not Import):", row.Name); // Uncomment for debugging
                return false;
            }
            const cargo = (row.Cargo || '').toString().toLowerCase();
            if (!cargo || cargo.includes('scrap')) {
                // console.log("Filtered out (Scrap or no cargo):", row.Name, cargo); // Uncomment for debugging
                return false;
            }
            const isSteel = STEEL_WHITELIST.some(t => cargo.includes(t));
            if (!isSteel) {
                // console.log("Filtered out (Not in STEEL_WHITELIST):", row.Name, cargo); // Uncomment for debugging
            }
            return isSteel; // רק אם נמצא ברשימה הלבנה
        }

        function extractVoyage(name){
            // "Lodestar Capella - 002/25" -> "002/25"
            const m = (name||'').match(/-\s*([0-9]{3}\/[0-9]{2})\b/);
            return m ? m[1] : null;
        }

        function normalizeShip(row){
            const voyage = extractVoyage(row.Name);
            const name = (row.Name||'').replace(/\s*-\s*[0-9]{3}\/[0-9]{2}\b/,'').trim();
            const obj = {
                id: VESSEL_ID(name, voyage),
                name, voyage,
                status: row.Status || STATUS.AT_SEA,
                port: row.Port || null,
                eta: row.ETA || null,
                cargo: row.Cargo || null,
                owner: row.Owner || null,
                supplier: row.Supplier || null,
                receivers: row.Receivers || null,
                alerts: row.Alerts || null,
                pic: row.PIC || null,
                // שדות פנימיים
                expected_berth_time: null,
                expected_finish_time: null,
                notes: '',
                waterSupply: false, waterAmount: null,
                package: false, packageWeight: null, trackingNumber: null,
                trader_flag: null,
                tasks: [], // יקבל תבנית למטה
                flags: { missing_in_today_report: false },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                version: 1
            };
            ensureChecklistForStatus(obj);
            return obj;
        }

        async function mergeShips(incoming) {
            console.log('Merging ships with Firestore:', incoming.length, 'incoming ships');
            
            // `ships` הוא המצב המקומי שמתעדכן מה-listener, הוא מייצג את האמת הנוכחית בענן
            const byId = new Map(ships.map(s => [s.id, s]));
            const seen = new Set();
            const batch = db.batch(); // ניצור Batch לכל העדכונים
            let addedCount = 0;
            let updatedCount = 0;
            let removedCount = 0;

            for (const inc of incoming) {
                seen.add(inc.id);
                if (byId.has(inc.id)) {
                    // --- אנייה קיימת ---
                    const cur = byId.get(inc.id);

                    // בנה אובייקט עדכון ששומר נתונים ידניים
                    const updatedData = {
                        ...inc, // התחל עם הנתונים החדשים מהאקסל

                        // כעת, דרוס את הנתונים החדשים עם הנתונים הידניים הישנים
                        notes: cur.notes,
                        waterSupply: cur.waterSupply,
                        waterAmount: cur.waterAmount,
                        package: cur.package,
                        packageWeight: cur.packageWeight,
                        trackingNumber: cur.trackingNumber,
                        trader_flag: cur.trader_flag,
                        etb: cur.etb || inc.etb || null, // ודא שזה null אם שניהם חסרים
                        expected_berth_time: cur.expected_berth_time || inc.expected_berth_time || null, // ודא שזה null אם שניהם חסרים
                        tasks: cur.tasks, // שמור על כל היסטוריית המשימות!

                        // עדכן שדות ניהוליים
                        flags: { missing_in_today_report: false },
                        updatedAt: new Date().toISOString(),
                        version: (cur.version || 1) + 1
                    };

                    // עדכן סטטוס משימות אם הסטטוס של האנייה השתנה
                    ensureChecklistForStatus(updatedData);

                    const docRef = db.collection("ships").doc(cur.id);
                    batch.update(docRef, updatedData); // עדכן ב-Batch
                    updatedCount++;

                } else {
                    // --- אנייה חדשה ---
                    const docRef = db.collection("ships").doc(inc.id);
                    batch.set(docRef, inc); // הוסף ב-Batch
                    addedCount++;
                }
            }

            // --- טיפול באניות שאינן בדוח ---
            for (const ship of ships) {
                if (!seen.has(ship.id)) {
                    if (ship.status === STATUS.SAILED) {
                        // אנייה שכבר הפליגה, נשאיר אותה עד שתעבור לארכיון
                    } else {
                        // אנייה שהייתה צריכה להופיע ונעלמה - מחק אותה
                        const docRef = db.collection("ships").doc(ship.id);
                        batch.delete(docRef);
                        removedCount++;
                    }
                }
            }

            // בצע את כל הפעולות בבת אחת
            try {
                await batch.commit();
                const summary = `מיזוג הושלם: נוספו ${addedCount}, עודכנו ${updatedCount}, הוסרו ${removedCount}`;
                showToast(summary, 'success');
                addActivity('ייבוא דוח', summary);
            } catch (error) {
                console.error("Error committing batch:", error);
                showToast('שגיאה חמורה במיזוג הדוח', 'error');
            }
        }

        // ==================== Legacy Functions (Deprecated) ====================
        // These functions are kept for backward compatibility but are no longer used
        // The new import system uses mapRows, isRelevant, normalizeShip, and mergeShips

        function parseDate(dateString) {
            if (!dateString || dateString === '') {
                return new Date().toISOString();
            }
            
            try {
                // Try different date formats
                let date;
                
                // If it's already a Date object
                if (dateString instanceof Date) {
                    date = dateString;
                }
                // If it's a number (Excel serial date)
                else if (typeof dateString === 'number') {
                    // Excel serial date to JavaScript date
                    date = new Date((dateString - 25569) * 86400 * 1000);
                }
                // If it's a string
                else if (typeof dateString === 'string') {
                    // Try parsing as ISO string first
                    date = new Date(dateString);
                    
                    // If that fails, try other formats
                    if (isNaN(date.getTime())) {
                        // Try DD/MM format (Israeli format)
                        if (dateString.includes('/')) {
                            const parts = dateString.split(' ');
                            const datePart = parts[0];
                            const timePart = parts[1] || '00:00';
                            
                            if (datePart.includes('/')) {
                                const [day, month] = datePart.split('/');
                                const currentYear = new Date().getFullYear();
                                
                                // Handle time parsing
                                let hours = 0, minutes = 0;
                                if (timePart && timePart.includes(':')) {
                                    const [h, m] = timePart.split(':');
                                    hours = parseInt(h) || 0;
                                    minutes = parseInt(m) || 0;
                                }
                                
                                date = new Date(currentYear, parseInt(month) - 1, parseInt(day), hours, minutes);
                            }
                        }
                        // Try MM/DD/YYYY format
                        else {
                            const parts = dateString.split('/');
                            if (parts.length === 3) {
                                date = new Date(parts[2], parts[0] - 1, parts[1]);
                            }
                        }
                    }
                }
                
                // Check if date is valid
                if (date && !isNaN(date.getTime())) {
                    return date.toISOString();
                } else {
                    console.log('Invalid date:', dateString);
                    return new Date().toISOString();
                }
            } catch (error) {
                console.log('Error parsing date:', dateString, error);
                return new Date().toISOString();
            }
        }

        // ==================== UI Functions ====================

        function editShip(id) {
            const ship = ships.find(s => s.id === id);
            if (!ship) return;
            
            // Default ETB object if it doesn't exist
            ship.etb = ship.etb || { type: 'specific', sortDate: ship.expected_berth_time || '' };
            
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `עריכת אנייה: ${ship.name}`;
            body.innerHTML = `
                <form id="editShipForm" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="form-group"><label>שם:</label><input type="text" name="name" value="${ship.name}" required></div>
                    <div class="form-group"><label>מסע:</label><input type="text" name="voyage" value="${ship.voyage || ''}"></div>
                    <div class="form-group"><label>סטטוס:</label><select name="status">${Object.values(STATUS).map(s => `<option value="${s}" ${ship.status === s ? 'selected' : ''}>${getStatusText(s)}</option>`).join('')}</select></div>
                    <div class="form-group"><label>ETA:</label><input type="datetime-local" name="eta" value="${ship.eta ? new Date(ship.eta).toISOString().slice(0, 16) : ''}"></div>
                    <div class="form-group"><label>מטען (תיאור):</label><textarea name="cargo" rows="2">${ship.cargo || ''}</textarea></div>

                    <!-- Manifest Section -->
                    <div class="manifest-section" style="padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                        <h4 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            מניפסט (הצהרת מטען)
                        </h4>
                        <div id="manifestItemsList" style="margin-bottom: var(--spacing-md);">
                            ${(ship.manifest?.items || []).map((item, idx) => `
                                <div class="manifest-item" data-idx="${idx}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <input type="text" placeholder="סוג מטען" value="${item.type || ''}" class="manifest-type" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);">
                                    <input type="number" placeholder="משקל" value="${item.weight || 0}" class="manifest-weight" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);">
                                    <input type="number" placeholder="כמות" value="${item.quantity || 0}" class="manifest-quantity" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);">
                                    <select class="manifest-unit" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="MT" ${item.unit === 'MT' ? 'selected' : ''}>MT</option>
                                        <option value="PCS" ${item.unit === 'PCS' ? 'selected' : ''}>PCS</option>
                                        <option value="Coils" ${item.unit === 'Coils' ? 'selected' : ''}>Coils</option>
                                        <option value="Bundles" ${item.unit === 'Bundles' ? 'selected' : ''}>Bundles</option>
                                    </select>
                                    <button type="button" onclick="this.parentElement.remove(); updateManifestTotals();" style="padding: 8px; background: var(--danger); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">✕</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addManifestItem()" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 6px; margin-bottom: var(--spacing-md);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            הוסף סוג מטען
                        </button>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: var(--spacing-sm); border-top: 1px solid var(--glass-border);">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase;">סה"כ משקל</div>
                                <div id="manifestTotalWeight" style="font-size: 20px; font-weight: 700; color: var(--primary);">${(ship.manifest?.totalWeight || 0).toLocaleString()} MT</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase;">סה"כ כמות</div>
                                <div id="manifestTotalQuantity" style="font-size: 20px; font-weight: 700; color: var(--primary);">${(ship.manifest?.totalQuantity || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="checklist-section" style="padding: var(--spacing-md);">
                        <h4>ETB (תאריך עגינה צפוי)</h4>
                        <div id="etb-options" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                            <label><input type="radio" name="etb_type" value="specific" ${ship.etb.type === 'specific' || !ship.etb.type ? 'checked' : ''}> תאריך</label>
                            <label><input type="radio" name="etb_type" value="range" ${ship.etb.type === 'range' ? 'checked' : ''}> טווח</label>
                            <label><input type="radio" name="etb_type" value="shift" ${ship.etb.type === 'shift' ? 'checked' : ''}> משמרת</label>
                    </div>
                        <div id="etb-inputs">
                            <div id="etb-specific" class="etb-input-group" style="display: ${ship.etb.type === 'specific' || !ship.etb.type ? 'flex' : 'none'};">
                                <input type="date" name="etb_specific_date" value="${(ship.etb.sortDate || '').split('T')[0]}">
                    </div>
                            <div id="etb-range" class="etb-input-group" style="display: ${ship.etb.type === 'range' ? 'flex' : 'none'}; gap: var(--spacing-sm); align-items: center;">
                                <input type="date" name="etb_range_start" value="${(ship.etb.startDate || '').split('T')[0]}">
                                <span>עד</span>
                                <input type="date" name="etb_range_end" value="${(ship.etb.endDate || '').split('T')[0]}">
                            </div>
                            <div id="etb-shift" class="etb-input-group" style="display: ${ship.etb.type === 'shift' ? 'flex' : 'none'}; gap: var(--spacing-sm);">
                                <input type="date" name="etb_shift_date" value="${(ship.etb.sortDate || '').split('T')[0]}">
                                <select name="etb_shift_value">
                                    <option value="A" ${ship.etb.shift === 'A' ? 'selected' : ''}>משמרת א'</option>
                                    <option value="B" ${ship.etb.shift === 'B' ? 'selected' : ''}>משמרת ב'</option>
                                    <option value="C" ${ship.etb.shift === 'C' ? 'selected' : ''}>משמרת ג'</option>
                        </select>
                    </div>
                    </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                        <button type="submit" class="btn btn-primary">שמור</button>
                    </div>
                </form>
            `;
            
            // FIX: This line was missing, it makes the modal visible
            modal.classList.add('active');

            // Add event listeners for radio buttons
            document.querySelectorAll('input[name="etb_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.etb-input-group').forEach(group => group.style.display = 'none');
                    document.getElementById(`etb-${this.value}`).style.display = 'flex';
                });
            });

            document.getElementById('editShipForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                ship.name = data.name;
                ship.voyage = data.voyage;
                ship.status = data.status;
                ship.eta = data.eta ? new Date(data.eta).toISOString() : null;
                ship.cargo = data.cargo;

                // Process and save the new ETB object
                ship.etb = getEtbObject(data);
                ship.expected_berth_time = ship.etb.sortDate; // Keep legacy field for basic sorting

                // Process and save manifest
                ship.manifest = getManifestFromForm();

                ship.updatedAt = new Date().toISOString();

                ensureChecklistForStatus(ship);
                checkPostSailedTasksComplete(ship);

                // Update to Firestore
                const shipDataToUpdate = {
                    name: data.name,
                    voyage: data.voyage,
                    status: data.status,
                    eta: ship.eta,
                    cargo: data.cargo,
                    etb: ship.etb,
                    expected_berth_time: ship.expected_berth_time,
                    manifest: ship.manifest,
                    tasks: ship.tasks,
                    updatedAt: new Date().toISOString()
                };
                
                db.collection("ships").doc(ship.id).update(shipDataToUpdate)
                    .then(() => {
                        showToast('האנייה עודכנה בהצלחה', 'success');
                        addActivity('עריכת אנייה', `עודכנה אנייה: ${ship.name}`);
                        closeModal();
                    })
                    .catch(e => showToast('שגיאה בעדכון אנייה', 'error'));
            };
        }

        function getEtbObject(data) {
            const etb = { type: data.etb_type };
            const formatDatePart = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'}) : '';

            switch (data.etb_type) {
                case 'range':
                    etb.startDate = data.etb_range_start ? new Date(data.etb_range_start).toISOString() : null;
                    etb.endDate = data.etb_range_end ? new Date(data.etb_range_end).toISOString() : null;
                    etb.sortDate = etb.startDate;
                    etb.displayValue = `${formatDatePart(etb.startDate)} - ${formatDatePart(etb.endDate)}`;
                    break;
                case 'shift':
                    etb.sortDate = data.etb_shift_date ? new Date(data.etb_shift_date).toISOString() : null;
                    etb.shift = data.etb_shift_value;
                    const shiftText = {A: "משמרת א'", B: "משמרת ב'", C: "משמרת ג'"}[etb.shift];
                    etb.displayValue = `${formatDatePart(etb.sortDate)} - ${shiftText}`;
                    break;
                case 'specific':
                default:
                    etb.sortDate = data.etb_specific_date ? new Date(data.etb_specific_date).toISOString() : null;
                    etb.displayValue = formatDatePart(etb.sortDate);
                    break;
            }
            return etb;
        }

        // ==================== Manifest Functions ====================
        function addManifestItem() {
            const container = document.getElementById('manifestItemsList');
            const idx = container.children.length;
            const itemHtml = `
                <div class="manifest-item" data-idx="${idx}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                    <input type="text" placeholder="סוג מטען" class="manifest-type" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);" oninput="updateManifestTotals()">
                    <input type="number" placeholder="משקל" value="0" class="manifest-weight" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);" oninput="updateManifestTotals()">
                    <input type="number" placeholder="כמות" value="0" class="manifest-quantity" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);" oninput="updateManifestTotals()">
                    <select class="manifest-unit" style="padding: 8px; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="MT">MT</option>
                        <option value="PCS">PCS</option>
                        <option value="Coils">Coils</option>
                        <option value="Bundles">Bundles</option>
                    </select>
                    <button type="button" onclick="this.parentElement.remove(); updateManifestTotals();" style="padding: 8px; background: var(--danger); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">✕</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHtml);
        }

        function updateManifestTotals() {
            const items = document.querySelectorAll('.manifest-item');
            let totalWeight = 0;
            let totalQuantity = 0;

            items.forEach(item => {
                const weight = parseFloat(item.querySelector('.manifest-weight')?.value) || 0;
                const quantity = parseFloat(item.querySelector('.manifest-quantity')?.value) || 0;
                totalWeight += weight;
                totalQuantity += quantity;
            });

            const weightEl = document.getElementById('manifestTotalWeight');
            const quantityEl = document.getElementById('manifestTotalQuantity');
            if (weightEl) weightEl.textContent = `${totalWeight.toLocaleString()} MT`;
            if (quantityEl) quantityEl.textContent = totalQuantity.toLocaleString();
        }

        function getManifestFromForm() {
            const items = [];
            let totalWeight = 0;
            let totalQuantity = 0;

            document.querySelectorAll('.manifest-item').forEach(item => {
                const type = item.querySelector('.manifest-type')?.value?.trim() || '';
                const weight = parseFloat(item.querySelector('.manifest-weight')?.value) || 0;
                const quantity = parseFloat(item.querySelector('.manifest-quantity')?.value) || 0;
                const unit = item.querySelector('.manifest-unit')?.value || 'MT';

                if (type || weight || quantity) {
                    items.push({ type, weight, quantity, unit });
                    totalWeight += weight;
                    totalQuantity += quantity;
                }
            });

            return { totalWeight, totalQuantity, items };
        }

        function openServices(id) {
            const ship = ships.find(s => s.id === id);
            if (!ship) return;

            // אתחול מערך השירותים אם לא קיים
            ship.services = ship.services || [];
            
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `ניהול שירותים: ${ship.name}`;

            // פונקציית עזר ליצירת HTML עבור שירות קיים
            const createServiceItemHtml = (service) => {
                let detailsHtml = '';
                switch(service.type) {
                    case 'water': detailsHtml = `כמות: ${service.details.amount || '?'} טון`; break;
                    case 'package': detailsHtml = `משקל: ${service.details.weight || '?'} ק"ג, מעקב: ${service.details.tracking || '?'}`; break;
                    case 'sludge': detailsHtml = `כמות: ${service.details.amount || '?'} מ"ק`; break;
                    case 'bilge': detailsHtml = `כמות: ${service.details.amount || '?'} מ"ק`; break;
                    case 'crew_change': detailsHtml = `נכנסים: ${service.details.crewIn || 0}, יוצאים: ${service.details.crewOut || 0}`; break;
                    case 'other': detailsHtml = `${service.details.description || 'תיאור חסר'}`; break;
                    default: detailsHtml = 'פרטים לא ידועים';
                }

                return `
                    <div class="service-item ${service.status || 'requested'}" id="service-${service.id}">
                        <div class="service-item-header">
                            <strong>${getServiceTypeName(service.type)}</strong>
                            <span class="service-status">${service.status || 'requested'}</span>
                        </div>
                        <div class="service-item-body">${detailsHtml}</div>
                        <div class="service-item-actions">
                             <button class="btn btn-sm btn-secondary" onclick="editService('${id}', '${service.id}')">ערוך</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteService('${id}', '${service.id}')">מחק</button>
                        </div>
                    </div>
                `;
            };

            body.innerHTML = `
                <div id="services-container" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <h4>שירותים קיימים</h4>
                    <div id="existing-services-list" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        ${ship.services.length > 0 ? ship.services.map(createServiceItemHtml).join('') : '<p style="color: var(--text-tertiary);">אין שירותים רשומים.</p>'}
                    </div>

                    <hr style="border-color: var(--glass-border); margin: var(--spacing-md) 0;">

                    <h4>הוספת שירות חדש</h4>
                    <div class="form-group">
                        <label>סוג שירות:</label>
                        <select id="new-service-type" onchange="showServiceDetailsForm()">
                            <option value="">בחר סוג...</option>
                            <option value="water">אספקת מים</option>
                            <option value="package">חבילה</option>
                            <option value="sludge">פינוי SLUDGE</option>
                            <option value="bilge">פינוי BILGE</option>
                            <option value="crew_change">חילוף צוות</option>
                            <option value="other">אחר</option>
                        </select>
                    </div>

                    <div id="new-service-details-form" style="display: none; flex-direction: column; gap: var(--spacing-sm); background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                        <!-- שדות דינמיים יופיעו כאן -->
                    </div>

                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-lg);">
                        <button class="btn btn-secondary" onclick="closeModal()">סגור</button>
                        <button class="btn btn-primary" id="add-service-btn" onclick="addService('${id}')" style="display: none;">הוסף שירות</button>
                    </div>
                    </div>
            `;
            modal.classList.add('active');
        }

        // ==================== Service Helper Functions ====================
        function getServiceTypeName(type) {
            const names = { water: 'אספקת מים', package: 'חבילה', sludge: 'פינוי SLUDGE', bilge: 'פינוי BILGE', crew_change: 'חילוף צוות', other: 'אחר' };
            return names[type] || type;
        }

        function showServiceDetailsForm() {
            const type = document.getElementById('new-service-type').value;
            const formDiv = document.getElementById('new-service-details-form');
            const addBtn = document.getElementById('add-service-btn');

            if (!type) {
                formDiv.style.display = 'none';
                addBtn.style.display = 'none';
                return;
            }

            let detailsHtml = '';
            switch(type) {
                case 'water': 
                    detailsHtml = `<label>כמות (טון):</label><input type="number" id="service-detail-amount">`; 
                    break;
                case 'package': 
                    detailsHtml = `<label>משקל (ק"ג):</label><input type="number" id="service-detail-weight">
                                   <label>מספר מעקב:</label><input type="text" id="service-detail-tracking">`; 
                    break;
                case 'sludge': 
                case 'bilge':
                    detailsHtml = `<label>כמות (מ"ק):</label><input type="number" id="service-detail-amount">`; 
                    break;
                case 'crew_change':
                    detailsHtml = `<label>מספר אנשי צוות נכנסים:</label><input type="number" id="service-detail-crewIn">
                                   <label>מספר אנשי צוות יוצאים:</label><input type="number" id="service-detail-crewOut">`; 
                    break;
                case 'other': 
                    detailsHtml = `<label>תיאור השירות:</label><input type="text" id="service-detail-description">`; 
                    break;
            }
            detailsHtml += `<label>סטטוס:</label><select id="service-detail-status">
                                <option value="requested">נדרש</option>
                                <option value="in-progress">בטיפול</option>
                                <option value="completed">הושלם</option>
                                <option value="cancelled">בוטל</option>
                            </select>`;

            formDiv.innerHTML = detailsHtml;
            formDiv.style.display = 'flex';
            addBtn.style.display = 'inline-flex';
        }

        function addService(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            const type = document.getElementById('new-service-type').value;
            if (!type) return;

            const newService = {
                id: 'service_' + Date.now(), // ID ייחודי
                type: type,
                details: {},
                status: document.getElementById('service-detail-status').value,
                createdAt: new Date().toISOString()
            };

            // איסוף הפרטים מהטופס הדינמי
            switch(type) {
                case 'water': 
                case 'sludge': 
                case 'bilge':
                    newService.details.amount = document.getElementById('service-detail-amount').value;
                    break;
                case 'package': 
                    newService.details.weight = document.getElementById('service-detail-weight').value;
                    newService.details.tracking = document.getElementById('service-detail-tracking').value;
                    break;
                case 'crew_change':
                    newService.details.crewIn = document.getElementById('service-detail-crewIn').value;
                    newService.details.crewOut = document.getElementById('service-detail-crewOut').value;
                    break;
                case 'other': 
                    newService.details.description = document.getElementById('service-detail-description').value;
                    break;
            }

            ship.services = ship.services || [];
            ship.services.push(newService);
            ship.updatedAt = new Date().toISOString();

            // שמור שינויים ב-Firestore
            db.collection("ships").doc(ship.id).update({ services: ship.services, updatedAt: ship.updatedAt })
                .then(() => showToast('שירות נוסף בהצלחה', 'success'))
                .catch(e => showToast('שגיאה בהוספת שירות', 'error'));

            // רענן את רשימת השירותים במודאל
            const listDiv = document.getElementById('existing-services-list');
            listDiv.innerHTML = ship.services.length > 0 ? ship.services.map(s => {
                let detailsHtml = '';
                switch(s.type) {
                    case 'water': detailsHtml = `כמות: ${s.details.amount || '?'} טון`; break;
                    case 'package': detailsHtml = `משקל: ${s.details.weight || '?'} ק"ג, מעקב: ${s.details.tracking || '?'}`; break;
                    case 'sludge': detailsHtml = `כמות: ${s.details.amount || '?'} מ"ק`; break;
                    case 'bilge': detailsHtml = `כמות: ${s.details.amount || '?'} מ"ק`; break;
                    case 'crew_change': detailsHtml = `נכנסים: ${s.details.crewIn || 0}, יוצאים: ${s.details.crewOut || 0}`; break;
                    case 'other': detailsHtml = `${s.details.description || 'תיאור חסר'}`; break;
                    default: detailsHtml = 'פרטים לא ידועים';
                }
                return `
                    <div class="service-item ${s.status || 'requested'}" id="service-${s.id}">
                        <div class="service-item-header">
                            <strong>${getServiceTypeName(s.type)}</strong>
                            <span class="service-status">${s.status || 'requested'}</span>
                    </div>
                        <div class="service-item-body">${detailsHtml}</div>
                        <div class="service-item-actions">
                             <button class="btn btn-sm btn-secondary" onclick="editService('${shipId}', '${s.id}')">ערוך</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteService('${shipId}', '${s.id}')">מחק</button>
                    </div>
                    </div>
                `;
            }).join('') : '<p style="color: var(--text-tertiary);">אין שירותים רשומים.</p>';

            // נקה את טופס ההוספה
            document.getElementById('new-service-type').value = '';
            document.getElementById('new-service-details-form').style.display = 'none';
            document.getElementById('add-service-btn').style.display = 'none';

            // רענן את התצוגה הראשית אם צריך
            if (currentTab !== 'quick') renderShips();
        }

        function editService(shipId, serviceId) {
            alert(`יש לממש עריכה לשירות ${serviceId} באנייה ${shipId}`);
        }

        function deleteService(shipId, serviceId) {
             const ship = ships.find(s => s.id === shipId);
            if (!ship || !ship.services) return;

            if (confirm(`האם למחוק את השירות "${getServiceTypeName(ship.services.find(s=>s.id === serviceId)?.type)}"?`)) {
                ship.services = ship.services.filter(s => s.id !== serviceId);
                ship.updatedAt = new Date().toISOString();
                
                // שמור שינויים ב-Firestore
                db.collection("ships").doc(ship.id).update({ services: ship.services, updatedAt: ship.updatedAt })
                    .then(() => showToast('שירות נמחק', 'success'))
                    .catch(e => showToast('שג导向 במחיקת שירות', 'error'));

                // רענן רשימה במודאל
                const itemElement = document.getElementById(`service-${serviceId}`);
                if (itemElement) itemElement.remove();

                // רענן תצוגה ראשית
                 if (currentTab !== 'quick') renderShips();
            }
        }

        function openTasks(id) {
            const ship = ships.find(s => s.id === id);
            if (!ship) return;
            
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `משימות: ${ship.name}`;
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    <div class="checklist-section">
                        <h4>רשימת משימות</h4>
                        <div class="checklist-items">
                            ${(ship.tasks || []).map((item, index) => {
                                const taskUrg = taskUrgency(item, ship);
                                return `
                                <label class="checklist-item ${taskUrg}">
                                    <input type="checkbox" ${item.done ? 'checked' : ''} 
                                           onchange="toggleTaskItem('${id}', ${index})">
                                    <span class="checklist-text">${item.title}</span>
                                    <span class="task-due ${taskUrg}">${item.due}</span>
                                </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>הערות נוספות:</label>
                        <textarea id="taskNotes" rows="3" placeholder="הוסף הערות למשימות...">${ship.notes}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal()">סגור</button>
                        <button class="btn btn-primary" onclick="saveTaskNotes('${id}')">שמור הערות</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function saveTaskNotes(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;
            
            const notes = document.getElementById('taskNotes').value;
            ship.notes = notes;
            ship.updatedAt = new Date().toISOString();
            
            db.collection("ships").doc(ship.id).update({ 
                notes: notes, 
                updatedAt: new Date().toISOString() 
            }).then(() => {
            showToast('הערות נשמרו בהצלחה', 'success');
            addActivity('עדכון הערות', `עודכנו הערות לאנייה: ${ship.name}`);
                closeModal();
            }).catch(e => showToast('שגיאה בשמירת הערות', 'error'));
        }

        function setTraderFlag(shipId, flag, event) {
            event.stopPropagation(); // מונע פתיחת המודאל בלחיצה על הכפתור
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;

            ship.trader_flag = flag;
            ship.updatedAt = new Date().toISOString();
            
            db.collection("ships").doc(ship.id).update({ 
                trader_flag: flag, 
                updatedAt: new Date().toISOString() 
            }).then(() => {
                showToast(`סוכן שונה ל-${flag} עבור ${ship.name}`, 'success');
            }).catch(e => console.error(e));
        }

        function toggleTaskItem(shipId, itemIndex) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;
            
            const task = ship.tasks[itemIndex];
            // שינוי הסטטוס במעגל: pending -> in-progress -> done -> pending
            const statusCycle = ['pending', 'in-progress', 'done'];
            const currentIndex = statusCycle.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            task.status = statusCycle[nextIndex];
            
            // עדכון פרטי המשימה
            task.lastUpdatedAt = new Date().toISOString();
            if (task.status === 'done') {
                task.doneAt = new Date().toISOString();
                task.doneBy = currentUser;
            } else {
                task.doneAt = null;
                task.doneBy = null;
            }
            
            // עדכון ל-Firestore
            db.collection("ships").doc(ship.id).update({ 
                tasks: ship.tasks, 
                updatedAt: new Date().toISOString() 
            }).then(() => {
                updateStats();
                addActivity('עדכון משימה', `עודכנה משימה לאנייה: ${ship.name}`);
                
                // בדוק אם כל משימות ההפלגה הושלמו
                checkPostSailedTasksComplete(ship);
            }).catch(e => console.error(e));
        }

        function promptToArchiveShip(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;
            
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = 'סיום טיפול והעברה לארכיון';
            body.innerHTML = `
                <div style="text-align: center; padding: var(--spacing-lg);">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="margin-bottom: var(--spacing-lg);">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <h3 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        כל משימות ההפלגה עבור האנייה "${ship.name}" הושלמו.
                    </h3>
                    <p style="margin-bottom: var(--spacing-xl); color: var(--text-secondary);">
                        האם ברצונך להעביר את האנייה לארכיון ולסגור את הטיפול בה?
                    </p>
                    <div style="display: flex; gap: var(--spacing-md); justify-content: center;">
                        <button class="btn btn-primary" onclick="archiveShip('${shipId}')">כן, העבר לארכיון</button>
                        <button class="btn btn-secondary" onclick="closeModal()">לא, השאר פעילה</button>
                    </div>
                    </div>
            `;
            
            modal.classList.add('active');
        }

        function archiveShip(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (!ship) return;
            
            // כתוב לארכיון ומחק מהרשימה הפעילה
            db.collection("archived").doc(shipId).set({ ...ship, archivedAt: new Date().toISOString() })
                .then(() => {
                    db.collection("ships").doc(shipId).delete()
                        .then(() => {
                            showToast(`האנייה ${ship.name} הועברה לארכיון בהצלחה`, 'success');
                            addActivity('העברה לארכיון', `האנייה ${ship.name} הועברה לארכיון לאחר השלמת כל המשימות.`);
                            closeModal();
                        })
                        .catch(e => console.error("Error deleting ship:", e));
                })
                .catch(e => {
                    console.error("Error archiving:", e);
                    showToast('שגיאה בהעברת אנייה לארכיון', 'error');
                });
        }

        function checkPostSailedTasksComplete(ship) {
            if (ship.status !== STATUS.SAILED) {
                return;
            }

            const postSailedTaskKeys = POST_SAILED.map(t => t.key);
            const allDone = postSailedTaskKeys.every(key => {
                const task = ship.tasks.find(t => t.key === key);
                return task && task.status === 'done';
            });

            if (allDone) {
                // העבר לארכיון אוטומטית במקום להציג חלון אישור
                console.log(`Archiving ship ${ship.name} automatically.`);
                archiveShip(ship.id);
            }
        }

        function viewArchive() {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `ארכיון אניות (${archived.length})`;
            body.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    ${archived.length === 0 ? `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-tertiary);">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: var(--spacing-md);">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            <p>אין אניות בארכיון</p>
                        </div>
                    ` : `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            ${archived.map(ship => `
                                <div class="ship-card archived" style="margin-bottom: var(--spacing-md);">
                                    <div class="ship-header">
                                        <div class="ship-title">
                                            <div>
                                                <div class="ship-name">${ship.name}</div>
                                                <div class="ship-voyage">${ship.voyage || ''}</div>
                                            </div>
                                            <div class="ship-status status-sailed">
                                                ${getStatusText(ship.status)}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ship-body">
                                        <div class="ship-info">
                                            <div class="info-row">
                                                <span class="info-label">נמל:</span>
                                                <span class="info-value">${ship.port || '-'}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">מטען:</span>
                                                <span class="info-value">${ship.cargo || '-'}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">ארכיון:</span>
                                                <span class="info-value">${formatDate(ship.archivedAt)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                    
                    <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal()">סגור</button>
                        ${archived.length > 0 ? `
                            <button class="btn btn-danger" onclick="clearArchive()">נקה ארכיון</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function clearArchive() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הארכיון?')) {
                archived = [];
                persistArchive();
                closeModal();
                showToast('הארכיון נוקה', 'success');
                addActivity('ניקוי ארכיון', 'כל האניות הוסרו מהארכיון');
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // ==================== EMAIL NOTIFICATION SYSTEM ====================
        let pendingEmailData = null;
        let selectedEmailRecipients = [];

        // User signature - stored in localStorage
        function getUserSignature() {
            return localStorage.getItem('shipops_email_signature') || `Best Regards

Operations Department | Coral Maritime Services Ltd. (as agents only)
  +972-4-8671266	 ops@coralgroup.co.il
 	 www.coralgroup.co.il`;
        }

        function setUserSignature(signature) {
            localStorage.setItem('shipops_email_signature', signature);
        }

        // Generate email template based on update type
        function generateEmailTemplate(ship, updateType, updateDetails = {}) {
            const vesselName = ship.name || 'Unknown';
            const voyage = ship.voyage || '';
            const port = ship.port || 'Israel';

            // Build cargo section
            let cargoSection = '';
            if (ship.cargo) {
                cargoSection = `\nCargo (declared):\n${ship.cargo}\n`;
            }

            // Build update message based on type
            let updateMessage = '';
            const signature = getUserSignature();

            switch (updateType) {
                case 'eta':
                    const etaDisplay = updateDetails.eta ? formatDateFromISO(updateDetails.eta) : 'TBA';
                    updateMessage = `Per master vessel's ETA ${etaDisplay} agw wp.`;
                    break;

                case 'etb':
                    const etbDisplay = updateDetails.etb ? formatDateFromISO(updateDetails.etb) : 'TBA';
                    updateMessage = `As per port info ETB & comm disch on abt ${etbDisplay} agw and sub wp.`;
                    break;

                case 'eta_etb':
                    const eta = updateDetails.eta ? formatDateFromISO(updateDetails.eta) : 'TBA';
                    const etb = updateDetails.etb ? formatDateFromISO(updateDetails.etb) : 'TBA';
                    updateMessage = `Per master vessel's ETA ${eta} agw wp.\n\nAs per port info ETB & comm disch on abt ${etb} agw and sub wp.`;
                    break;

                case 'berthed':
                    updateMessage = `Pls be advised vessel has berthed and commenced discharge operations.`;
                    break;

                case 'sailed':
                    updateMessage = `Pls be advised vessel has completed discharge and sailed.`;
                    break;

                case 'arrival':
                    const arrivalEta = updateDetails.eta ? formatDateFromISO(updateDetails.eta) : 'shortly';
                    updateMessage = `Per master vessel's ETA ${arrivalEta}. Arrival notice.`;
                    break;

                default:
                    updateMessage = `Status update for vessel ${vesselName}.`;
            }

            const emailBody = `Vessel: ${vesselName}
Voyage: ${voyage}
Port: ${port}
${cargoSection}
${updateMessage}

Reverting,

${signature}`;

            return emailBody;
        }

        // Generate email subject
        function generateEmailSubject(ship, updateType) {
            const vesselName = ship.name || 'Unknown';
            const port = ship.port || '';

            switch (updateType) {
                case 'eta':
                    return `${vesselName} - ETA Update - ${port}`;
                case 'etb':
                    return `${vesselName} - ETB Update - ${port}`;
                case 'eta_etb':
                    return `${vesselName} - ETA/ETB Update - ${port}`;
                case 'berthed':
                    return `${vesselName} - Berthed - ${port}`;
                case 'sailed':
                    return `${vesselName} - Sailed - ${port}`;
                case 'arrival':
                    return `${vesselName} - Arrival Notice - ${port}`;
                default:
                    return `${vesselName} - Update - ${port}`;
            }
        }

        // Default email that's always CC'd
        const DEFAULT_CC_EMAIL = 'ops@coralgroup.co.il';

        // Show email notification modal after update
        function promptEmailNotification(ship, updateType, updateDetails = {}) {
            pendingEmailData = { ship, updateType, updateDetails };
            selectedEmailRecipients = [];

            const recipientsList = document.getElementById('emailRecipientsList');
            recipientsList.innerHTML = '';

            // Section 1: Voyage-specific contacts (selected by default)
            const voyageContacts = ship.voyageContacts || [];
            if (voyageContacts.length > 0) {
                const sectionHeader = document.createElement('div');
                sectionHeader.style.cssText = 'width: 100%; font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px; font-weight: 600;';
                sectionHeader.textContent = `אנשי קשר של הפלגה ${ship.voyage || ''}:`;
                recipientsList.appendChild(sectionHeader);

                voyageContacts.forEach(contact => {
                    const chip = createRecipientChip(contact.email, contact.name, true, 'voyage');
                    recipientsList.appendChild(chip);
                });
            }

            // Section 2: Default CC (always selected)
            const defaultSection = document.createElement('div');
            defaultSection.style.cssText = 'width: 100%; font-size: 12px; color: var(--text-tertiary); margin: 10px 0 6px 0; font-weight: 600;';
            defaultSection.textContent = 'ברירת מחדל:';
            recipientsList.appendChild(defaultSection);

            // Add default CC email (always checked)
            const defaultChip = createRecipientChip(DEFAULT_CC_EMAIL, 'Coral Operations', true, 'default');
            recipientsList.appendChild(defaultChip);

            // Section 3: Other contacts from database (not selected by default)
            const otherContacts = contacts.filter(c =>
                c.email &&
                c.email !== DEFAULT_CC_EMAIL &&
                !voyageContacts.some(vc => vc.email === c.email)
            );

            if (otherContacts.length > 0) {
                const otherSection = document.createElement('div');
                otherSection.style.cssText = 'width: 100%; font-size: 12px; color: var(--text-tertiary); margin: 10px 0 6px 0; font-weight: 600;';
                otherSection.textContent = 'אנשי קשר נוספים:';
                recipientsList.appendChild(otherSection);

                otherContacts.forEach(contact => {
                    const chip = createRecipientChip(contact.email, contact.name, false, 'other');
                    recipientsList.appendChild(chip);
                });
            }

            // Set subject
            document.getElementById('emailSubject').value = generateEmailSubject(ship, updateType);

            // Set body
            document.getElementById('emailBody').value = generateEmailTemplate(ship, updateType, updateDetails);

            // Show modal
            document.getElementById('emailNotifyModal').classList.add('active');
        }

        // Create recipient chip element
        function createRecipientChip(email, name, isChecked, type) {
            const chip = document.createElement('label');

            let bgStyle = 'background: var(--bg-secondary); border: 1px solid var(--glass-border);';
            if (type === 'voyage') {
                bgStyle = 'background: var(--success-glow); border: 1px solid var(--success);';
            } else if (type === 'default') {
                bgStyle = 'background: var(--primary-glow); border: 1px solid var(--primary);';
            }

            chip.style.cssText = `display: flex; align-items: center; gap: 6px; padding: 6px 12px; ${bgStyle} border-radius: 20px; cursor: pointer; font-size: 13px;`;
            chip.innerHTML = `
                <input type="checkbox" class="email-recipient-checkbox" value="${email}" ${isChecked ? 'checked' : ''} style="accent-color: var(--primary);">
                <span>${name || email.split('@')[0]}</span>
                <span style="color: var(--text-tertiary); font-size: 11px;">${email}</span>
            `;
            return chip;
        }

        // Add custom recipient
        function addCustomRecipient() {
            const input = document.getElementById('additionalEmail');
            const email = input.value.trim();

            if (email && email.includes('@')) {
                const recipientsList = document.getElementById('emailRecipientsList');
                const chip = document.createElement('label');
                chip.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-glow); border: 1px solid var(--primary); border-radius: 20px; cursor: pointer; font-size: 13px;';
                chip.innerHTML = `
                    <input type="checkbox" class="email-recipient-checkbox" value="${email}" checked style="accent-color: var(--primary);">
                    <span>${email}</span>
                `;
                recipientsList.appendChild(chip);
                input.value = '';
            }
        }

        // Get selected recipients
        function getSelectedRecipients() {
            const checkboxes = document.querySelectorAll('.email-recipient-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Copy email to clipboard
        function copyEmailToClipboard() {
            const body = document.getElementById('emailBody').value;
            const subject = document.getElementById('emailSubject').value;
            const recipients = getSelectedRecipients().join('; ');

            const fullText = `To: ${recipients}\nSubject: ${subject}\n\n${body}`;

            navigator.clipboard.writeText(fullText).then(() => {
                showToast('הועתק ללוח', 'success');
            }).catch(() => {
                showToast('שגיאה בהעתקה', 'error');
            });
        }

        // Open in email client (mailto)
        function openInEmailClient() {
            const body = document.getElementById('emailBody').value;
            const subject = document.getElementById('emailSubject').value;
            const recipients = getSelectedRecipients();

            // Save recipients to voyage if checkbox is checked
            const saveToVoyage = document.getElementById('saveRecipientsToVoyage')?.checked;
            if (saveToVoyage && pendingEmailData?.ship) {
                saveRecipientsToVoyageContacts(pendingEmailData.ship, recipients);
            }

            const mailtoLink = `mailto:${encodeURIComponent(recipients.join(','))}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
            closeEmailModal();
        }

        // Save selected recipients to voyage contacts
        function saveRecipientsToVoyageContacts(ship, recipientEmails) {
            if (!ship || !recipientEmails || recipientEmails.length === 0) return;

            const shipObj = ships.find(s => s.id === ship.id);
            if (!shipObj) return;

            shipObj.voyageContacts = shipObj.voyageContacts || [];

            let addedCount = 0;
            recipientEmails.forEach(email => {
                // Skip default email - it's always included anyway
                if (email === DEFAULT_CC_EMAIL) return;

                // Check if already exists
                if (!shipObj.voyageContacts.some(c => c.email === email)) {
                    // Try to find name from contacts database
                    const contact = contacts.find(c => c.email === email);
                    shipObj.voyageContacts.push({
                        email: email,
                        name: contact?.name || email.split('@')[0],
                        addedAt: new Date().toISOString()
                    });
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveData();
                showToast(`${addedCount} נמענים נשמרו להפלגה`, 'success');
            }
        }

        // Close email modal
        function closeEmailModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('emailNotifyModal').classList.remove('active');
            pendingEmailData = null;
        }

        // Ask user if they want to send email after update
        function askToSendEmail(ship, updateType, updateDetails = {}) {
            // Show confirmation first
            if (confirm('האם לשלוח עדכון במייל לכל הנוגעים בדבר?')) {
                promptEmailNotification(ship, updateType, updateDetails);
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };
            
            toast.innerHTML = `
                <span style="font-size: 18px; margin-left: var(--spacing-sm);">${icons[type]}</span>
                <span style="flex: 1;">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function addActivity(title, text) {
            const activity = {
                title,
                text,
                time: new Date().toISOString()
            };
            
            // שמור פעילות ב-Firestore
            db.collection("activities").add(activity).catch(e => console.error("Error adding activity:", e));
            updateActivities();
        }

        function updateActivities() {
            const content = document.getElementById('activityContent');
            
            if (activities.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-tertiary);">
                        אין פעילות להצגה
                    </div>
                `;
                return;
            }
            
            content.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4m0 12v4m-8-8h4m12 0h4"/>
                        </svg>
                    </div>
                    <div class="activity-body">
                        <div class="activity-text">${activity.title}</div>
                        <div class="activity-time">${formatRelativeTime(activity.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatRelativeTime(time) {
            const now = new Date();
            const then = new Date(time);
            const diff = now - then;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'כרגע';
            if (minutes < 60) return `לפני ${minutes} דקות`;
            if (hours < 24) return `לפני ${hours} שעות`;
            return `לפני ${days} ימים`;
        }

        // ==================== Smart AI Search Functions ====================
        let aiSearchVisible = false;

        function toggleAiSearch() {
            aiSearchVisible = !aiSearchVisible;
            const searchPanel = document.getElementById('smartAiSearch');
            const toggleBtn = document.querySelector('.ai-search-toggle');

            if (aiSearchVisible) {
                searchPanel.classList.add('active');
                toggleBtn.style.display = 'none';
                document.getElementById('aiSearchInput').focus();
            } else {
                searchPanel.classList.remove('active');
                toggleBtn.style.display = 'flex';
                document.getElementById('aiSearchResults').style.display = 'none';
            }
        }

        function setAiSearchExample(example) {
            document.getElementById('aiSearchInput').value = example;
            document.getElementById('aiSearchInput').focus();
        }

        async function performAiSearch() {
            const query = document.getElementById('aiSearchInput').value.trim();
            if (!query) return;

            const resultsDiv = document.getElementById('aiSearchResults');
            const submitBtn = document.getElementById('aiSearchBtn');

            // Show loading
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="ai-search-loading">
                    <div class="spinner"></div>
                    <p>מחפש מידע...</p>
                </div>
            `;
            submitBtn.disabled = true;

            try {
                // Build context from all ships and reference data
                const context = buildSearchContext();

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parseType: 'query',
                        query: query,
                        context: context
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();

                // API returns raw text for query type, or parsed data for others
                const answer = data.raw || data.answer || data.response || (data.parsed ? JSON.stringify(data.parsed) : 'לא נמצא מידע');

                resultsDiv.innerHTML = `
                    <div class="ai-search-result">
                        <div class="ai-search-answer">${formatAiAnswer(answer)}</div>
                    </div>
                `;
            } catch (error) {
                console.error('AI Search error:', error);

                // Fallback to local search
                const localResult = performLocalSearch(query);
                resultsDiv.innerHTML = `
                    <div class="ai-search-result">
                        <div class="ai-search-answer">${localResult}</div>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
            }
        }

        function buildSearchContext() {
            // Build a comprehensive context string for AI
            let context = 'מידע על אניות במערכת:\n\n';

            ships.forEach(ship => {
                context += `אנייה: ${ship.name}\n`;
                context += `  - מסע: ${ship.voyage || 'לא ידוע'}\n`;
                context += `  - סטטוס: ${getStatusText(ship.status)}\n`;
                context += `  - נמל: ${ship.port || 'לא ידוע'}\n`;
                context += `  - ETA: ${ship.eta ? new Date(ship.eta).toLocaleString('he-IL') : 'לא ידוע'}\n`;
                context += `  - מטען: ${ship.cargo || 'לא ידוע'}\n`;
                context += `  - בעלים: ${ship.owner || 'לא ידוע'}\n`;
                context += `  - מקבלים: ${ship.receivers || 'לא ידוע'}\n`;
                context += `  - ספק: ${ship.supplier || 'לא ידוע'}\n`;
                if (ship.manifest && ship.manifest.items && ship.manifest.items.length > 0) {
                    context += `  - מניפסט: ${ship.manifest.items.map(i => `${i.type} (${i.weight} טון)`).join(', ')}\n`;
                }
                context += '\n';
            });

            // Add reference vessel data
            if (referenceData.vessels && referenceData.vessels.length > 0) {
                context += '\nמידע טכני על אניות:\n';
                referenceData.vessels.forEach(v => {
                    context += `${v.name}: LOA=${v.loa || '?'}מ, רוחב=${v.beam || '?'}מ, DWT=${v.dwt || '?'}, IMO=${v.imo || '?'}\n`;
                });
            }

            return context;
        }

        function performLocalSearch(query) {
            const queryLower = query.toLowerCase();
            let results = [];

            // Find ship name in query
            const shipMatch = ships.find(s =>
                queryLower.includes(s.name.toLowerCase()) ||
                (s.voyage && queryLower.includes(s.voyage.toLowerCase()))
            );

            // Also check reference vessels
            const refVesselMatch = referenceData.vessels?.find(v =>
                queryLower.includes(v.name.toLowerCase())
            );

            if (shipMatch) {
                // Build structured response for multiple questions
                let answers = [];

                // Check each possible question type
                if (queryLower.includes('מקבל') || queryLower.includes('receivers')) {
                    answers.push({ label: 'מקבלים', value: shipMatch.receivers || 'לא הוגדר' });
                }
                if (queryLower.includes('eta') || queryLower.includes('הגעה') || queryLower.includes('מתי מגיע')) {
                    answers.push({ label: 'ETA', value: shipMatch.eta ? new Date(shipMatch.eta).toLocaleString('he-IL') : 'לא הוגדר' });
                }
                if (queryLower.includes('etb') || queryLower.includes('עגינה')) {
                    answers.push({ label: 'ETB', value: shipMatch.expected_berth_time ? new Date(shipMatch.expected_berth_time).toLocaleString('he-IL') : 'לא הוגדר' });
                }
                if (queryLower.includes('מטען') || queryLower.includes('cargo')) {
                    answers.push({ label: 'מטען', value: shipMatch.cargo || 'לא הוגדר' });
                }
                if (queryLower.includes('פירוט') || queryLower.includes('סחורה') || queryLower.includes('breakdown')) {
                    // Show cargo breakdown if available
                    if (shipMatch.cargoBreakdown && shipMatch.cargoBreakdown.length > 0) {
                        const breakdownText = shipMatch.cargoBreakdown
                            .filter(c => c.type)
                            .map(c => `${c.type}: ${c.quantity ? c.quantity + ' יח\' / ' : ''}${c.weight ? c.weight.toLocaleString() + ' MT' : ''}`)
                            .join('<br>');
                        answers.push({ label: 'פירוט מטען', value: breakdownText || shipMatch.cargo || 'לא הוגדר', isHtml: true });
                    } else {
                        answers.push({ label: 'פירוט מטען', value: shipMatch.cargo || 'לא הוגדר' });
                    }
                }
                if (queryLower.includes('נמל') || queryLower.includes('port') || queryLower.includes('יעד')) {
                    answers.push({ label: 'נמל יעד', value: shipMatch.port || 'לא הוגדר' });
                }
                if (queryLower.includes('סטטוס') || queryLower.includes('status') || queryLower.includes('מצב')) {
                    answers.push({ label: 'סטטוס', value: getStatusText(shipMatch.status) });
                }
                if (queryLower.includes('בעלים') || queryLower.includes('owner')) {
                    answers.push({ label: 'בעלים', value: shipMatch.owner || 'לא הוגדר' });
                }
                if (queryLower.includes('ספק') || queryLower.includes('supplier') || queryLower.includes('שולח')) {
                    answers.push({ label: 'ספק', value: shipMatch.supplier || 'לא הוגדר' });
                }
                if (queryLower.includes('סוכן') || queryLower.includes('agent')) {
                    answers.push({ label: 'סוכן', value: shipMatch.agent || 'לא הוגדר' });
                }
                if (queryLower.includes('מסע') || queryLower.includes('voyage')) {
                    answers.push({ label: 'מס\' מסע', value: shipMatch.voyage || 'לא הוגדר' });
                }

                // Format multiple answers nicely
                if (answers.length > 0) {
                    results.push(`<div style="margin-bottom: 8px;"><strong>📋 ${shipMatch.name}</strong></div>`);
                    answers.forEach(a => {
                        if (a.isHtml) {
                            results.push(`<div style="padding: 4px 0; border-bottom: 1px solid var(--glass-border);">
                                <div style="color: var(--text-secondary); margin-bottom: 4px;">${a.label}:</div>
                                <div style="font-weight: 500; font-size: 11px; line-height: 1.6;">${a.value}</div>
                            </div>`);
                        } else {
                            results.push(`<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--glass-border);">
                                <span style="color: var(--text-secondary);">${a.label}:</span>
                                <span style="font-weight: 500;">${a.value}</span>
                            </div>`);
                        }
                    });
                }

                // If no specific question, show all info
                if (answers.length === 0) {
                    results.push(`<div style="margin-bottom: 8px;"><strong>📋 ${shipMatch.name}</strong> (${shipMatch.voyage || 'ללא מסע'})</div>`);
                    const allInfo = [
                        { label: 'סטטוס', value: getStatusText(shipMatch.status) },
                        { label: 'נמל', value: shipMatch.port || '-' },
                        { label: 'ETA', value: shipMatch.eta ? new Date(shipMatch.eta).toLocaleString('he-IL') : '-' },
                        { label: 'מטען', value: shipMatch.cargo || '-' },
                        { label: 'מקבלים', value: shipMatch.receivers || '-' },
                        { label: 'ספק', value: shipMatch.supplier || '-' },
                        { label: 'בעלים', value: shipMatch.owner || '-' }
                    ];
                    allInfo.forEach(a => {
                        if (a.value && a.value !== '-') {
                            results.push(`<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--glass-border);">
                                <span style="color: var(--text-secondary);">${a.label}:</span>
                                <span style="font-weight: 500;">${a.value}</span>
                            </div>`);
                        }
                    });
                }
            }

            // Technical specs from reference
            if (refVesselMatch && (queryLower.includes('אורך') || queryLower.includes('loa') || queryLower.includes('מידות') || queryLower.includes('רוחב') || queryLower.includes('גודל'))) {
                results.push(`<div style="margin-top: 12px; margin-bottom: 8px;"><strong>📐 מידות ${refVesselMatch.name}:</strong></div>`);
                const specs = [];
                if (refVesselMatch.loa) specs.push({ label: 'LOA', value: `${refVesselMatch.loa} מ'` });
                if (refVesselMatch.beam) specs.push({ label: 'רוחב', value: `${refVesselMatch.beam} מ'` });
                if (refVesselMatch.dwt) specs.push({ label: 'DWT', value: `${refVesselMatch.dwt} טון` });
                if (refVesselMatch.grt) specs.push({ label: 'GRT', value: refVesselMatch.grt });
                if (refVesselMatch.holds) specs.push({ label: 'מחסנים', value: refVesselMatch.holds });
                specs.forEach(s => {
                    results.push(`<div style="display: flex; justify-content: space-between; padding: 4px 0;">
                        <span style="color: var(--text-secondary);">${s.label}:</span>
                        <span style="font-weight: 500;">${s.value}</span>
                    </div>`);
                });
            }

            if (results.length === 0) {
                // General search - list matching ships
                const matchingShips = ships.filter(s =>
                    s.name.toLowerCase().includes(queryLower) ||
                    (s.cargo && s.cargo.toLowerCase().includes(queryLower)) ||
                    (s.port && s.port.toLowerCase().includes(queryLower))
                );

                if (matchingShips.length > 0) {
                    results.push(`<strong>נמצאו ${matchingShips.length} אניות:</strong>`);
                    matchingShips.forEach(s => {
                        results.push(`<div style="padding: 4px 0;">• ${s.name} - ${getStatusText(s.status)} - ${s.port || '-'}</div>`);
                    });
                } else {
                    results.push('לא נמצא מידע מתאים. נסה לשאול שאלה ספציפית יותר או לציין שם אנייה.');
                }
            }

            return results.join('');
        }

        function formatAiAnswer(answer) {
            // Format the AI response for display
            return answer
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // ==================== Smart Parser Functions ====================
        let smartParserData = null; // Stores the parsed result for applying

        function openSmartParser() {
            const modal = document.getElementById('smartParserModal');
            modal.classList.add('active');
            document.getElementById('smartParserInput').focus();
        }

        function closeSmartParser(event) {
            // If called from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('smartParserModal');
            modal.classList.remove('active');
            resetSmartParser();
        }

        function handleSmartParserDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.eml')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('smartParserInput').value = e.target.result;
                        autoResizeTextarea(document.getElementById('smartParserInput'));
                    };
                    reader.readAsText(file);
                } else if (file.type.startsWith('image/')) {
                    // Handle image files - convert to base64 for AI vision
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result.split(',')[1];
                        document.getElementById('smartParserInput').value = `[IMAGE FILE: ${file.name}]`;
                        document.getElementById('smartParserInput').dataset.imageBase64 = base64;
                        document.getElementById('smartParserInput').dataset.mimeType = file.type;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
        }

        async function analyzeSmartInput() {
            const input = document.getElementById('smartParserInput');
            const content = input.value.trim();

            if (!content) {
                showToast('נא להזין טקסט לניתוח', 'warning');
                return;
            }

            // Show loading
            document.getElementById('parserInputSection').style.display = 'none';
            document.getElementById('parserLoadingSection').style.display = 'block';
            document.getElementById('parserResultsSection').style.display = 'none';

            try {
                // Prepare request body
                const requestBody = {
                    parseType: 'email',
                    content: content,
                    existingShips: ships.map(s => `${s.name} (${s.voyage})`),
                    currentYear: new Date().getFullYear()
                };

                // Check if there's an image
                if (input.dataset.imageBase64) {
                    requestBody.imageBase64 = input.dataset.imageBase64;
                    requestBody.mimeType = input.dataset.mimeType;
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.success && result.parsed) {
                    smartParserData = result.parsed;
                    displaySmartParserResults(result.parsed);
                } else {
                    showToast('לא הצלחתי לנתח את ההודעה', 'error');
                    resetSmartParser();
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showToast('שגיאה בניתוח', 'error');
                resetSmartParser();
            }
        }

        function displaySmartParserResults(data) {
            // Hide loading, show results
            document.getElementById('parserLoadingSection').style.display = 'none';
            document.getElementById('parserResultsSection').style.display = 'block';

            // Message type badge
            const typeIcons = {
                'NOMINATION': '🚢',
                'ETA_UPDATE': '📅',
                'ARRIVAL_NOTICE': '⚓',
                'BERTHING_NOTICE': '🏗️',
                'SAILING_NOTICE': '🌊',
                'SERVICE_REQUEST': '🔧',
                'DOCUMENTS': '📄',
                'DAILY_REPORT': '📊',
                'CARGO_INFO': '📦',
                'DISCHARGE_REPORT': '📋',
                'BULK_UPDATE': '📑',
                'OTHER': '❓'
            };

            const typeLabels = {
                'NOMINATION': 'מינוי חדש',
                'ETA_UPDATE': 'עדכון ETA',
                'ARRIVAL_NOTICE': 'הודעת הגעה',
                'BERTHING_NOTICE': 'הודעת עגינה',
                'SAILING_NOTICE': 'הודעת הפלגה',
                'SERVICE_REQUEST': 'בקשת שירות',
                'DOCUMENTS': 'מסמכים',
                'DAILY_REPORT': 'דוח יומי',
                'CARGO_INFO': 'מידע מטען',
                'DISCHARGE_REPORT': 'דוח פריקה',
                'BULK_UPDATE': 'עדכון מרובה',
                'OTHER': 'אחר'
            };

            const messageType = data.messageType || 'OTHER';
            const typeBadge = document.getElementById('parserTypeBadge');
            typeBadge.innerHTML = `
                <span class="type-icon">${typeIcons[messageType] || '📝'}</span>
                <span class="type-label">${typeLabels[messageType] || messageType}</span>
                <span class="type-confidence">${Math.round((data.messageTypeConfidence || 0.8) * 100)}%</span>
            `;

            // Determine suggested action
            const actionDesc = document.getElementById('parserActionDescription');
            let actionText = '';

            if (messageType === 'NOMINATION') {
                actionText = `פתיחת אנייה חדשה: ${data.vesselName || 'לא זוהה'}`;
            } else if (messageType === 'ETA_UPDATE' && data.dates?.eta?.iso) {
                actionText = `עדכון ETA ל-${formatDateTimeForDisplay(data.dates.eta.iso)}`;
            } else if (messageType === 'BERTHING_NOTICE' && data.dates?.etb?.iso) {
                actionText = `עדכון ETB ל-${formatDateTimeForDisplay(data.dates.etb.iso)}`;
            } else if (messageType === 'SAILING_NOTICE') {
                actionText = `עדכון סטטוס: הפליגה`;
            } else if (messageType === 'DISCHARGE_REPORT') {
                actionText = `עדכון נתוני פריקה`;
            } else if (messageType === 'BULK_UPDATE' && data.bulkVessels?.length > 0) {
                actionText = `עדכון ${data.bulkVessels.length} אניות`;
            } else {
                actionText = `עדכון פרטים עבור ${data.vesselName || 'אנייה לא מזוהה'}`;
            }
            actionDesc.textContent = actionText;

            // Ship match options
            const shipMatchOptions = document.getElementById('shipMatchOptions');
            let matchHtml = '';

            // Try to find matching ships
            const vesselName = data.vesselName || '';
            const matchingShips = ships.filter(s =>
                s.name.toLowerCase().includes(vesselName.toLowerCase()) ||
                vesselName.toLowerCase().includes(s.name.toLowerCase())
            );

            if (matchingShips.length > 0) {
                matchingShips.forEach((ship, idx) => {
                    matchHtml += `
                        <div class="ship-match-option ${idx === 0 ? 'selected' : ''}"
                             data-ship-id="${ship.id}" onclick="selectShipMatch(this)">
                            ${ship.name} (${ship.voyage})
                        </div>
                    `;
                });
            }

            // Add "new ship" option for nominations
            if (messageType === 'NOMINATION' || matchingShips.length === 0) {
                matchHtml += `
                    <div class="ship-match-option new-ship ${matchingShips.length === 0 ? 'selected' : ''}"
                         data-new-ship="true" onclick="selectShipMatch(this)">
                        + אנייה חדשה: ${vesselName || 'לא מזוהה'}
                    </div>
                `;
            }

            shipMatchOptions.innerHTML = matchHtml;

            // Extracted fields preview
            const fieldsContainer = document.getElementById('parserExtractedFields');
            let fieldsHtml = '';

            if (data.vesselName) {
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">שם אנייה</span>
                        <span class="parser-field-value">${data.vesselName}</span>
                    </div>
                `;
            }

            if (data.dates?.eta?.iso) {
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">ETA</span>
                        <span class="parser-field-value highlight">${formatDateTimeForDisplay(data.dates.eta.iso)}</span>
                    </div>
                `;
            }

            if (data.dates?.etb?.iso) {
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">ETB</span>
                        <span class="parser-field-value highlight">${formatDateTimeForDisplay(data.dates.etb.iso)}</span>
                    </div>
                `;
            }

            if (data.ports?.destination) {
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">נמל</span>
                        <span class="parser-field-value">${data.ports.destination}</span>
                    </div>
                `;
            }

            if (data.cargo?.types?.length > 0) {
                const cargoText = data.cargo.types.map(c => c.name).join(', ');
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">מטען</span>
                        <span class="parser-field-value">${cargoText}</span>
                    </div>
                `;
            }

            if (data.status?.current) {
                fieldsHtml += `
                    <div class="parser-field-row">
                        <span class="parser-field-label">סטטוס</span>
                        <span class="parser-field-value">${data.status.current}</span>
                    </div>
                `;
            }

            // Display vessel specifications (especially for NOMINATION emails)
            if (data.vessel) {
                const v = data.vessel;
                const vesselSpecs = [];

                if (v.loa) vesselSpecs.push(`LOA: ${v.loa}m`);
                if (v.beam) vesselSpecs.push(`Beam: ${v.beam}m`);
                if (v.dwt) vesselSpecs.push(`DWT: ${v.dwt.toLocaleString()} MT`);
                if (v.draft) vesselSpecs.push(`שוקע: ${v.draft}m`);
                if (v.gross) vesselSpecs.push(`GRT: ${v.gross.toLocaleString()}`);
                if (v.net) vesselSpecs.push(`NRT: ${v.net.toLocaleString()}`);
                if (v.yearBuilt) vesselSpecs.push(`שנת בניה: ${v.yearBuilt}`);
                if (v.placeBuilt) vesselSpecs.push(`מקום בניה: ${v.placeBuilt}`);
                if (v.class) vesselSpecs.push(`סיווג: ${v.class}`);
                if (v.holds) vesselSpecs.push(`מעמסות: ${v.holds}`);
                if (v.grainCapacity) vesselSpecs.push(`Grain: ${v.grainCapacity.toLocaleString()} CBM`);
                if (v.cranes) vesselSpecs.push(`מנופים: ${v.cranes}`);

                if (vesselSpecs.length > 0) {
                    fieldsHtml += `
                        <div class="parser-field-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <span class="parser-field-label" style="color: var(--primary); font-weight: 600;">מפרט אנייה</span>
                            <span class="parser-field-value" style="font-size: 11px; line-height: 1.6; word-break: break-word;">${vesselSpecs.join(' | ')}</span>
                        </div>
                    `;

                    // Show indication that vessel will be added/updated in reference database
                    fieldsHtml += `
                        <div class="parser-field-row" style="background: var(--primary-glow); border-radius: 6px; padding: 8px; margin-top: 8px;">
                            <span style="font-size: 11px; color: var(--primary);">
                                ✨ פרטי האנייה יישמרו אוטומטית במאגר הרפרנס
                            </span>
                        </div>
                    `;
                }
            }

            fieldsContainer.innerHTML = fieldsHtml || '<p style="color: var(--text-tertiary); text-align: center;">לא זוהו שדות נוספים</p>';
        }

        function selectShipMatch(element) {
            // Remove selection from all
            element.parentElement.querySelectorAll('.ship-match-option').forEach(el => {
                el.classList.remove('selected');
            });
            // Select this one
            element.classList.add('selected');
        }

        function formatDateTimeForDisplay(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('he-IL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString;
            }
        }

        async function applySmartParserAction() {
            if (!smartParserData) {
                showToast('אין נתונים להחלה', 'error');
                return;
            }

            const selectedShipEl = document.querySelector('.ship-match-option.selected');
            if (!selectedShipEl) {
                showToast('נא לבחור אנייה', 'warning');
                return;
            }

            const isNewShip = selectedShipEl.dataset.newShip === 'true';
            const shipId = selectedShipEl.dataset.shipId;

            try {
                if (isNewShip) {
                    // Create new ship
                    const newShip = createShipObject({
                        name: smartParserData.vesselName || '',
                        voyage: smartParserData.voyageNumber || '',
                        port: smartParserData.ports?.destination || '',
                        eta: smartParserData.dates?.eta?.iso || new Date().toISOString(),
                        expected_berth_time: smartParserData.dates?.etb?.iso || null,
                        cargo: smartParserData.cargo?.types?.map(c => c.name).join(', ') || '',
                        status: mapStatusFromParsed(smartParserData.status?.current) || STATUS.AT_SEA
                    });

                    ships.push(newShip);
                    await saveShipToFirestore(newShip);

                    // Add vessel to reference database if not exists
                    await addVesselToReferenceDatabase(smartParserData);

                    showToast(`אנייה ${newShip.name} נוספה בהצלחה!`, 'success');

                } else {
                    // Update existing ship
                    const ship = ships.find(s => s.id === shipId);
                    if (!ship) {
                        showToast('אנייה לא נמצאה', 'error');
                        return;
                    }

                    let updates = [];

                    // Apply ETA update
                    if (smartParserData.dates?.eta?.iso) {
                        ship.eta = smartParserData.dates.eta.iso;
                        updates.push('ETA');
                    }

                    // Apply ETB update
                    if (smartParserData.dates?.etb?.iso) {
                        ship.expected_berth_time = smartParserData.dates.etb.iso;
                        updates.push('ETB');
                    }

                    // Apply status update
                    if (smartParserData.status?.current) {
                        const newStatus = mapStatusFromParsed(smartParserData.status.current);
                        if (newStatus) {
                            ship.status = newStatus;
                            updates.push('סטטוס');
                        }
                    }

                    // Apply port update
                    if (smartParserData.ports?.destination && !ship.port) {
                        ship.port = smartParserData.ports.destination;
                        updates.push('נמל');
                    }

                    await saveShipToFirestore(ship);
                    showToast(`${ship.name}: עודכן ${updates.join(', ')}`, 'success');

                    // Prompt for email notification
                    if (updates.includes('ETA') || updates.includes('ETB') || updates.includes('סטטוס')) {
                        setTimeout(() => {
                            if (confirm('האם לשלוח עדכון למעורבים?')) {
                                promptEmailNotification(ship, updates[0].toLowerCase(), {});
                            }
                        }, 500);
                    }
                }

                renderShips();
                closeSmartParser();

            } catch (error) {
                console.error('Apply error:', error);
                showToast('שגיאה בעדכון', 'error');
            }
        }

        function mapStatusFromParsed(parsedStatus) {
            if (!parsedStatus) return null;
            const statusMap = {
                'NOMINATED': STATUS.AT_SEA,
                'LOADING': STATUS.AT_SEA,
                'EN_ROUTE': STATUS.AT_SEA,
                'AT_ANCHOR': STATUS.AT_PORT,
                'BERTHED': STATUS.AT_PORT,
                'WORKING': STATUS.UNDER_OPERATION,
                'SAILED': STATUS.SAILED
            };
            return statusMap[parsedStatus] || null;
        }

        function resetSmartParser() {
            // Reset to input state
            document.getElementById('parserInputSection').style.display = 'block';
            document.getElementById('parserLoadingSection').style.display = 'none';
            document.getElementById('parserResultsSection').style.display = 'none';

            // Clear input
            const input = document.getElementById('smartParserInput');
            input.value = '';
            input.style.height = 'auto';
            delete input.dataset.imageBase64;
            delete input.dataset.mimeType;

            // Clear data
            smartParserData = null;
        }

        // ==================== Initialize App ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>